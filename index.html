<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allocation Distribution System - Ministry of Health</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --primary: #1a73e8;
            --primary-light: #4285f4;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --secondary-light: #5cb85c;
            --danger: #ea4335;
            --warning: #f9ab00;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #202124;
            --gray: #5f6368;
            --gray-light: #e9ecef;
            --border: #dadce0;
            --success: #28a745;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --transition: all 0.3s ease;
        }
        
        /* ========== RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            padding: 0 20px;
            margin: 0 auto;
        }
        
        /* ========== ALLOCATION HISTORY STYLES ========== */
        .allocation-history {
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .history-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .history-filter .form-control {
            flex: 1;
            min-width: 200px;
        }
        
        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .history-summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            padding: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .history-summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .history-summary-card .label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 600;
        }
        
        /* ========== VOTE DISTRIBUTION STYLES ========== */
        .vote-distribution {
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .vote-distribution-chart {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }
        
        .vote-distribution-table {
            margin-top: 20px;
        }
        
        .vote-distribution-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
        
        /* ========== SIGNATURE VARIATIONS ========== */
        .signature-ddgonly,
        .signature-directoronly {
            display: none;
        }
        
        .signature-ddgonly .signature-line,
        .signature-directoronly .signature-line {
            margin: 20px 0 8px;
            height: 1px;
            background: var(--dark);
        }
        
        .signature-ddgonly .signature-label,
        .signature-directoronly .signature-label {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .signature-ddgonly .signature-name,
        .signature-directoronly .signature-name {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .signature-ddgonly .signature-title,
        .signature-directoronly .signature-title {
            font-size: 13px;
            color: var(--gray);
        }
        
        /* ========== TYPOGRAPHY ========== */
        h1, h2, h3, h4, h5, h6 {
            margin-bottom: 0.5rem;
            font-weight: 600;
            line-height: 1.2;
        }
        
        h1 { font-size: 2rem; }
        h2 { font-size: 1.75rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.25rem; }
        h5 { font-size: 1.1rem; }
        h6 { font-size: 1rem; }
        
        /* ========== NEW LOGIN SCREEN ========== */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.05)"/></svg>');
            background-size: cover;
        }
        
        .login-card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 40px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 15px;
        }
        
        /* ========== FORM STYLES ========== */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: var(--transition);
            background-color: #f8f9fa;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            background-color: white;
        }
        
        .form-control.readonly {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        
        .role-selector {
            display: flex;
            margin-bottom: 25px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--border);
            background: #f8f9fa;
        }
        
        .role-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
        }
        
        .role-option.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .form-text {
            color: var(--gray);
            font-size: 13px;
            margin-top: 5px;
            display: block;
        }
        
        /* ========== BUTTON STYLES ========== */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            box-shadow: var(--shadow);
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d8c47 100%);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(52, 168, 83, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #d33426 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(234, 67, 53, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68a00 100%);
        }
        
        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(249, 171, 0, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #138496 100%);
        }
        
        .btn-info:hover {
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: var(--transition);
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-right: 6px;
            transition: var(--transition);
        }
        
        /* ========== DASHBOARD STYLES ========== */
        .dashboard {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            box-shadow: var(--shadow);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 18px;
            color: white;
        }
        
        .logo-icon {
            margin-right: 10px;
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-name {
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
        
        .main-content {
            padding: 25px 0;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--dark);
            text-align: center;
        }
        
        /* ========== ALLOCATION FORM STYLES ========== */
        .allocation-form {
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1 0 100%;
            padding: 0 10px;
            margin-bottom: 18px;
        }
        
        /* ========== TAB STYLES ========== */
        .admin-tabs, .user-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .admin-tab, .user-tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            color: var(--gray);
            position: relative;
            font-size: 15px;
        }
        
        .admin-tab.active, .user-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(26, 115, 232, 0.05);
        }
        
        .admin-tab-content, .user-tab-content {
            display: block;
        }
        
        /* ========== NOTIFICATION BADGE ========== */
        .notification-badge {
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 6px;
            right: 6px;
        }
        
        /* ========== TABLE STYLES ========== */
        .requests-table, .data-table-container {
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-header, .data-table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .table-title, .data-table-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .table-container, .table-scroll-container {
            overflow-x: auto;
            max-height: 500px;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: var(--gray);
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .highlighted-row {
            background-color: rgba(26, 115, 232, 0.08) !important;
            border-left: 3px solid var(--primary);
        }
        
        /* ========== STATUS BADGES ========== */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff8e1;
            color: var(--warning);
            border: 1px solid #ffecb3;
        }
        
        .status-approved {
            background-color: #e8f5e9;
            color: var(--secondary);
            border: 1px solid #c8e6c9;
        }
        
        .status-rejected {
            background-color: #ffebee;
            color: var(--danger);
            border: 1px solid #ffcdd2;
        }
        
        .status-completed {
            background-color: #e3f2fd;
            color: var(--primary);
            border: 1px solid #bbdefb;
        }
        
        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .stat-value {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 600;
        }
        
        /* ========== ENHANCED PDF STYLES ========== */
        .enhanced-pdf {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            background-color: white;
            box-shadow: var(--shadow);
        }
        
        .enhanced-pdf-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary);
        }
        
        .enhanced-pdf-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .enhanced-pdf-subtitle {
            font-size: 16px;
            color: var(--gray);
            font-weight: 500;
        }
        
        .enhanced-pdf-section {
            margin-bottom: 20px;
            padding: 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 3px solid var(--primary);
        }
        
        .enhanced-pdf-label {
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .enhanced-pdf-value {
            margin-bottom: 10px;
            color: var(--gray);
            font-size: 14px;
        }
        
        .enhanced-pdf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* ========== SUCCESS MESSAGE ========== */
        .success-message {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .success-message h2 {
            color: var(--secondary);
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .success-message p {
            color: var(--dark);
            font-size: 15px;
        }
        
        .password-notice {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 18px;
            margin: 18px 0;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .password-value {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px dashed var(--primary);
            display: inline-block;
            margin: 8px 0;
        }
        
        /* ========== ADMIN CONTROLS ========== */
        .admin-controls, .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .filter-control, .report-control {
            flex: 1;
            min-width: 220px;
        }
        
        .search-control {
            position: relative;
        }
        
        .search-control .form-control, .search-container .form-control {
            padding-left: 36px;
        }
        
        .search-control i, .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 12px;
            padding: 16px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background-color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 14px;
        }
        
        .pagination button:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            margin: 0 16px;
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }
        
        /* ========== SIGNATURE SECTION ========== */
        .signature-section {
            margin-top: 30px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .signature-line {
            height: 1px;
            background: var(--dark);
            margin: 20px 0 8px;
        }
        
        .signature-label {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .signature-name {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .signature-title {
            font-size: 13px;
            color: var(--gray);
        }
        
        .hospital-signature-section {
            margin-top: 20px;
            padding-top: 10px;
        }
        
        /* ========== STATUS CARDS FOR ADMIN ========== */
        .status-card {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .status-card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .status-card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .status-card-count {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            color: white;
        }
        
        .status-card-pending {
            background-color: var(--warning);
        }
        
        .status-card-approved {
            background-color: var(--secondary);
        }
        
        .status-card-rejected {
            background-color: var(--danger);
        }
        
        .status-card-completed {
            background-color: var(--primary);
        }
        
        .selection-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .selection-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .selection-item:hover {
            background-color: #f8f9fa;
        }
        
        /* ========== HOSPITAL SUMMARY STYLES ========== */
        .hospital-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .hospital-summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }
        
        .hospital-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .hospital-summary-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .hospital-summary-count {
            background-color: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .hospital-summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .hospital-stat-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .hospital-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2px;
        }
        
        .hospital-stat-label {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* ========== UTILITY CLASSES ========== */
        .text-center {
            text-align: center;
        }
        
        .text-left {
            text-align: left;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .ml-10 { margin-left: 10px; }
        .mr-10 { margin-right: 10px; }
        
        .hidden {
            display: none;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .align-items-center {
            align-items: center;
        }
        
        .w-100 {
            width: 100%;
        }
        
        /* ========== LOADING SPINNER ========== */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* ========== FIXED BUTTON STYLES ========== */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .button-group .btn {
            flex: 1;
            min-width: 180px;
            max-width: 250px;
            margin: 0;
        }

        .button-group .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d8c47 100%);
            flex: 1;
            min-width: 180px;
            max-width: 250px;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (min-width: 576px) {
            .form-col {
                flex: 1 0 50%;
            }
        }
        
        @media (min-width: 992px) {
            .form-col {
                flex: 1 0 33.333%;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 0 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .hospital-summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .login-card {
                padding: 25px;
            }
            
            .allocation-form {
                padding: 20px;
            }
            
            .table-header, .data-table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .admin-controls, .report-controls {
                flex-direction: column;
            }
            
            .filter-control, .report-control {
                width: 100%;
            }
            
            .admin-tabs, .user-tabs {
                flex-wrap: wrap;
            }
            
            .admin-tab, .user-tab {
                flex: 1;
                min-width: 110px;
                text-align: center;
                padding: 14px 16px;
            }
            
            .enhanced-pdf-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 8px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .data-table-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .form-col {
                flex: 1 0 100%;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 12px;
            }
            
            .button-group .btn,
            .button-group .btn-secondary {
                min-width: 100%;
                max-width: 100%;
                width: 100%;
            }
            
            .hospital-summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .pagination {
                flex-wrap: wrap;
            }
            
            .admin-tab, .user-tab {
                flex: 1 0 100%;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .modal-footer {
                padding: 12px;
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .button-group {
                gap: 8px;
                padding: 10px;
            }
            
            .button-group .btn {
                padding: 10px 14px;
                font-size: 14px;
            }
        }

        /* Additional Notes highlight in approval modal */
        .additional-notes-highlight {
            background-color: #fff5f5;
            border: 2px solid #ea4335;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(234, 67, 53, 0.2);
        }

        .additional-notes-highlight .notes-label {
            color: #ea4335;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        .additional-notes-highlight .notes-content {
            color: #333;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .additional-notes-highlight .notes-empty {
            color: #999;
            font-style: italic;
        }

        /* Rejection Reason Highlight */
        .rejection-reason-highlight {
            background-color: #fff5f5;
            border: 2px solid #ea4335;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(234, 67, 53, 0.2);
        }

        .rejection-reason-highlight .reason-label {
            color: #ea4335;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        .rejection-reason-highlight .reason-content {
            color: #333;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .rejection-reason-highlight .reason-empty {
            color: #999;
            font-style: italic;
        }

        /* Approve Again Button */
        .btn-approve-again {
            background: linear-gradient(135deg, var(--success) 0%, #218838 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-approve-again:hover {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        /* Resubmit Request Section */
        .resubmit-request-section {
            background-color: #e8f5e9;
            border: 2px solid var(--success);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(52, 168, 83, 0.2);
        }

        .resubmit-request-section .section-title {
            color: var(--success);
            border-bottom-color: var(--success);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">üè•</div>
            <h1 class="login-title">Allocation Distribution System</h1>
            <p class="login-subtitle">Ministry of Health</p>
            
            <div class="role-selector">
                <div class="role-option active" data-role="hospital">Hospital User</div>
                <div class="role-option" data-role="admin">Admin User</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="hospitalSelect">Select Hospital/User</label>
                <select id="hospitalSelect" class="form-control">
                    <option value="">Select Hospital/User</option>
                    <option value="admin">Administrator</option>
                    <option value="Ministry of Health">Ministry of Health</option>
                    <option value="National Hospital Sri Lanka">National Hospital Sri Lanka</option>
                    <option value="Colombo South Teaching Hospital">Colombo South Teaching Hospital</option>
                    <option value="Lady Ridgeway Hospital">Lady Ridgeway Hospital</option>
                    <option value="Apeksha Hospital Maharagama">Apeksha Hospital Maharagama</option>
                    <option value="Colombo East Base Hospital Mulleriyawa">Colombo East Base Hospital Mulleriyawa</option>
                    <option value="Infections Diseases Hospital">Infections Diseases Hospital</option>
                    <option value="NIMH">NIMH</option>
                    <option value="De Soysa Hospital">De Soysa Hospital</option>
                    <option value="Castle Street Hospital for Women">Castle Street Hospital for Women</option>
                    <option value="National Eye Hospital">National Eye Hospital</option>
                    <option value="Institute of Oral Health-Maharagama">Institute of Oral Health-Maharagama</option>
                    <option value="National Blood Transfusion Service">National Blood Transfusion Service</option>
                    <option value="National Institute for Nephrology Dialysis and Transplantation - Maligawatta">National Institute for Nephrology Dialysis and Transplantation - Maligawatta</option>
                    <option value="Medical Research Institute">Medical Research Institute</option>
                    <option value="National Dental Hospital">National Dental Hospital</option>
                    <option value="Colombo North Teaching Hospital - Ragama">Colombo North Teaching Hospital - Ragama</option>
                    <option value="Rheumatology & Rehabilitation Hospital, Ragama">Rheumatology & Rehabilitation Hospital, Ragama</option>
                    <option value="District Hospital Kandana">District Hospital Kandana</option>
                    <option value="National Hospital for Respiratory Diseases, Welisara">National Hospital for Respiratory Diseases, Welisara</option>
                    <option value="Leprosy Hospital - Handala">Leprosy Hospital - Handala</option>
                    <option value="DGH Negombo (District General Hospital)">DGH Negombo (District General Hospital)</option>
                    <option value="Teaching Hospital Kalutara">Teaching Hospital Kalutara</option>
                    <option value="National Institute of Health Sciences Kalutara">National Institute of Health Sciences Kalutara</option>
                    <option value="National Hospital - Kandy">National Hospital - Kandy</option>
                    <option value="Base Hospital Gampola">Base Hospital Gampola </option>
                    <option value="Teaching Hospital Peradeniya">Teaching Hospital Peradeniya</option>
                    <option value="Sirimavo Bandaranayake Hospital - Peradeniya">Sirimavo Bandaranayake Hospital - Peradeniya</option>
                    <option value="District General Hospital Nawalapitiya">District General Hospital Nawalapitiya</option>
                    <option value="District General Hospital NuwaraEliya">District General Hospital NuwaraEliya</option>
                    <option value="District General Hospital Matale">District General Hospital Matale</option>
                    <option value="National Hospital - Galle (Karapitiya)">National Hospital - Galle (Karapitiya)</option>
                    <option value="German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)">German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)</option>
                    <option value="District General Hospital Matara">District General Hospital Matara</option>
                    <option value="District General Hospital Hambantota">District General Hospital Hambantota</option>
                    <option value="TH Jaffna">TH Jaffna</option>
                    <option value="Base Hospital Akkaraipattu">Base Hospital Akkaraipattu</option>
                    <option value="Ashroff Hospital - Kalmunai">Ashroff Hospital - Kalmunai</option>
                    <option value="Base Hospital Kalmunai North">Base Hospital Kalmunai North</option>
                    <option value="District General Hospital Ampara">District General Hospital Ampara</option>
                    <option value="Base Hospital Pottuvil">Base Hospital Pottuvil</option>
                    <option value="District General Hospital Trincomalee">District General Hospital Trincomalee</option>
                    <option value="District General Hospital Kantale">District General Hospital Kantale</option>
                    <option value="Teaching Hospital Batticaloa">Teaching Hospital Batticaloa</option>
                    <option value="District General Hospital Chilaw">District General Hospital Chilaw</option>
                    <option value="Teaching Hospital Kurunegala">Teaching Hospital Kurunegala</option>
                    <option value="Teaching Hospital Kuliyapitiya">Teaching Hospital Kuliyapitiya</option>
                    <option value="District General Hospital Polonnaruwa">District General Hospital Polonnaruwa</option>
                    <option value="China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)">China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)</option>
                    <option value="TH Anuradhapura">TH Anuradhapura</option>
                   <option value="TH Badulla">TH Badulla</option>
                    <option value="District General Hospital Monaragala">District General Hospital Monaragala </option>
                    <option value="District General Hospital Kegalle">District General Hospital Kegalle</option>
                    <option value="Teaching Hospital Ratnapura">Teaching Hospital Ratnapura</option>
                    <option value="District General Hospital Embilipitiya">District General Hospital Embilipitiya</option>
                    <option value="National STD/AIDS Control Programme">National STD/AIDS Control Programme</option>
                    <option value="Biomedical Engineering Services">Biomedical Engineering Services</option>
                    <option value="Epidemiology Unit">Epidemiology Unit</option>
                    <option value="National Cancer Control Programme">National Cancer Control Programme</option>
                    <option value="National Programme for Tuberculosis Control & Chest Diseases">National Programme for Tuberculosis Control & Chest Diseases</option>
                    <option value="Institute for Forensic Medicine & Toxicology">Institute for Forensic Medicine & Toxicology</option>
                    <option value="Health Promotion Bureau">Health Promotion Bureau</option>
                    <option value="Dengue Control Programme">Dengue Control Programme</option>
                    <option value="Anti Malaria Campaign">Anti Malaria Campaign</option>
                    <option value="Family Health Bureau">Family Health Bureau</option>
                    <option value="Anti Filariasis Campaign">Anti Filariasis Campaign</option>
                    <option value="Medical Supplies Division">Medical Supplies Division</option>
                    <option value="Public Health Veterinary Services">Public Health Veterinary Services</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
                <small class="form-text">For System Inquiries 011 2 692 382</small>
            </div>
            
            <button id="loginBtn" class="btn btn-block">Login to System</button>
            <div id="loginSpinner" class="spinner mt-20 hidden"></div>
            <div id="loginMessage" class="mt-20 hidden"></div>
        </div>
    </div>
    
    <!-- Hospital User Dashboard -->
    <div id="hospitalDashboard" class="dashboard hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">üè•</span>
                        <span>ADS - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="hospitalDisplayName">Hospital User</span>
                        <button id="hospitalLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Allocation Distribution System</h1>
                
                <div class="user-tabs">
                    <div class="user-tab active" data-tab="allocation">Allocation Request</div>
                    <div class="user-tab" data-tab="myRequests">My Requests</div>
                    <div class="user-tab" data-tab="allocations">Allocation Status</div>
                    <div class="user-tab" data-tab="history">Allocation History</div>
                    <div class="user-tab" data-tab="voteDistribution">Vote Distribution</div>
                </div>
                
                <!-- Allocation Request Tab -->
                <div id="allocationTab" class="user-tab-content">
                    <div class="allocation-form" id="allocationForm">
                        <div class="form-section">
                            <h2 class="section-title">Hospital Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="hospitalName">Hospital Name *</label>
                                        <input type="text" id="hospitalName" class="form-control readonly" placeholder="Hospital name will be auto-filled" readonly required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactPerson">Contact Person *</label>
                                        <input type="text" id="contactPerson" class="form-control" placeholder="Enter contact person name" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactPhone">Contact Phone *</label>
                                        <input type="tel" id="contactPhone" class="form-control" placeholder="Enter contact phone number" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactEmail">Contact Email</label>
                                        <input type="email" id="contactEmail" class="form-control" placeholder="Enter contact email">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h2 class="section-title">Allocation Details</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="voteNumber">Vote Number *</label>
                                        <select id="voteNumber" class="form-control" required>
                                            <option value="">-- Select Vote Number --</option>
                                            <option value="111-1-5-2001(11) Building Rehabilitation-Hospital">111-1-5-2001(11) Building Rehabilitation-Hospital</option>
                                            <option value="111-1-5-2002(11) Service and Maintenance-Hospital">111-1-5-2002(11) Service and Maintenance-Hospital</option>
                                            <option value="111-1-5-2103(11) Machinery Purchasing-Hospitals">111-1-5-2103(11) Machinery Purchasing-Hospitals</option>
                                            <option value="111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions">111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions</option>
                                            <option value="111-2-26-2001(11) Building Rehabilitation-Other Health Institutions">111-2-26-2001(11) Building Rehabilitation-Other Health Institutions</option>
                                            <option value="111-2-26-2002(11) Service and Maintenance-Other Health Institutions">111-2-26-2002(11) Service and Maintenance-Other Health Institutions</option>
                                            
                                            <option value="111-2-20-001-2001(11) Building Rehabilitation-NTS">111-2-20-001-2001(11) Building Rehabilitation-NTS</option>
                                            <option value="111-2-20-001-2002(11) Service and Maintenance-NTS">111-2-20-001-2002(11) Service and Maintenance-NTS</option>
                                            <option value="111-2-20-001-2103(11) Machinery Purchasing-NTS">111-2-20-001-2103(11) Machinery Purchasing-NTS</option>
                                            <option value="111-2-26-008-2001(11) Strengthening Primary Level Health Care">111-2-26-008-2001(11) Strengthening Primary Level Health Care</option>
                                            <option value="111-1-2-2001(11) Building and Structures- Ministry Administration">111-1-2-2001(11) Building and Structures- Ministry Administration</option>
                                            <option value="111-1-1-2001(11) Building and Structures- Minister Office">111-1-1-2001(11) Building and Structures- Minister Office</option>
                                            <option value="111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office">111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office</option>
                                            <option value="111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration">111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration</option>
                                            <option value="111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration">111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration</option>
                                           
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobDescription">Job Description *</label>
                                        <textarea id="jobDescription" class="form-control" rows="3" placeholder="Describe the job/work required" required></textarea>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="requiredAmount">Required Amount (LKR) *</label>
                                        <input type="number" id="requiredAmount" class="form-control" placeholder="Enter required amount in LKR" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="priorityLevel">Priority Level *</label>
                                        <select id="priorityLevel" class="form-control" required>
                                            <option value="">Select priority level</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="requiredDate">Record Entry Date *</label>
                                        <input type="date" id="requiredDate" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="additionalNotes">Additional Notes</label>
                                        <textarea id="additionalNotes" class="form-control" rows="3" placeholder="Add any additional notes or comments"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="submitAllocation" class="btn btn-block">Submit Allocation Request</button>
                        <div id="submitSpinner" class="spinner mt-20 hidden"></div>
                    </div>
                    
                    <div id="allocationSuccess" class="hidden">
                        <div class="success-message">
                            <h2>Allocation Request Submitted Successfully!</h2>
                            <p>Your allocation request has been submitted and is pending approval.</p>
                            <div class="password-notice">
                                <h3>Your Request Password: <span id="uniquePasswordDisplay" class="password-value"></span></h3>
                                <p><strong>Important:</strong> Save this password. You'll need it for any updates or inquiries about this request.</p>
                            </div>
                        </div>
                        
                        <div class="enhanced-pdf" id="enhancedPdfPreview">
                            <div class="enhanced-pdf-header">
                                <div class="enhanced-pdf-title">Ministry of Health</div>
                                <div class="enhanced-pdf-subtitle">Allocation Request Confirmation</div>
                            </div>
                            <div class="enhanced-pdf-grid">
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Request Reference:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfRefNumber">ADS-2023-001</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Unique Password:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfPassword">XXXXXX</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Submission Date:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfDate">01/01/2023</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Hospital Details:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfHospitalDetails">Hospital Name, Contact Person, Phone</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Vote Number:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfVoteNumber">Vote Number</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Job Description:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfJobDescription">Job Description</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Required Amount:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfAmount">0 LKR</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Priority Level:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfPriority">Low</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Required Date:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfRequiredDate">01/01/2023</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Additional Notes:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfAdditionalNotes">No additional notes</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Status:</div>
                                    <div class="enhanced-pdf-value">Pending Approval</div>
                                </div>
                            </div>
                            
                            <!-- Add Important Instructions Section -->
                            <div class="enhanced-pdf-section" style="grid-column: 1 / -1;">
                                <div class="enhanced-pdf-label">Important Instructions:</div>
                                <div class="enhanced-pdf-value">
                                    <p><strong>3. The following instructions should be followed when incurring these expenses:</strong></p>
                                    <p>I. Action should be taken in accordance with the Government Financial Regulations (GFR), Establishment Code, GFR 135 on Delegation of Authority, other laws and regulations, and the relevant instructions of Budget Circular No. 01/2025 dated 22.03.2025, which authorizes expenditure for the year 2025 and pertains to public expenditure management.</p>
                                    <p>II. The relevant work subjects should be executed upon approval by your Hospital's Regional Procurement Committee, in accordance with this Ministry Circular and instructions.</p>
                                    <p>III. In order to prevent the Government as well as the contractors/service providers from facing difficulties due to the accumulation of unsettled liabilities, it is important to confirm the availability of cash flow before entering into commitments, even if the provision has been allocated.</p>
                                    <p>IV. Starting work without provisions should especially be avoided, and expenses exceeding the limit of the allocated provisions should not be incurred.</p>
                                    <p>V. The provisions granted through this letter will expire on 31.12.2026.</p>
                                    <p><strong>4. Monthly expenditure reports</strong>, stating the work subjects for which the provisions were expended, must be submitted by the Accountant of the Hospitals/Institutions to the email address ddglogisticsmoh@gmail.com. The Institutional Section must also complete the physical and financial progress for every month according to the provided format. Kindly note that both these reports must be submitted before the 10th day of the following month.</p>
                                </div>
                            </div>
                            
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="signature-label">Approval Signature:</div>
                                        <div class="signature-name">H.M.N Dinipriya Herath</div>
                                        <div class="signature-title">Deputy Director General (Logistics)</div>
                                        <div class="signature-title">For Secretary</div>
                                    </div>
                                    <div>
                                        <div class="signature-label">Approval Signature:</div>
                                        <div class="signature-name">Director Building Branch</div>
                                        <div class="signature-title">Director Building Branch (Administration)</div>
                                    </div>
                                </div>
                                <div class="mt-20">
                                    <div class="signature-label">Copies:</div>
                                    <div class="signature-title">1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)</div>
                                    <div class="signature-title">2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)</div>
                                </div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button id="downloadPdf" class="btn">Download Confirmation</button>
                            <button id="newAllocation" class="btn btn-secondary">Make Another Request</button>
                        </div>
                    </div>
                </div>
                
                <!-- My Requests Tab -->
                <div id="myRequestsTab" class="user-tab-content hidden">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="myRequestsStatusFilter">Filter by Status</label>
                            <select id="myRequestsStatusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchMyRequests">Search My Requests</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchMyRequests" class="form-control" placeholder="Search by reference or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">My Allocation Requests</div>
                            <div id="myRequestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="myRequestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="myRequestsPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="myRequestsPageInfo">Page 1 of 1</span>
                            <button id="myRequestsNextPage" disabled>Next</button>
                        </div>
                        
                        <div id="myRequestsSpinner" class="spinner mt-20 mb-20 hidden"></div>
                    </div>
                </div>
                
                <!-- Allocation Status Tab -->
                <div id="allocationsTab" class="user-tab-content hidden">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="stat-value" id="userTotalAllocations">0</div>
                            <div class="stat-label">Total Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-value" id="userApprovedCount">0</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-value" id="userPendingCount">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                            <div class="stat-value" id="userRejectedCount">0</div>
                            <div class="stat-label">Rejected</div>
                        </div>
                    </div>
                    
                    <div class="user-allocation-status">
                        <h2 class="section-title">Allocation Status Overview</h2>
                        <p>Current status of all your allocation requests.</p>
                        
                        <div class="data-table-controls mb-20">
                            <div class="search-control">
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchUserAllocations" class="form-control" placeholder="Search allocations...">
                                </div>
                            </div>
                            <div class="pagination-info" id="userAllocationPageInfo">Page 1 of 1</div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table class="user-allocation-table">
                                <thead>
                                    <tr>
                                        <th>Ref No</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="userAllocationsList">
                                    <!-- Allocations will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="userAllocationPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="userAllocationPaginationInfo">Page 1 of 1</span>
                            <button id="userAllocationNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!-- Allocation History Tab -->
                <div id="historyTab" class="user-tab-content hidden">
                    <div class="allocation-history">
                        <h2 class="section-title">Allocation History</h2>
                        
                        <div class="history-filter">
                            <div class="form-group">
                                <label class="form-label" for="historyYearFilter">Year</label>
                                <select id="historyYearFilter" class="form-control">
                                    <option value="all">All Years</option>
				    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="historyVoteFilter">Vote Number</label>
                                <select id="historyVoteFilter" class="form-control">
                                    <option value="all">All Votes</option>
                                    <!-- Vote options will be populated dynamically -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="historyStatusFilter">Status</label>
                                <select id="historyStatusFilter" class="form-control">
                                    <option value="all">All Status</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="history-summary">
                            <div class="history-summary-card">
                                <div class="value" id="totalHistoricalRequests">0</div>
                                <div class="label">Total Requests</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="totalHistoricalAmount">LKR 0</div>
                                <div class="label">Total Amount</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="avgApprovalTime">0 days</div>
                                <div class="label">Avg. Approval Time</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="successRate">0%</div>
                                <div class="label">Approval Rate</div>
                            </div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Requested Amount</th>
                                        <th>Approved Amount</th>
                                        <th>Status</th>
                                        <th>Submitted Date</th>
                                        <th>Approved Date</th>
                                        <th>Approved By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- History data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="historyPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="historyPageInfo">Page 1 of 1</span>
                            <button id="historyNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!-- Vote Distribution Tab -->
                <div id="voteDistributionTab" class="user-tab-content hidden">
                    <div class="vote-distribution">
                        <h2 class="section-title">Vote-wise Allocation Distribution</h2>
                        
                        <div class="form-group">
                            <label class="form-label" for="distributionYearFilter">Select Year</label>
                            <select id="distributionYearFilter" class="form-control">
				<option value="2026">2026</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        
                        <div class="vote-distribution-chart">
                            <canvas id="voteDistributionChart"></canvas>
                        </div>
                        
                        <div class="vote-distribution-table">
                            <div class="table-scroll-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Vote Number</th>
                                            <th>Total Requests</th>
                                            <th>Approved Requests</th>
                                            <th>Total Requested</th>
                                            <th>Total Approved</th>
                                            <th>Approval Rate</th>
                                            <th>Avg. Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="voteDistributionTableBody">
                                        <!-- Vote distribution data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="button-group mt-20">
                            <button id="exportVoteDistribution" class="btn">Export to Excel</button>
                            <button id="printVoteDistribution" class="btn btn-secondary">Print Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">üè•</span>
                        <span>ADS Admin - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="adminDisplayName">Administrator</span>
                        <button id="adminLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Allocation Requests Management</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-list-alt"></i></div>
                        <div class="stat-value" id="totalAllocations">0</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="pendingAllocations">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="approvedAllocations">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-value" id="totalAllocatedAmount">0</div>
                        <div class="stat-label">Total Allocated (LKR)</div>
                    </div>
                </div>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" data-tab="requests">
                        Allocation Requests
                        <span id="pendingAllocationBadge" class="notification-badge hidden">0</span>
                    </div>
                    <div class="admin-tab" data-tab="allocations">Allocation Status</div>
                    <div class="admin-tab" data-tab="allocationHistory">Allocation History</div>
                    <div class="admin-tab" data-tab="voteDistribution">Vote Distribution</div>
                    <div class="admin-tab" data-tab="hospitalSummary">Hospital Summary</div>
                    <div class="admin-tab" data-tab="reports">Reports</div>
                    <div class="admin-tab" data-tab="logs">System Logs</div>
                </div>
                
                <!-- Allocation Requests Tab -->
                <div id="requestsTab" class="admin-tab-content">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="statusFilter">Filter by Status</label>
                            <select id="statusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchAllocations">Search Allocations</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchAllocations" class="form-control" placeholder="Search by reference, hospital, or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">Allocation Requests</div>
                            <div id="requestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Hospital</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="prevPage" disabled>Previous</button>
                            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                            <button id="nextPage" disabled>Next</button>
                        </div>
                        
                        <div id="adminSpinner" class="spinner mt-20 mb-20 hidden"></div>
                    </div>
                </div>
                
                <!-- Allocation Status Tab -->
                <div id="allocationsTab" class="admin-tab-content hidden">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="statusFilterAllocations">Filter by Status</label>
                            <select id="statusFilterAllocations" class="form-control">
                                <option value="all">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchAllocationsStatus">Search Allocations</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchAllocationsStatus" class="form-control" placeholder="Search by hospital or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="allocation-status-cards">
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Pending Allocations</div>
                                <div class="status-card-count status-card-pending" id="pendingAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="pendingAllocationsList">
                                <!-- Pending allocations will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Approved Allocations</div>
                                <div class="status-card-count status-card-approved" id="approvedAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="approvedAllocationsList">
                                <!-- Approved allocations will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Rejected Allocations</div>
                                <div class="status-card-count status-card-rejected" id="rejectedAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="rejectedAllocationsList">
                                <!-- Rejected allocations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Allocation History Tab -->
                <div id="allocationHistoryTab" class="admin-tab-content hidden">
                    <div class="allocation-history">
                        <h2 class="section-title">Allocation History</h2>
                        
                        <div class="history-filter">
                            <div class="form-group">
                                <label class="form-label" for="adminHistoryYearFilter">Year</label>
                                <select id="adminHistoryYearFilter" class="form-control">
                                    <option value="all">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="adminHistoryHospitalFilter">Hospital</label>
                                <select id="adminHistoryHospitalFilter" class="form-control">
                                    <option value="all">All Hospitals</option>
                                    <!-- Hospital options will be populated dynamically -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="adminHistoryStatusFilter">Status</label>
                                <select id="adminHistoryStatusFilter" class="form-control">
                                    <option value="all">All Status</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="history-summary">
                            <div class="history-summary-card">
                                <div class="value" id="adminTotalHistoricalRequests">0</div>
                                <div class="label">Total Requests</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="adminTotalHistoricalAmount">LKR 0</div>
                                <div class="label">Total Amount</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="adminAvgApprovalTime">0 days</div>
                                <div class="label">Avg. Approval Time</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="adminSuccessRate">0%</div>
                                <div class="label">Approval Rate</div>
                            </div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Hospital</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Requested Amount</th>
                                        <th>Approved Amount</th>
                                        <th>Status</th>
                                        <th>Submitted Date</th>
                                        <th>Approved Date</th>
                                        <th>Approved By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminHistoryTableBody">
                                    <!-- History data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="adminHistoryPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="adminHistoryPageInfo">Page 1 of 1</span>
                            <button id="adminHistoryNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!-- Vote Distribution Tab -->
                <div id="voteDistributionTab" class="admin-tab-content hidden">
                    <div class="vote-distribution">
                        <h2 class="section-title">Vote-wise Allocation Distribution</h2>
                        
                        <div class="form-group">
                            <label class="form-label" for="adminDistributionYearFilter">Select Year</label>
                            <select id="adminDistributionYearFilter" class="form-control">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        
                        <div class="vote-distribution-chart">
                            <canvas id="adminVoteDistributionChart"></canvas>
                        </div>
                        
                        <div class="vote-distribution-table">
                            <div class="table-scroll-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Vote Number</th>
                                            <th>Total Requests</th>
                                            <th>Approved Requests</th>
                                            <th>Total Requested</th>
                                            <th>Total Approved</th>
                                            <th>Approval Rate</th>
                                            <th>Avg. Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminVoteDistributionTableBody">
                                        <!-- Vote distribution data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="button-group mt-20">
                            <button id="exportAdminVoteDistribution" class="btn">Export to Excel</button>
                            <button id="printAdminVoteDistribution" class="btn btn-secondary">Print Report</button>
                        </div>
                    </div>
                </div>

                <!-- Hospital Summary Tab -->
                <div id="hospitalSummaryTab" class="admin-tab-content hidden">
                    <div class="allocation-history">
                        <h2 class="section-title">Hospital-wise Allocation Summary</h2>
                        
                        <div class="history-filter">
                            <div class="form-group">
                                <label class="form-label" for="hospitalSummaryYearFilter">Year</label>
                                <select id="hospitalSummaryYearFilter" class="form-control">
                                    <option value="all">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="hospitalSummaryStatusFilter">Status</label>
                                <select id="hospitalSummaryStatusFilter" class="form-control">
                                    <option value="all">All Status</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="hospital-summary-grid" id="hospitalSummaryGrid">
                            <!-- Hospital summary cards will be populated here -->
                        </div>
                        
                        <div class="table-scroll-container mt-20">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Hospital</th>
                                        <th>Total Requests</th>
                                        <th>Pending</th>
                                        <th>Approved</th>
                                        <th>Rejected</th>
                                        <th>Total Requested</th>
                                        <th>Total Approved</th>
                                        <th>Approval Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hospitalSummaryTableBody">
                                    <!-- Hospital summary data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="button-group mt-20">
                            <button id="exportHospitalSummary" class="btn">Export to Excel</button>
                            <button id="printHospitalSummary" class="btn btn-secondary">Print Report</button>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div id="reportsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">Generate Reports</h2>
                        
                        <div class="report-controls">
                            <div class="report-control">
                                <label class="form-label" for="reportType">Report Type</label>
                                <select id="reportType" class="form-control">
                                    <option value="allocations">Allocation Summary</option>
                                    <option value="hospitals">Hospital-wise Summary</option>
                                    <option value="votes">Vote-wise Summary</option>
                                    <option value="monthly">Monthly Summary</option>
                                </select>
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="startDate">Start Date</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="hospitalFilter">Hospital</label>
                                <select id="hospitalFilter" class="form-control">
                                    <option value="all">All Hospitals</option>
                                    <!-- Hospital options will be populated here -->
                                </select>
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label">&nbsp;</label>
                                <button id="generateReport" class="btn">Generate Report</button>
                            </div>
                        </div>
                        
                        <div id="reportResults"></div>
                    </div>
                </div>
                
                <!-- System Logs Tab -->
                <div id="logsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">System Logs</h2>
                        
                        <div class="admin-controls">
                            <div class="filter-control">
                                <label class="form-label" for="logTypeFilter">Filter by Type</label>
                                <select id="logTypeFilter" class="form-control">
                                    <option value="all">All Logs</option>
                                    <option value="allocation">Allocation</option>
                                    <option value="approval">Approval</option>
                                    <option value="system">System</option>
                                </select>
                            </div>
                            <div class="filter-control">
                                <label class="form-label" for="userFilter">Filter by User</label>
                                <select id="userFilter" class="form-control">
                                    <option value="all">All Users</option>
                                    <!-- User options will be populated here -->
                                </select>
                            </div>
                            <div class="search-control filter-control">
                                <label class="form-label" for="searchLogs">Search Logs</label>
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchLogs" class="form-control" placeholder="Search logs...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <div class="data-table-header">
                                <div class="data-table-title">System Activity Log</div>
                                <div class="data-table-controls">
                                    <button id="refreshLogs" class="btn btn-secondary">Refresh</button>
                                    <button id="exportLogs" class="btn">Export</button>
                                </div>
                            </div>
                            <div class="table-scroll-container">
                                <table class="user-allocation-table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Type</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemLogsTable">
                                        <!-- Logs will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination">
                                <button id="logsPrevPage" disabled>Previous</button>
                                <span class="pagination-info" id="logsPageInfo">Page 1 of 1</span>
                                <button id="logsNextPage" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approval Modal -->
    <div id="approvalModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approve Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="uniquePassword">Request Password *</label>
                    <input type="password" id="uniquePassword" class="form-control" placeholder="Enter request password for verification" required>
                    <small class="form-text">Enter the unique password provided for this request</small>
                </div>
                
                <div class="form-section">
                    <h4 class="section-title">Allocation Details</h4>
                    <div class="enhanced-pdf-section">
                        <div><strong>Reference:</strong> <span id="approvalRefNumber"></span></div>
                        <div><strong>Hospital:</strong> <span id="approvalHospital"></span></div>
                        <div><strong>Vote Number:</strong> <span id="approvalVoteNumber"></span></div>
                        <div><strong>Job Description:</strong> <span id="approvalJobDescription"></span></div>
                        <div><strong>Requested Amount:</strong> <span id="approvalRequestedAmount"></span></div>
                        <div><strong>Priority:</strong> <span id="approvalPriority"></span></div>
                        <!-- ADDED: Additional Notes with red highlighting -->
                        <div style="margin-top: 10px; padding: 10px; background-color: #ffebee; border-left: 4px solid #ea4335; border-radius: 4px;">
                            <strong style="color: #ea4335;">Additional Notes from Request:</strong>
                            <div id="approvalAdditionalNotes" style="color: #333; margin-top: 5px; font-size: 14px;"></div>
                        </div>
                    </div>
                </div>                
                <div class="form-section">
                    <h4 class="section-title">Approval Details</h4>
                    <div class="form-group">
                        <label class="form-label" for="approvedAmount">Approved Amount (LKR) *</label>
                        <input type="number" id="approvedAmount" class="form-control" placeholder="Enter approved amount" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="approvalNotes">Approval Notes</label>
                        <textarea id="approvalNotes" class="form-control" rows="3" placeholder="Add any notes about the approval..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="approvingAuthority">Approving Authority *</label>
                        <select id="approvingAuthority" class="form-control" required>
                            <option value="">Select approving authority</option>
                            <option value="Deputy Director General (Logistics)">Deputy Director General (Logistics)</option>
                            <option value="Director Building (Administration)">Director Building (Administration)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="rejectRequest" class="btn btn-danger">Reject Request</button>
                <button id="confirmApproval" class="btn">Approve Request</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editHospitalName">Hospital Name</label>
                            <input type="text" id="editHospitalName" class="form-control readonly" readonly>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactPerson">Contact Person</label>
                            <input type="text" id="editContactPerson" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactPhone">Contact Phone</label>
                            <input type="tel" id="editContactPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactEmail">Contact Email</label>
                            <input type="email" id="editContactEmail" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editVoteNumber">Vote Number</label>
                            <select id="editVoteNumber" class="form-control">
                                <option value="">-- Select Vote Number --</option>
                                <option value="111-1-5-2001(11) Building Rehabilitation-Hospital">111-1-5-2001(11) Building Rehabilitation-Hospital</option>
                                <option value="111-1-5-2002(11) Service and Maintenance-Hospital">111-1-5-2002(11) Service and Maintenance-Hospital</option>
                                <option value="111-1-5-2103(11) Machinery Purchasing-Hospitals">111-1-5-2103(11) Machinery Purchasing-Hospitals</option>
                                <option value="111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions">111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions</option>
                                <option value="111-2-26-2001(11) Building Rehabilitation-Other Health Institutions">111-2-26-2001(11) Building Rehabilitation-Other Health Institutions</option>
                                <option value="111-2-26-2002(11) Service and Maintenance-Other Health Institutions">111-2-26-2002(11) Service and Maintenance-Other Health Institutions</option>
                                <option value="111-2-26-2103(11) Machinery Purchasing-Other Health Institutions">111-2-26-2103(11) Machinery Purchasing-Other Health Institutions</option>
                                <option value="111-2-20-001-2001(11) Building Rehabilitation-NTS">111-2-20-001-2001(11) Building Rehabilitation-NTS</option>
                                <option value="111-2-20-001-2002(11) Service and Maintenance-NTS">111-2-20-001-2002(11) Service and Maintenance-NTS</option>
                                <option value="111-2-20-001-2103(11) Machinery Purchasing-NTS">111-2-20-001-2103(11) Machinery Purchasing-NTS</option>
                                <option value="111-2-26-008-2001(11) Strengthening Primary Level Health Care">111-2-26-008-2001(11) Strengthening Primary Level Health Care</option>
                                <option value="111-1-2-2001(11) Building and Structures- Ministry Administration">111-1-2-2001(11) Building and Structures- Ministry Administration</option>
                                <option value="111-1-1-2001(11) Building and Structures- Minister Office">111-1-1-2001(11) Building and Structures- Minister Office</option>
                                <option value="111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office">111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office</option>
                                <option value="111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration">111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration</option>
                                <option value="111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration">111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration</option>
                                <option value="111-1-5-013-2001(11) Improvement in Machanical,Electrical and Sewerage Systems">111-1-5-013-2001(11) Improvement in Machanical,Electrical and Sewerage Systems</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editJobDescription">Job Description</label>
                            <textarea id="editJobDescription" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editRequiredAmount">Required Amount (LKR)</label>
                            <input type="number" id="editRequiredAmount" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editPriorityLevel">Priority Level</label>
                            <select id="editPriorityLevel" class="form-control">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editRequiredDate">Required Date</label>
                            <input type="date" id="editRequiredDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editAdditionalNotes">Additional Notes</label>
                            <textarea id="editAdditionalNotes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelEdit" class="btn btn-danger">Cancel</button>
                <button id="confirmEdit" class="btn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- View Modal -->
    <div id="viewModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Allocation Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="enhanced-pdf">
                    <div class="enhanced-pdf-header">
                        <div class="enhanced-pdf-title">Ministry of Health</div>
                        <div class="enhanced-pdf-subtitle">Allocation Request Details</div>
                    </div>
                    <div class="enhanced-pdf-grid">
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Request Reference:</div>
                            <div class="enhanced-pdf-value" id="viewRefNumber"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Submission Date:</div>
                            <div class="enhanced-pdf-value" id="viewDate"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Hospital Details:</div>
                            <div class="enhanced-pdf-value" id="viewHospitalDetails"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Vote Number:</div>
                            <div class="enhanced-pdf-value" id="viewVoteNumber"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Job Description:</div>
                            <div class="enhanced-pdf-value" id="viewJobDescription"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Requested Amount:</div>
                            <div class="enhanced-pdf-value" id="viewRequestedAmount"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approved Amount:</div>
                            <div class="enhanced-pdf-value" id="viewApprovedAmount"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Priority Level:</div>
                            <div class="enhanced-pdf-value" id="viewPriority"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Required Date:</div>
                            <div class="enhanced-pdf-value" id="viewRequiredDate"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Additional Notes:</div>
                            <div class="enhanced-pdf-value" id="viewAdditionalNotes"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Status:</div>
                            <div class="enhanced-pdf-value" id="viewStatus"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approving Authority:</div>
                            <div class="enhanced-pdf-value" id="viewApprovingAuthority"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approval Notes:</div>
                            <div class="enhanced-pdf-value" id="viewApprovalNotes"></div>
                        </div>
                        <!-- Rejection Reason Section -->
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Rejection Reason:</div>
                            <div class="enhanced-pdf-value" id="viewRejectionReason">Not rejected</div>
                        </div>
                    </div>
                    
                    <!-- Rejection Reason Highlight -->
                    <div class="rejection-reason-highlight hidden" id="viewRejectionHighlight">
                        <span class="reason-label">Rejection Reason:</span>
                        <div class="reason-content" id="viewRejectionReasonContent"></div>
                    </div>
                    
                    <!-- Resubmit Request Section (for rejected requests) -->
                    <div class="resubmit-request-section hidden" id="viewResubmitSection">
                        <h4 class="section-title">Resubmit for Approval</h4>
                        <p>This request was rejected. Please address the rejection reason and resubmit for approval.</p>
                        <div class="button-group mt-10">
                            <button id="editRejectedRequest" class="btn btn-secondary">Edit Request</button>
                            <button id="requestReapproval" class="btn">Request Re-approval</button>
                        </div>
                    </div>
                    
                    <!-- Hospital Section Signature -->
                    <div class="hospital-signature-section">
                        <div class="signature-line"></div>
                        <div class="signature-label">Hospital Authorization:</div>
                        <div class="signature-name" id="hospitalSignatureName">[Hospital Director/Deputy Director General]</div>
                        <div class="signature-title" id="hospitalSignatureTitle">[Position]</div>
                        <div class="signature-title" id="hospitalSignatureInstitution">[Hospital Name]</div>
                    </div>

                    <div class="signature-section">
                        <!-- DDG Only Signature (shown when approved by DDG) -->
                        <div class="signature-ddgonly" id="ddgSignatureSection">
                            <div class="signature-line"></div>
                            <div class="signature-label">Approval Signature:</div>
                            <div class="signature-name">H.M.N Dinipriya Herath</div>
                            <div class="signature-title">Deputy Director General (Logistics)</div>
                            <div class="signature-title">For Secretary</div>
                        </div>
                        
                        <!-- Director Only Signature (shown when approved by Director) -->
                        <div class="signature-directoronly" id="directorSignatureSection">
                            <div class="signature-line"></div>
                            <div class="signature-label">Approval Signature:</div>
                            <div class="signature-name">Director Building Branch</div>
                            <div class="signature-title">Director Building Branch (Administration)</div>
                        </div>
                        
                        <div class="mt-20">
                            <div class="signature-label">Copies:</div>
                            <div class="signature-title">1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)</div>
                            <div class="signature-title">2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeView" class="btn">Close</button>
                <button id="approveAgainBtn" class="btn btn-approve-again hidden">Approve Again</button>
                <button id="downloadFinalPdf" class="btn btn-secondary">Download PDF</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reject Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="rejectionPassword">Request Password *</label>
                    <input type="password" id="rejectionPassword" class="form-control" placeholder="Enter request password for verification" required>
                    <small class="form-text">Enter the unique password provided for this request</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Request Details:</label>
                    <div id="rejectionRequestDetails" class="enhanced-pdf-section">
                        <div><strong>Reference:</strong> <span id="rejectionRefNumber"></span></div>
                        <div><strong>Hospital:</strong> <span id="rejectionHospital"></span></div>
                        <div><strong>Vote Number:</strong> <span id="rejectionVoteNumber"></span></div>
                        <div><strong>Requested Amount:</strong> <span id="rejectionRequestedAmount"></span></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="rejectionReason">Rejection Reason *</label>
                    <textarea id="rejectionReason" class="form-control" rows="4" placeholder="Provide detailed reason for rejection..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelRejection" class="btn btn-secondary">Cancel</button>
                <button id="confirmRejection" class="btn btn-danger">Reject Request</button>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminPasswordModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Authentication Required</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="adminPassword">Admin Password *</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" required>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAdminPassword" class="btn btn-danger">Cancel</button>
                <button id="confirmAdminPassword" class="btn">Authenticate</button>
            </div>
        </div>
    </div>

    <!-- Hospital History Modal -->
    <div id="hospitalHistoryModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Hospital Allocation History</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h4 id="hospitalHistoryTitle" style="margin-bottom: 15px;"></h4>
                </div>
                
                <div class="history-summary">
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryTotalRequests">0</div>
                        <div class="label">Total Requests</div>
                    </div>
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryTotalAmount">LKR 0</div>
                        <div class="label">Total Amount</div>
                    </div>
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryApprovedCount">0</div>
                        <div class="label">Approved</div>
                    </div>
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryApprovalRate">0%</div>
                        <div class="label">Approval Rate</div>
                    </div>
                </div>
                
                <div class="table-scroll-container" style="max-height: 400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Ref No.</th>
                                <th>Vote Number</th>
                                <th>Job Description</th>
                                <th>Requested Amount</th>
                                <th>Approved Amount</th>
                                <th>Status</th>
                                <th>Submitted Date</th>
                                <th>Approved Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hospitalHistoryTableBody">
                            <!-- Hospital history data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeHospitalHistory" class="btn">Close</button>
                <button id="exportHospitalHistory" class="btn btn-secondary">Export History</button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbytS1JHS5rsQf3Oc9EVnjunOZjCJF2l4TYvAdPcv_j2yOHwg82jkNC5i2tRIaaNNG1o/exec';

        // Global variables
        let currentUserRole = 'hospital';
        let currentUserId = null;
        let currentRequestId = null;
        let currentRequestRef = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let allAllocations = [];
        let filteredAllocations = [];
        let systemLogs = [];

        // Admin password
        const ADMIN_PASSWORD = "ADS005";

        // Pending action variables
        let pendingAction = null;
        let pendingRequestId = null;

        // Pagination variables
        let myRequestsPage = 1;
        let myRequestsItemsPerPage = 10;
        let filteredMyRequests = [];

        let logsPage = 1;
        let logsItemsPerPage = 15;
        let filteredLogs = [];

        // Hospital accounts
        const hospitalAccounts = {
            'Ministry of Health': { password: 'moh123' },
            'National Hospital Sri Lanka': { password: 'nhsl123' },
            'Colombo South Teaching Hospital': { password: 'csth123' },
            'Lady Ridgeway Hospital': { password: 'lrh123' },
            'Apeksha Hospital Maharagama': { password: 'ahm123' },
            'Colombo East Base Hospital Mulleriyawa': { password: 'cebhm123' },
            'Infections Diseases Hospital': { password: 'idh123' },
            'NIMH': { password: 'nimh123' },
            'De Soysa Hospital': { password: 'dsh123' },
            'Castle Street Hospital for Women': { password: 'csshw123' },
            'National Eye Hospital': { password: 'neh123' },
            'Institute of Oral Health-Maharagama': { password: 'iohm123' },
            'National Blood Transfusion Service': { password: 'nbts123' },
            'National Institute for Nephrology Dialysis and Transplantation - Maligawatta': { password: 'nindtm123' },
            'Medical Research Institute': { password: 'mri123' },
            'National Dental Hospital': { password: 'ndh123' },
            'Colombo North Teaching Hospital - Ragama': { password: 'cnthr123' },
            'Rheumatology & Rehabilitation Hospital, Ragama': { password: 'rrhr123' },
            'District Hospital Kandana': { password: 'dhk123' },
            'National Hospital for Respiratory Diseases, Welisara': { password: 'nhrdw123' },
            'Leprosy Hospital - Handala': { password: 'lhh123' },
            'DGH Negombo (District General Hospital)': { password: 'dghn123' },
            'Teaching Hospital Kalutara': { password: 'thk123' },
            'National Institute of Health Sciences Kalutara': { password: 'nihsk123' },
            'National Hospital - Kandy': { password: 'nhk123' },
            'Base Hospital Gampola': { password: 'bhg123' },
            'Teaching Hospital Peradeniya': { password: 'thp123' },
            'Sirimavo Bandaranayake Hospital - Peradeniya': { password: 'sbhp123' },
            'District General Hospital Nawalapitiya': { password: 'dghn123' },
            'District General Hospital NuwaraEliya': { password: 'dghne123' },
            'District General Hospital Matale': { password: 'dghm123' },
            'National Hospital - Galle (Karapitiya)': { password: 'nhg123' },
            'German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)': { password: 'gslfhwg123' },
            'District General Hospital Matara': { password: 'dghm123' },
            'District General Hospital Hambantota': { password: 'dghh123' },
            'TH Jaffna': { password: 'thj123' },
            'Base Hospital Akkaraipattu': { password: 'bha123' },
            'Ashroff Hospital - Kalmunai': { password: 'ahk123' },
            'Base Hospital Kalmunai North': { password: 'bhkn123' },
            'District General Hospital Ampara': { password: 'dgha123' },
            'Base Hospital Pottuvil': { password: 'bhp123' },
            'District General Hospital Trincomalee': { password: 'dght123' },
            'District General Hospital Kantale': { password: 'dghk123' },
            'Teaching Hospital Batticaloa': { password: 'thb123' },
            'District General Hospital Chilaw': { password: 'dghc123' },
            'Teaching Hospital Kurunegala': { password: 'thk123' },
            'Teaching Hospital Kuliyapitiya': { password: 'thk123' },
            'District General Hospital Polonnaruwa': { password: 'dghp123' },
            'China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)': { password: 'cslfnshp123' },
            'TH Anuradhapura': { password: 'tha123' },
            'TH Badulla': { password: 'thb123' },
            'District General Hospital Monaragala': { password: 'dghm123' },
            'District General Hospital Kegalle': { password: 'dghk123' },
            'Teaching Hospital Ratnapura': { password: 'thr123' },
            'District General Hospital Embilipitiya': { password: 'dghe123' },
            'National STD/AIDS Control Programme': { password: 'nsacp123' },
            'Biomedical Engineering Services': { password: 'bes123' },
            'Epidemiology Unit': { password: 'eu123' },
            'National Cancer Control Programme': { password: 'nccp123' },
            'National Programme for Tuberculosis Control & Chest Diseases': { password: 'nptccd123' },
            'Institute for Forensic Medicine & Toxicology': { password: 'ifmt123' },
            'Health Promotion Bureau': { password: 'hpb123' },
            'Dengue Control Programme': { password: 'dcp123' },
            'Anti Malaria Campaign': { password: 'amc123' },
            'Family Health Bureau': { password: 'fhb123' },
            'Anti Filariasis Campaign': { password: 'afc123' },
            'Medical Supplies Division': { password: 'msd123' },
            'Public Health Veterinary Services': { password: 'phvs123' }
        };

        // Admin accounts
        const adminAccounts = {
            'ddg_logistics': { name: 'Deputy Director General (Logistics)', password: 'ddg123' },
            'director_building': { name: 'Director Building (Administration)', password: 'dba123' }
        };

        // Hospital Signatories Database
        const hospitalSignatories = {
            'National Hospital Sri Lanka': { 
                name: '', 
                title: 'Director',
                institution: 'National Hospital Sri Lanka'
            },
            'Colombo South Teaching Hospital': { 
                name: '', 
                title: 'Deputy Director General',
                institution: 'Colombo South Teaching Hospital'
            },
            'Lady Ridgeway Hospital': { 
                name: '', 
                title: 'Director',
                institution: 'Lady Ridgeway Hospital'
            },
            'Apeksha Hospital Maharagama': { 
                name: '', 
                title: 'Director',
                institution: 'Apeksha Hospital Maharagama'
            },
            'Colombo East Base Hospital Mulleriyawa': { 
                name: '', 
                title: 'Director',
                institution: 'Colombo East Base Hospital Mulleriyawa'
            },
            'National Hospital - Kandy': { 
                name: '', 
                title: 'Director',
                institution: 'National Hospital - Kandy'
            },
            'National Hospital - Galle (Karapitiya)': { 
                name: '', 
                title: 'Director',
                institution: 'National Hospital - Galle'
            },
            'Teaching Hospital Kurunegala': { 
                name: '', 
                title: 'Director',
                institution: 'Teaching Hospital Kurunegala'
            },
            'TH Anuradhapura': { 
                name: '', 
                title: 'Director',
                institution: 'Teaching Hospital Anuradhapura'
            },
            'Teaching Hospital Batticaloa': { 
                name: '', 
                title: 'Director',
                institution: 'Teaching Hospital Batticaloa'
            },
            'TH Jaffna': { 
                name: '', 
                title: 'Director',
                institution: 'Teaching Hospital Jaffna'
            },
            'Teaching Hospital Ratnapura': { 
                name: '', 
                title: 'Director',
                institution: 'Teaching Hospital Ratnapura'
            },
            'TH Badulla': { 
                name: '', 
                title: 'Director',
                institution: 'Teaching Hospital Badulla'
            },
            'Ministry of Health': { 
                name: '', 
                title: ' Director Building Administration',
                institution: 'Ministry of Health'
            }
        };

        // ========== ENHANCED STATUS STYLES ==========
        const enhancedStatusStyles = `
        /* ========== ENHANCED STATUS BADGES ========== */
        .status-badge-enhanced {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .status-badge-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
            opacity: 0.3;
        }

        .status-badge-enhanced.pending {
            background: linear-gradient(135deg, #ffeb3b 0%, #fbc02d 100%);
            color: #856404;
            border: 2px solid #ffc107;
            animation: pulse 2s infinite;
        }

        .status-badge-enhanced.approved {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: #155724;
            border: 2px solid #28a745;
        }

        .status-badge-enhanced.rejected {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .status-badge-enhanced.completed {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: #004085;
            border: 2px solid #17a2b8;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        /* ========== STATUS CARDS ENHANCED ========== */
        .status-card-enhanced {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            border-top: 5px solid;
            transition: transform 0.3s ease;
        }

        .status-card-enhanced:hover {
            transform: translateY(-5px);
        }

        .status-card-enhanced.pending {
            border-color: var(--warning);
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        }

        .status-card-enhanced.approved {
            border-color: var(--secondary);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .status-card-enhanced.rejected {
            border-color: var(--danger);
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .status-card-enhanced.completed {
            border-color: var(--primary);
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .status-card-count-enhanced {
            font-size: 32px;
            font-weight: 800;
            margin: 10px 0;
            display: block;
        }

        .status-card-label-enhanced {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ========== ENHANCED TABLE STYLES ========== */
        .enhanced-table-row {
            transition: all 0.3s ease;
        }

        .enhanced-table-row:hover {
            transform: scale(1.005);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        `;

        // Add the CSS to the document
        const styleSheet = document.createElement("style");
        styleSheet.textContent = enhancedStatusStyles;
        document.head.appendChild(styleSheet);

        // Initialize localStorage if not exists
        function initializeLocalStorage() {
            if (!localStorage.getItem('allocations')) {
                localStorage.setItem('allocations', JSON.stringify([]));
            }
            if (!localStorage.getItem('systemLogs')) {
                localStorage.setItem('systemLogs', JSON.stringify([]));
            }
        }

        // Utility Functions
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        function showElement(element, show = true) {
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        function showMessage(message, type = 'error') {
            const loginMessage = document.getElementById('loginMessage');
            loginMessage.textContent = message;
            loginMessage.style.color = type === 'error' ? 'red' : 'green';
            showElement(loginMessage);
            setTimeout(() => showElement(loginMessage, false), 5000);
        }

        function generateUniquePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 6; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function formatCurrency(amount) {
            // Convert to number first
            let num = parseFloat(amount);
            
            // Check if it's a valid number
            if (isNaN(num)) {
                return 'LKR 0';
            }
            
            // Format with 2 decimal places and commas for thousands
            return 'LKR ' + num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Enhanced Status Display Functions
        function getEnhancedStatusBadge(status, isEnhanced = true) {
            if (!isEnhanced) {
                const statusClass = `status-${status.toLowerCase()}`;
                return `<span class="status-badge ${statusClass}">${status}</span>`;
            }
            
            const statusClass = `status-badge-enhanced ${status.toLowerCase()}`;
            let icon = '';
            
            switch(status.toLowerCase()) {
                case 'pending':
                    icon = '<i class="fas fa-clock mr-5"></i>';
                    break;
                case 'approved':
                    icon = '<i class="fas fa-check-circle mr-5"></i>';
                    break;
                case 'rejected':
                    icon = '<i class="fas fa-times-circle mr-5"></i>';
                    break;
                case 'completed':
                    icon = '<i class="fas fa-check-double mr-5"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle mr-5"></i>';
            }
            
            return `<span class="${statusClass}">${icon}${status}</span>`;
        }

        // System Logging Function
        function logSystemActivity(type, user, action, details = '') {
            const log = {
                timestamp: new Date().toISOString(),
                type: type,
                user: user,
                action: action,
                details: details
            };
            
            const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
            logs.unshift(log);
            if (logs.length > 1000) logs.pop();
            localStorage.setItem('systemLogs', JSON.stringify(logs));
            
            systemLogs = logs;
            
            const logsTab = document.getElementById('logsTab');
            if (logsTab && !logsTab.classList.contains('hidden')) {
                filterLogs();
            }
        }

        // Update pending allocation notification
        function updatePendingAllocationNotification() {
            const pendingAllocationBadge = document.getElementById('pendingAllocationBadge');
            const pendingCount = allAllocations.filter(allocation => allocation.status === 'Pending').length;
            if (pendingCount > 0) {
                pendingAllocationBadge.textContent = pendingCount;
                showElement(pendingAllocationBadge);
            } else {
                showElement(pendingAllocationBadge, false);
            }
        }

        // Admin password authentication
        function authenticateAdmin(action, requestId = null) {
            pendingAction = action;
            pendingRequestId = requestId;
            document.getElementById('adminPassword').value = '';
            showElement(document.getElementById('adminPasswordModal'));
        }

        function executePendingAction() {
            if (pendingAction === 'edit') {
                openEditModal(pendingRequestId);
            } else if (pendingAction === 'delete') {
                deleteAllocation(pendingRequestId);
            }
            
            pendingAction = null;
            pendingRequestId = null;
        }

        // API Functions
        async function callGoogleAppsScript(action, data = {}) {
            try {
                const formData = new URLSearchParams();
                formData.append('action', action);
                
                for (const [key, value] of Object.entries(data)) {
                    formData.append(key, value);
                }

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                return getMockData(action, data);
            }
        }

        // Enhanced Mock Data
        function getMockData(action, data) {
            switch(action) {
                case 'login':
                    if (data.role === 'admin' && data.password === 'ADS005') {
                        logSystemActivity('system', 'Administrator', 'Login', 'Main admin login successful');
                        return { success: true, message: 'Login successful', role: 'mainadmin' };
                    }
                    if (data.role === 'admin' && data.userId && adminAccounts[data.userId] && data.password === adminAccounts[data.userId].password) {
                        logSystemActivity('system', 'Admin', 'Login', `Admin ${data.userId} login successful`);
                        return { success: true, message: 'Login successful', userName: adminAccounts[data.userId].name, userId: data.userId };
                    }
                    if (data.role === 'hospital' && data.hospitalId && hospitalAccounts[data.hospitalId] && data.password === hospitalAccounts[data.hospitalId].password) {
                        logSystemActivity('system', 'Hospital', 'Login', `Hospital ${data.hospitalId} login successful`);
                        return { success: true, message: 'Login successful', hospitalName: data.hospitalId, hospitalId: data.hospitalId };
                    }
                    return { success: false, error: 'Invalid credentials' };
                
                case 'submitAllocation':
                    const refNumber = 'ADS-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
                    const uniquePassword = generateUniquePassword();
                    
                    const allocation = {
                        id: Date.now(),
                        refnumber: refNumber,
                        hospitalname: data.hospitalName,
                        contactperson: data.contactPerson,
                        contactphone: data.contactPhone,
                        contactemail: data.contactEmail,
                        votenumber: data.voteNumber,
                        jobdescription: data.jobDescription,
                        requiredamount: data.requiredAmount,
                        approvedamount: 0,
                        prioritylevel: data.priorityLevel,
                        requireddate: data.requiredDate,
                        additionalnotes: data.additionalNotes || '',
                        status: 'Pending',
                        approvingauthority: '',
                        approvalnotes: '',
                        rejectionreason: '',
                        timestamp: new Date().toISOString(),
                        uniquepassword: uniquePassword,
                        hospitalId: data.hospitalId,
                        approvaldate: null
                    };
                    
                    let allocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    allocations.push(allocation);
                    localStorage.setItem('allocations', JSON.stringify(allocations));
                    
                    logSystemActivity('allocation', data.hospitalName, 'Allocation Submitted', `Ref: ${refNumber}`);
                    
                    return {
                        success: true,
                        message: 'Allocation request submitted successfully',
                        requestId: allocation.id,
                        refNumber: refNumber,
                        uniquePassword: uniquePassword
                    };
                
                case 'getAllocations':
                    const storedAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    return { allocations: storedAllocations };
                
                case 'approveAllocation':
                    let allAllocationsData = JSON.parse(localStorage.getItem('allocations') || '[]');
                    
                    const allocationIndex = allAllocationsData.findIndex(a => a.id == data.requestId);
                    
                    if (allocationIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    const storedPassword = allAllocationsData[allocationIndex].uniquepassword;
                    const enteredPassword = data.uniquePassword;
                    
                    if (!storedPassword || !enteredPassword) {
                        return { success: false, error: 'Password is required' };
                    }
                    
                    if (storedPassword.toUpperCase() !== enteredPassword.toUpperCase()) {
                        return { success: false, error: 'Invalid request password. Please check and try again.' };
                    }
                    
                    allAllocationsData[allocationIndex].approvedamount = data.approvedAmount;
                    allAllocationsData[allocationIndex].approvingauthority = data.approvingAuthority;
                    allAllocationsData[allocationIndex].approvalnotes = data.approvalNotes || '';
                    allAllocationsData[allocationIndex].status = 'Approved';
                    allAllocationsData[allocationIndex].approvaldate = new Date().toISOString();
                    
                    localStorage.setItem('allocations', JSON.stringify(allAllocationsData));
                    
                    logSystemActivity('approval', 'Administrator', 'Allocation Approved', 
                        `Request: ${allAllocationsData[allocationIndex].refnumber}, Amount: ${data.approvedAmount}, Authority: ${data.approvingAuthority}`);
                    
                    return { success: true, message: 'Allocation approved successfully' };
                
                case 'rejectAllocation':
                    let rejectAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    
                    const rejectIndex = rejectAllocations.findIndex(a => a.id == data.requestId);
                    
                    if (rejectIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    const storedRejectPassword = rejectAllocations[rejectIndex].uniquepassword;
                    const enteredRejectPassword = data.uniquePassword;
                    
                    if (!storedRejectPassword || !enteredRejectPassword) {
                        return { success: false, error: 'Password is required' };
                    }
                    
                    if (storedRejectPassword.toUpperCase() !== enteredRejectPassword.toUpperCase()) {
                        return { success: false, error: 'Invalid request password. Please check and try again.' };
                    }
                    
                    rejectAllocations[rejectIndex].rejectionreason = data.rejectionReason;
                    rejectAllocations[rejectIndex].status = 'Rejected';
                    
                    localStorage.setItem('allocations', JSON.stringify(rejectAllocations));
                    
                    logSystemActivity('rejection', 'Administrator', 'Allocation Rejected', 
                        `Request: ${rejectAllocations[rejectIndex].refnumber}, Reason: ${data.rejectionReason}`);
                    
                    return { success: true, message: 'Allocation rejected successfully' };
                
                case 'editAllocation':
                    let editAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    const editIndex = editAllocations.findIndex(a => a.id == data.requestId);
                    
                    if (editIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    editAllocations[editIndex].hospitalname = data.hospitalName;
                    editAllocations[editIndex].contactperson = data.contactPerson;
                    editAllocations[editIndex].contactphone = data.contactPhone;
                    editAllocations[editIndex].contactemail = data.contactEmail;
                    editAllocations[editIndex].votenumber = data.voteNumber;
                    editAllocations[editIndex].jobdescription = data.jobDescription;
                    editAllocations[editIndex].requiredamount = data.requiredAmount;
                    editAllocations[editIndex].prioritylevel = data.priorityLevel;
                    editAllocations[editIndex].requireddate = data.requiredDate;
                    editAllocations[editIndex].additionalnotes = data.additionalNotes || '';
                    
                    localStorage.setItem('allocations', JSON.stringify(editAllocations));
                    
                    logSystemActivity('allocation', 'Administrator', 'Allocation Updated', `Ref: ${editAllocations[editIndex].refnumber}`);
                    
                    return { success: true, message: 'Allocation updated successfully' };
                
                case 'deleteAllocation':
                    let deleteAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    const deleteIndex = deleteAllocations.findIndex(a => a.id == data.requestId);
                    
                    if (deleteIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    const deletedRef = deleteAllocations[deleteIndex].refnumber;
                    deleteAllocations.splice(deleteIndex, 1);
                    localStorage.setItem('allocations', JSON.stringify(deleteAllocations));
                    
                    logSystemActivity('allocation', 'Administrator', 'Allocation Deleted', `Ref: ${deletedRef}`);
                    
                    return { success: true, message: 'Allocation deleted successfully' };
                
                case 'getReports':
                    const reportAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    
                    let filteredData = reportAllocations;
                    
                    if (data.startDate && data.endDate) {
                        const startTimestamp = new Date(data.startDate).getTime();
                        const endTimestamp = new Date(data.endDate).getTime() + 86400000;
                        
                        filteredData = reportAllocations.filter(allocation => {
                            const allocationTime = new Date(allocation.timestamp).getTime();
                            return allocationTime >= startTimestamp && allocationTime < endTimestamp;
                        });
                    }
                    
                    if (data.hospital && data.hospital !== 'all') {
                        filteredData = filteredData.filter(allocation => allocation.hospitalname === data.hospital);
                    }
                    
                    let reportData = [];
                    let title = '';
                    
                    switch(data.type) {
                        case 'allocations':
                            title = 'Allocation Summary Report';
                            reportData = [['Request Ref', 'Hospital', 'Vote Number', 'Job Description', 'Requested Amount', 'Approved Amount', 'Status', 'Date']];
                            filteredData.forEach(allocation => {
                                reportData.push([
                                    allocation.refnumber,
                                    allocation.hospitalname,
                                    allocation.votenumber,
                                    allocation.jobdescription.substring(0, 50) + (allocation.jobdescription.length > 50 ? '...' : ''),
                                    formatCurrency(allocation.requiredamount),
                                    allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved',
                                    allocation.status,
                                    formatDate(allocation.timestamp)
                                ]);
                            });
                            break;
                            
                        case 'hospitals':
                            title = 'Hospital-wise Summary Report';
                            const hospitalData = {};
                            
                            filteredData.forEach(allocation => {
                                if (!hospitalData[allocation.hospitalname]) {
                                    hospitalData[allocation.hospitalname] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                                }
                                hospitalData[allocation.hospitalname].total++;
                                hospitalData[allocation.hospitalname][allocation.status.toLowerCase()]++;
                                hospitalData[allocation.hospitalname].totalRequested += parseFloat(allocation.requiredamount);
                                if (allocation.approvedamount > 0) {
                                    hospitalData[allocation.hospitalname].totalApproved += parseFloat(allocation.approvedamount);
                                }
                            });
                            
                            reportData = [['Hospital', 'Total Requests', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                            Object.keys(hospitalData).forEach(hospital => {
                                const data = hospitalData[hospital];
                                reportData.push([
                                    hospital,
                                    data.total.toString(),
                                    data.pending.toString(),
                                    data.approved.toString(),
                                    data.rejected.toString(),
                                    formatCurrency(data.totalRequested),
                                    formatCurrency(data.totalApproved)
                                ]);
                            });
                            break;
                            
                        case 'votes':
                            title = 'Vote-wise Summary Report';
                            const voteData = {};
                            
                            filteredData.forEach(allocation => {
                                if (!voteData[allocation.votenumber]) {
                                    voteData[allocation.votenumber] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                                }
                                voteData[allocation.votenumber].total++;
                                voteData[allocation.votenumber][allocation.status.toLowerCase()]++;
                                voteData[allocation.votenumber].totalRequested += parseFloat(allocation.requiredamount);
                                if (allocation.approvedamount > 0) {
                                    voteData[allocation.votenumber].totalApproved += parseFloat(allocation.approvedamount);
                                }
                            });
                            
                            reportData = [['Vote Number', 'Total Requests', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                            Object.keys(voteData).forEach(vote => {
                                const data = voteData[vote];
                                reportData.push([
                                    vote,
                                    data.total.toString(),
                                    data.pending.toString(),
                                    data.approved.toString(),
                                    data.rejected.toString(),
                                    formatCurrency(data.totalRequested),
                                    formatCurrency(data.totalApproved)
                                ]);
                            });
                            break;
                            
                        case 'monthly':
                            title = 'Monthly Summary Report';
                            const monthlyData = {};
                            
                            filteredData.forEach(allocation => {
                                const monthYear = new Date(allocation.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                                if (!monthlyData[monthYear]) {
                                    monthlyData[monthYear] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                                }
                                monthlyData[monthYear].total++;
                                monthlyData[monthYear][allocation.status.toLowerCase()]++;
                                monthlyData[monthYear].totalRequested += parseFloat(allocation.requiredamount);
                                if (allocation.approvedamount > 0) {
                                    monthlyData[monthYear].totalApproved += parseFloat(allocation.approvedamount);
                                }
                            });
                            
                            reportData = [['Month', 'Total', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                            Object.keys(monthlyData).forEach(month => {
                                const data = monthlyData[month];
                                reportData.push([
                                    month,
                                    data.total.toString(),
                                    data.pending.toString(),
                                    data.approved.toString(),
                                    data.rejected.toString(),
                                    formatCurrency(data.totalRequested),
                                    formatCurrency(data.totalApproved)
                                ]);
                            });
                            break;
                            
                        default:
                            return { success: false, error: 'Invalid report type' };
                    }
                    
                    return {
                        success: true,
                        title: title,
                        generatedAt: new Date().toISOString(),
                        reportData: reportData
                    };
                
                case 'getSystemLogs':
                    const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
                    return { logs: logs };
                
                default:
                    return { success: false, error: 'Unknown action' };
            }
        }

        // Authentication Functions
        async function handleLogin() {
            const hospitalSelect = document.getElementById('hospitalSelect');
            const passwordInput = document.getElementById('password');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginBtn = document.getElementById('loginBtn');
            
            const hospitalId = hospitalSelect.value;
            const password = passwordInput.value.trim();
            
            if (currentUserRole === 'hospital' && !hospitalId) {
                showMessage('Please select a hospital');
                return;
            }
            
            if (!password) {
                showMessage('Please enter a password');
                return;
            }

            showElement(loginSpinner);
            loginBtn.disabled = true;

            try {
                const result = await callGoogleAppsScript('login', {
                    role: currentUserRole,
                    hospitalId: hospitalId,
                    userId: hospitalId,
                    password: password
                });

                if (result.success) {
                    showElement(document.getElementById('loginScreen'), false);
                    if (currentUserRole === 'hospital') {
                        currentUserId = hospitalId;
                        showElement(document.getElementById('hospitalDashboard'));
                        document.getElementById('hospitalDisplayName').textContent = result.hospitalName || 'Hospital User';
                        document.getElementById('hospitalName').value = result.hospitalName || hospitalId;
                        resetAllocationForm();
                        loadMyRequests();
                        updateUserAllocationStatus();
                    } else {
                        showElement(document.getElementById('adminDashboard'));
                        document.getElementById('adminDisplayName').textContent = 
                            result.role === 'mainadmin' ? 'Main Administrator' : result.userName || 'Administrator';
                        loadAdminData();
                        loadSystemLogs();
                        loadAdminAllocationHistory();
                        loadAdminVoteDistribution();
                        loadHospitalSummary();
                        enhanceLoggingSection();
                    }
                } else {
                    showMessage(result.error || 'Invalid password');
                }
            } catch (error) {
                showMessage('Login failed. Please try again.');
            } finally {
                showElement(loginSpinner, false);
                loginBtn.disabled = false;
            }
        }

        function logout() {
            logSystemActivity('system', currentUserRole === 'hospital' ? 'Hospital' : 'Administrator', 'Logout');
            showElement(document.getElementById('hospitalDashboard'), false);
            showElement(document.getElementById('adminDashboard'), false);
            showElement(document.getElementById('loginScreen'));
            document.getElementById('password').value = '';
            document.getElementById('hospitalSelect').value = '';
            showElement(document.getElementById('loginMessage'), false);
            currentUserId = null;
        }

        // Allocation Functions
        async function submitAllocation() {
            const requiredFields = ['hospitalName', 'contactPerson', 'contactPhone', 'voteNumber', 'jobDescription', 'requiredAmount', 'priorityLevel', 'requiredDate'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    alert(`Please fill in the ${field.previousElementSibling.textContent}`);
                    field.focus();
                    return;
                }
            }

            const requiredDate = new Date(document.getElementById('requiredDate').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (requiredDate < today) {
                alert('Required date cannot be in the past');
                return;
            }

            const allocationData = {
                hospitalName: document.getElementById('hospitalName').value.trim(),
                contactPerson: document.getElementById('contactPerson').value.trim(),
                contactPhone: document.getElementById('contactPhone').value.trim(),
                contactEmail: document.getElementById('contactEmail').value.trim(),
                voteNumber: document.getElementById('voteNumber').value,
                jobDescription: document.getElementById('jobDescription').value.trim(),
                requiredAmount: document.getElementById('requiredAmount').value,
                priorityLevel: document.getElementById('priorityLevel').value,
                requiredDate: document.getElementById('requiredDate').value,
                additionalNotes: document.getElementById('additionalNotes').value.trim(),
                hospitalId: currentUserId
            };

            const submitAllocationBtn = document.getElementById('submitAllocation');
            const submitSpinner = document.getElementById('submitSpinner');
            submitAllocationBtn.disabled = true;
            showElement(submitSpinner);

            try {
                const result = await callGoogleAppsScript('submitAllocation', allocationData);
                
                if (result.success) {
                    currentRequestId = result.requestId;
                    currentRequestRef = result.refNumber;
                    updateAllocationConfirmation(result, allocationData);
                    showElement(document.getElementById('allocationForm'), false);
                    showElement(document.getElementById('allocationSuccess'));
                    
                    if (document.getElementById('adminDashboard').style.display === 'block') {
                        loadAdminData();
                        loadAdminAllocationHistory();
                        loadAdminVoteDistribution();
                        loadHospitalSummary();
                    }
                    
                    loadMyRequests();
                } else {
                    alert('Allocation submission failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Allocation submission failed. Please try again.');
            } finally {
                submitAllocationBtn.disabled = false;
                showElement(submitSpinner, false);
            }
        }

        function updateAllocationConfirmation(result, data) {
            document.getElementById('enhancedPdfRefNumber').textContent = result.refNumber;
            document.getElementById('enhancedPdfPassword').textContent = result.uniquePassword;
            document.getElementById('enhancedPdfDate').textContent = new Date().toLocaleDateString();
            document.getElementById('enhancedPdfHospitalDetails').textContent = 
                `${data.hospitalName}, ${data.contactPerson}, ${data.contactPhone}`;
            document.getElementById('enhancedPdfVoteNumber').textContent = data.voteNumber;
            document.getElementById('enhancedPdfJobDescription').textContent = data.jobDescription;
            document.getElementById('enhancedPdfAmount').textContent = formatCurrency(data.requiredAmount);
            document.getElementById('enhancedPdfPriority').textContent = data.priorityLevel;
            document.getElementById('enhancedPdfRequiredDate').textContent = formatDate(data.requiredDate);
            document.getElementById('enhancedPdfAdditionalNotes').textContent = 
                data.additionalNotes || 'No additional notes';
            document.getElementById('uniquePasswordDisplay').textContent = result.uniquePassword;
        }

        function resetAllocationForm() {
            const fields = ['contactPerson', 'contactPhone', 'contactEmail', 'voteNumber', 'jobDescription', 'requiredAmount', 'priorityLevel', 'requiredDate', 'additionalNotes'];
            fields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            document.getElementById('hospitalName').value = currentUserId;
            
            showElement(document.getElementById('allocationForm'));
            showElement(document.getElementById('allocationSuccess'), false);
        }

        // Hospital My Requests Functions
        async function loadMyRequests() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
                filteredMyRequests = myAllocations;
                displayMyRequests();
                updateMyRequestsPagination();
            } catch (error) {
                console.error('Error loading my requests:', error);
            }
        }

        function filterMyRequests() {
            const status = document.getElementById('myRequestsStatusFilter').value;
            const searchTerm = document.getElementById('searchMyRequests').value.toLowerCase();
            
            let myAllocations = allAllocations.filter(allocation => allocation.hospitalId === currentUserId);
            
            filteredMyRequests = myAllocations.filter(allocation => {
                const statusMatch = status === 'all' || allocation.status === status;
                const searchMatch = !searchTerm || 
                    allocation.refnumber.toLowerCase().includes(searchTerm) ||
                    allocation.votenumber.toLowerCase().includes(searchTerm);
                
                return statusMatch && searchMatch;
            });
            
            myRequestsPage = 1;
            displayMyRequests();
            updateMyRequestsPagination();
        }

        function displayMyRequests() {
            const myRequestsTableBody = document.getElementById('myRequestsTableBody');
            const myRequestCount = document.getElementById('myRequestCount');
            myRequestsTableBody.innerHTML = '';
            
            if (filteredMyRequests.length === 0) {
                myRequestsTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No allocation requests found</td></tr>';
                myRequestCount.textContent = '0 requests';
                return;
            }

            const startIndex = (myRequestsPage - 1) * myRequestsItemsPerPage;
            const endIndex = Math.min(startIndex + myRequestsItemsPerPage, filteredMyRequests.length);
            const currentRequests = filteredMyRequests.slice(startIndex, endIndex);

            myRequestCount.textContent = `${filteredMyRequests.length} requests`;

            currentRequests.forEach(allocation => {
                const row = document.createElement('tr');
                row.className = 'enhanced-table-row';
                if (allocation.status === 'Pending') {
                    row.classList.add('highlighted-row');
                }

                const statusBadge = getEnhancedStatusBadge(allocation.status, true);
                
                row.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.prioritylevel}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="action-btn btn" onclick="viewMyAllocation(${allocation.id})">View</button>
                    </td>
                `;

                myRequestsTableBody.appendChild(row);
            });
        }

        function updateMyRequestsPagination() {
            const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
            document.getElementById('myRequestsPageInfo').textContent = `Page ${myRequestsPage} of ${totalPages}`;
            document.getElementById('myRequestsPrevPage').disabled = myRequestsPage === 1;
            document.getElementById('myRequestsNextPage').disabled = myRequestsPage === totalPages || totalPages === 0;
        }

        function goToMyRequestsPrevPage() {
            if (myRequestsPage > 1) {
                myRequestsPage--;
                displayMyRequests();
                updateMyRequestsPagination();
            }
        }

        function goToMyRequestsNextPage() {
            const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
            if (myRequestsPage < totalPages) {
                myRequestsPage++;
                displayMyRequests();
                updateMyRequestsPagination();
            }
        }

        // View Allocation for Hospital Users
        function viewMyAllocation(requestId) {
            currentRequestId = requestId;
            
            const allocation = filteredMyRequests.find(a => a.id == requestId);
            
            if (allocation) {
                document.getElementById('viewRefNumber').textContent = allocation.refnumber;
                document.getElementById('viewDate').textContent = formatDate(allocation.timestamp);
                document.getElementById('viewHospitalDetails').textContent = 
                    `${allocation.hospitalname}, ${allocation.contactperson}, ${allocation.contactphone}`;
                document.getElementById('viewVoteNumber').textContent = allocation.votenumber;
                document.getElementById('viewJobDescription').textContent = allocation.jobdescription;
                document.getElementById('viewRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
                document.getElementById('viewApprovedAmount').textContent = allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved';
                document.getElementById('viewPriority').textContent = allocation.prioritylevel;
                document.getElementById('viewRequiredDate').textContent = formatDate(allocation.requireddate);
                document.getElementById('viewAdditionalNotes').textContent = 
                    allocation.additionalnotes || 'No additional notes';
                document.getElementById('viewStatus').textContent = allocation.status;
                document.getElementById('viewApprovingAuthority').textContent = allocation.approvingauthority || 'Not specified';
                document.getElementById('viewApprovalNotes').textContent = allocation.approvalnotes || 'No approval notes';
                document.getElementById('viewRejectionReason').textContent = allocation.rejectionreason || 'Not rejected';
                
                // Show rejection reason highlight if rejected
                const rejectionHighlight = document.getElementById('viewRejectionHighlight');
                const rejectionReasonContent = document.getElementById('viewRejectionReasonContent');
                const resubmitSection = document.getElementById('viewResubmitSection');
                const approveAgainBtn = document.getElementById('approveAgainBtn');
                
                if (allocation.status === 'Rejected' && allocation.rejectionreason) {
                    rejectionHighlight.classList.remove('hidden');
                    rejectionReasonContent.textContent = allocation.rejectionreason;
                    resubmitSection.classList.remove('hidden');
                    approveAgainBtn.classList.add('hidden');
                } else {
                    rejectionHighlight.classList.add('hidden');
                    resubmitSection.classList.add('hidden');
                }
                
                updatePdfSignature(allocation);
                updateHospitalSignature(allocation);
                
                const downloadFinalPdfBtn = document.getElementById('downloadFinalPdf');
                if (allocation.status === 'Approved') {
                    downloadFinalPdfBtn.style.display = 'inline-block';
                    approveAgainBtn.classList.add('hidden');
                } else if (allocation.status === 'Rejected' && currentUserRole === 'admin') {
                    downloadFinalPdfBtn.style.display = 'none';
                    approveAgainBtn.classList.remove('hidden');
                } else {
                    downloadFinalPdfBtn.style.display = 'none';
                    approveAgainBtn.classList.add('hidden');
                }
                
                showElement(document.getElementById('viewModal'));
            } else {
                console.error('Allocation not found:', requestId);
                alert('Allocation details not found. Please try again.');
            }
        }

        // Update PDF signature based on approving authority
        function updatePdfSignature(allocation) {
            const ddgSignature = document.getElementById('ddgSignatureSection');
            const directorSignature = document.getElementById('directorSignatureSection');
            
            if (ddgSignature) ddgSignature.style.display = 'none';
            if (directorSignature) directorSignature.style.display = 'none';
            
            if (allocation.approvingauthority === 'Deputy Director General (Logistics)') {
                if (ddgSignature) ddgSignature.style.display = 'block';
            } else if (allocation.approvingauthority === 'Director Building (Administration)') {
                if (directorSignature) directorSignature.style.display = 'block';
            }
        }

        // Update hospital signature in view modal
        function updateHospitalSignature(allocation) {
            const signatory = hospitalSignatories[allocation.hospitalname] || {
                name: '[Hospital Director/Deputy Director General]',
                title: '[Position]',
                institution: allocation.hospitalname
            };
            
            document.getElementById('hospitalSignatureName').textContent = signatory.name;
            document.getElementById('hospitalSignatureTitle').textContent = signatory.title;
            document.getElementById('hospitalSignatureInstitution').textContent = signatory.institution;
        }

        // Hospital Allocation Status Functions
        async function updateUserAllocationStatus() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
                
                const approved = myAllocations.filter(a => a.status === 'Approved').length;
                const pending = myAllocations.filter(a => a.status === 'Pending').length;
                const rejected = myAllocations.filter(a => a.status === 'Rejected').length;
                
                document.getElementById('userApprovedCount').textContent = approved;
                document.getElementById('userPendingCount').textContent = pending;
                document.getElementById('userRejectedCount').textContent = rejected;
                document.getElementById('userTotalAllocations').textContent = myAllocations.length;
                
                filterUserAllocations(myAllocations);
            } catch (error) {
                console.error('Error loading user allocation data:', error);
            }
        }

        function filterUserAllocations(myAllocations) {
            const searchTerm = document.getElementById('searchUserAllocations').value.toLowerCase();
            
            const filtered = myAllocations.filter(allocation => {
                const searchMatch = !searchTerm || 
                    allocation.refnumber.toLowerCase().includes(searchTerm) ||
                    allocation.votenumber.toLowerCase().includes(searchTerm) ||
                    allocation.jobdescription.toLowerCase().includes(searchTerm);
                
                return searchMatch;
            });
            
            displayUserAllocations(filtered);
        }

        function displayUserAllocations(allocations) {
            const userAllocationsList = document.getElementById('userAllocationsList');
            userAllocationsList.innerHTML = '';
            
            if (allocations.length === 0) {
                userAllocationsList.innerHTML = '<tr><td colspan="6" class="text-center">No allocations found</td></tr>';
                return;
            }

            allocations.forEach(allocation => {
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                const statusBadge = getEnhancedStatusBadge(allocation.status, true);
                
                tr.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.prioritylevel}</td>
                    <td>${statusBadge}</td>
                `;
                userAllocationsList.appendChild(tr);
            });
        }

        // Hospital Allocation History Functions
        async function loadAllocationHistory() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
                
                populateVoteFilter(myAllocations);
                filterAllocationHistory(myAllocations);
            } catch (error) {
                console.error('Error loading allocation history:', error);
            }
        }

        function populateVoteFilter(allocations) {
            const voteFilter = document.getElementById('historyVoteFilter');
            voteFilter.innerHTML = '<option value="all">All Votes</option>';
            
            const uniqueVotes = [...new Set(allocations.map(allocation => allocation.votenumber).filter(Boolean))];
            
            uniqueVotes.forEach(vote => {
                const option = document.createElement('option');
                option.value = vote;
                option.textContent = vote;
                voteFilter.appendChild(option);
            });
        }

        function filterAllocationHistory(myAllocations) {
            const yearFilter = document.getElementById('historyYearFilter').value;
            const voteFilter = document.getElementById('historyVoteFilter').value;
            const statusFilter = document.getElementById('historyStatusFilter').value;
            
            let filteredHistory = myAllocations;
            
            if (yearFilter !== 'all') {
                filteredHistory = filteredHistory.filter(allocation => {
                    const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
                    return allocationYear === yearFilter;
                });
            }
            
            if (voteFilter !== 'all') {
                filteredHistory = filteredHistory.filter(allocation => allocation.votenumber === voteFilter);
            }
            
            if (statusFilter !== 'all') {
                filteredHistory = filteredHistory.filter(allocation => allocation.status === statusFilter);
            }
            
            filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            displayAllocationHistory(filteredHistory);
            updateHistorySummary(filteredHistory);
        }

        function displayAllocationHistory(allocations) {
            const historyTableBody = document.getElementById('historyTableBody');
            historyTableBody.innerHTML = '';
            
            if (allocations.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No historical allocation data found</td></tr>';
                return;
            }
            
            allocations.forEach(allocation => {
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                const statusBadge = getEnhancedStatusBadge(allocation.status, true);
                
                let approvalTime = 'N/A';
                if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
                    const submitDate = new Date(allocation.timestamp);
                    const approveDate = new Date(allocation.approvaldate);
                    const diffTime = Math.abs(approveDate - submitDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    approvalTime = `${diffDays} days`;
                }
                
                tr.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 40)}${allocation.jobdescription.length > 40 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(allocation.timestamp)}</td>
                    <td>${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}</td>
                    <td>${allocation.approvingauthority || 'N/A'}</td>
                    <td>
                        <button class="action-btn btn" onclick="viewMyAllocation(${allocation.id})">View</button>
                    </td>
                `;
                historyTableBody.appendChild(tr);
            });
        }

        function updateHistorySummary(allocations) {
            const totalRequests = allocations.length;
            const totalAmount = allocations.reduce((sum, allocation) => sum + parseFloat(allocation.requiredamount), 0);
            const approvedRequests = allocations.filter(a => a.status === 'Approved').length;
            const successRate = totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0;
            
            let totalApprovalDays = 0;
            let approvedCount = 0;
            
            allocations.forEach(allocation => {
                if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
                    const submitDate = new Date(allocation.timestamp);
                    const approveDate = new Date(allocation.approvaldate);
                    const diffTime = Math.abs(approveDate - submitDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    totalApprovalDays += diffDays;
                    approvedCount++;
                }
            });
            
            const avgApprovalTime = approvedCount > 0 ? Math.round(totalApprovalDays / approvedCount) : 0;
            
            document.getElementById('totalHistoricalRequests').textContent = totalRequests;
            document.getElementById('totalHistoricalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('avgApprovalTime').textContent = `${avgApprovalTime} days`;
            document.getElementById('successRate').textContent = `${successRate}%`;
        }

        // Vote Distribution Functions
        async function loadVoteDistribution() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
                
                const yearFilter = document.getElementById('distributionYearFilter').value;
                
                const filteredAllocations = myAllocations.filter(allocation => {
                    const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
                    return allocationYear === yearFilter;
                });
                
                calculateVoteDistribution(filteredAllocations);
            } catch (error) {
                console.error('Error loading vote distribution:', error);
            }
        }

        function calculateVoteDistribution(allocations) {
            const voteData = {};
            
            allocations.forEach(allocation => {
                const voteNumber = allocation.votenumber || 'Unknown';
                
                if (!voteData[voteNumber]) {
                    voteData[voteNumber] = {
                        totalRequests: 0,
                        approvedRequests: 0,
                        totalRequested: 0,
                        totalApproved: 0,
                        allocations: []
                    };
                }
                
                voteData[voteNumber].totalRequests++;
                voteData[voteNumber].totalRequested += parseFloat(allocation.requiredamount);
                
                if (allocation.status === 'Approved') {
                    voteData[voteNumber].approvedRequests++;
                    voteData[voteNumber].totalApproved += parseFloat(allocation.approvedamount || allocation.requiredamount);
                }
                
                voteData[voteNumber].allocations.push(allocation);
            });
            
            displayVoteDistribution(voteData);
            updateVoteDistributionChart(voteData);
        }

        function displayVoteDistribution(voteData) {
            const tableBody = document.getElementById('voteDistributionTableBody');
            tableBody.innerHTML = '';
            
            if (Object.keys(voteData).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No vote distribution data available</td></tr>';
                return;
            }
            
            Object.keys(voteData).forEach(voteNumber => {
                const data = voteData[voteNumber];
                const approvalRate = data.totalRequests > 0 ? Math.round((data.approvedRequests / data.totalRequests) * 100) : 0;
                const avgAmount = data.totalRequests > 0 ? data.totalRequested / data.totalRequests : 0;
                
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                tr.innerHTML = `
                    <td>${voteNumber}</td>
                    <td>${data.totalRequests}</td>
                    <td>${data.approvedRequests}</td>
                    <td>${formatCurrency(data.totalRequested)}</td>
                    <td>${formatCurrency(data.totalApproved)}</td>
                    <td>${approvalRate}%</td>
                    <td>${formatCurrency(avgAmount)}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function updateVoteDistributionChart(voteData) {
            const ctx = document.getElementById('voteDistributionChart').getContext('2d');
            
            if (window.voteDistributionChartInstance) {
                window.voteDistributionChartInstance.destroy();
            }
            
            const voteNumbers = Object.keys(voteData);
            const totalAmounts = voteNumbers.map(vote => voteData[vote].totalRequested);
            
            window.voteDistributionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: voteNumbers,
                    datasets: [{
                        label: 'Total Requested Amount (LKR)',
                        data: totalAmounts,
                        backgroundColor: 'rgba(26, 115, 232, 0.7)',
                        borderColor: 'rgba(26, 115, 232, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Total Approved Amount (LKR)',
                        data: voteNumbers.map(vote => voteData[vote].totalApproved),
                        backgroundColor: 'rgba(52, 168, 83, 0.7)',
                        borderColor: 'rgba(52, 168, 83, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (LKR)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Vote Number'
                            }
                        }
                    }
                }
            });
        }

        // Export vote distribution to Excel
        function exportVoteDistributionToExcel() {
            const yearFilter = document.getElementById('distributionYearFilter').value;
            const hospitalName = currentUserId || 'Hospital';
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Vote Number,Total Requests,Approved Requests,Total Requested,Total Approved,Approval Rate,Average Amount\n"
                + Array.from(document.querySelectorAll('#voteDistributionTableBody tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    return Array.from(cells).map(cell => `"${cell.textContent}"`).join(',');
                }).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `vote_distribution_${hospitalName}_${yearFilter}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            logSystemActivity('report', currentUserId, 'Vote Distribution Exported', `Year: ${yearFilter}`);
        }

        // Admin Functions
        async function loadAdminData() {
            const adminSpinner = document.getElementById('adminSpinner');
            showElement(adminSpinner);
            
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');

                allAllocations = allocationsResult.allocations || [];

                updateAdminStats();
                filterAllocations();
                updateAllocationStatusEnhanced();
                updatePendingAllocationNotification();
                
                populateHospitalFilter();
            } catch (error) {
                console.error('Error loading admin data:', error);
                document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="8" class="text-center">Error loading data</td></tr>';
            } finally {
                showElement(adminSpinner, false);
            }
        }

        // Populate hospital filter in reports
        function populateHospitalFilter() {
            const hospitalFilter = document.getElementById('hospitalFilter');
            if (!hospitalFilter) return;
            
            hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
            
            const uniqueHospitals = [...new Set(allAllocations.map(allocation => allocation.hospitalname).filter(Boolean))];
            
            uniqueHospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital;
                option.textContent = hospital;
                hospitalFilter.appendChild(option);
            });
        }

        function updateAdminStats() {
            document.getElementById('totalAllocations').textContent = allAllocations.length;
            document.getElementById('pendingAllocations').textContent = allAllocations.filter(a => a.status === 'Pending').length;
            document.getElementById('approvedAllocations').textContent = allAllocations.filter(a => a.status === 'Approved').length;
            
            const totalAllocated = allAllocations
                .filter(a => a.status === 'Approved')
                .reduce((sum, allocation) => sum + parseFloat(allocation.approvedamount), 0);
            document.getElementById('totalAllocatedAmount').textContent = formatCurrency(totalAllocated);
        }

        function filterAllocations() {
            const status = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchAllocations').value.toLowerCase();
            
            filteredAllocations = allAllocations.filter(allocation => {
                const statusMatch = status === 'all' || allocation.status === status;
                const searchMatch = !searchTerm || 
                    allocation.refnumber.toLowerCase().includes(searchTerm) ||
                    allocation.hospitalname.toLowerCase().includes(searchTerm) ||
                    allocation.votenumber.toLowerCase().includes(searchTerm);
                
                return statusMatch && searchMatch;
            });
            
            currentPage = 1;
            displayAllocations();
            updatePagination();
            updateAdminStats();
        }

        function displayAllocations() {
            const requestsTableBody = document.getElementById('requestsTableBody');
            const requestCount = document.getElementById('requestCount');
            requestsTableBody.innerHTML = '';
            
            if (filteredAllocations.length === 0) {
                requestsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No allocation requests found</td></tr>';
                requestCount.textContent = '0 requests';
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredAllocations.length);
            const currentAllocations = filteredAllocations.slice(startIndex, endIndex);

            requestCount.textContent = `${filteredAllocations.length} requests`;

            currentAllocations.forEach(allocation => {
                const row = document.createElement('tr');
                row.className = 'enhanced-table-row';
                if (allocation.status === 'Pending') {
                    row.classList.add('highlighted-row');
                }

                const statusBadge = getEnhancedStatusBadge(allocation.status, true);
                
                let actions = '';
                if (allocation.status === 'Pending') {
                    actions = `
                        <button class="action-btn btn" onclick="openApprovalModal(${allocation.id})">Approve</button>
                        <button class="action-btn btn btn-danger" onclick="openRejectionModal(${allocation.id})">Reject</button>
                        <button class="action-btn btn btn-secondary" onclick="authenticateAdmin('edit', ${allocation.id})">Edit</button>
                        <button class="action-btn btn btn-warning" onclick="viewHospitalHistory('${allocation.hospitalname}')">View Hospital History</button>
                        <button class="action-btn btn btn-danger" onclick="authenticateAdmin('delete', ${allocation.id})">Delete</button>
                    `;
                } else {
                    actions = `
                        <button class="action-btn btn" onclick="viewAllocation(${allocation.id})">View</button>
                        <button class="action-btn btn btn-secondary" onclick="authenticateAdmin('edit', ${allocation.id})">Edit</button>
                        <button class="action-btn btn btn-warning" onclick="viewHospitalHistory('${allocation.hospitalname}')">View Hospital History</button>
                    `;
                }

                row.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.hospitalname}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.prioritylevel}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                `;

                requestsTableBody.appendChild(row);
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredAllocations.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        }

        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayAllocations();
                updatePagination();
            }
        }

        function goToNextPage() {
            const totalPages = Math.ceil(filteredAllocations.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayAllocations();
                updatePagination();
            }
        }

        // View Hospital History
        function viewHospitalHistory(hospitalName) {
            const hospitalAllocations = allAllocations.filter(allocation => allocation.hospitalname === hospitalName);
            
            if (hospitalAllocations.length === 0) {
                alert(`No allocation history found for ${hospitalName}`);
                return;
            }
            
            document.getElementById('hospitalHistoryTitle').textContent = `Allocation History for ${hospitalName}`;
            
            const totalRequests = hospitalAllocations.length;
            const totalAmount = hospitalAllocations.reduce((sum, allocation) => sum + parseFloat(allocation.requiredamount), 0);
            const approvedCount = hospitalAllocations.filter(a => a.status === 'Approved').length;
            const approvalRate = totalRequests > 0 ? Math.round((approvedCount / totalRequests) * 100) : 0;
            
            document.getElementById('hospitalHistoryTotalRequests').textContent = totalRequests;
            document.getElementById('hospitalHistoryTotalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('hospitalHistoryApprovedCount').textContent = approvedCount;
            document.getElementById('hospitalHistoryApprovalRate').textContent = `${approvalRate}%`;
            
            const historyTableBody = document.getElementById('hospitalHistoryTableBody');
            historyTableBody.innerHTML = '';
            
            hospitalAllocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            hospitalAllocations.forEach(allocation => {
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                const statusBadge = getEnhancedStatusBadge(allocation.status, true);
                
                tr.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 40)}${allocation.jobdescription.length > 40 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(allocation.timestamp)}</td>
                    <td>${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}</td>
                    <td>
                        <button class="action-btn btn btn-sm" onclick="viewAllocation(${allocation.id})">View</button>
                    </td>
                `;
                historyTableBody.appendChild(tr);
            });
            
            showElement(document.getElementById('hospitalHistoryModal'));
        }

        // Enhanced Allocation Status Display
        function updateAllocationStatusEnhanced() {
            const pendingCount = allAllocations.filter(a => a.status === 'Pending').length;
            const approvedCount = allAllocations.filter(a => a.status === 'Approved').length;
            const rejectedCount = allAllocations.filter(a => a.status === 'Rejected').length;
            const completedCount = allAllocations.filter(a => a.status === 'Completed').length;
            
            const statusContainer = document.querySelector('.allocation-status-cards');
            if (statusContainer) {
                statusContainer.innerHTML = `
                    <div class="status-card-enhanced pending">
                        <div class="status-card-count-enhanced">${pendingCount}</div>
                        <div class="status-card-label-enhanced">Pending</div>
                        <div class="status-card-list" id="pendingAllocationsList"></div>
                    </div>
                    <div class="status-card-enhanced approved">
                        <div class="status-card-count-enhanced">${approvedCount}</div>
                        <div class="status-card-label-enhanced">Approved</div>
                        <div class="status-card-list" id="approvedAllocationsList"></div>
                    </div>
                    <div class="status-card-enhanced rejected">
                        <div class="status-card-count-enhanced">${rejectedCount}</div>
                        <div class="status-card-label-enhanced">Rejected</div>
                        <div class="status-card-list" id="rejectedAllocationsList"></div>
                    </div>
                    <div class="status-card-enhanced completed">
                        <div class="status-card-count-enhanced">${completedCount}</div>
                        <div class="status-card-label-enhanced">Completed</div>
                        <div class="status-card-list" id="completedAllocationsList"></div>
                    </div>
                `;
            }
            
            const pendingList = document.getElementById('pendingAllocationsList');
            const approvedList = document.getElementById('approvedAllocationsList');
            const rejectedList = document.getElementById('rejectedAllocationsList');
            const completedList = document.getElementById('completedAllocationsList');
            
            pendingList.innerHTML = '';
            approvedList.innerHTML = '';
            rejectedList.innerHTML = '';
            completedList.innerHTML = '';
            
            allAllocations.forEach(allocation => {
                const div = document.createElement('div');
                div.className = 'selection-item';
                const statusBadge = getEnhancedStatusBadge(allocation.status, false);
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${allocation.refnumber}</strong><br>
                            <small style="color: #666;">${allocation.hospitalname}</small>
                        </div>
                        ${statusBadge}
                    </div>
                    <div style="margin-top: 8px; color: #666; font-size: 0.9em;">
                        ${allocation.votenumber} - ${formatCurrency(allocation.requiredamount)}
                    </div>
                    <div style="margin-top: 5px;">
                        <button class="btn btn-sm" onclick="viewAllocation(${allocation.id})" style="padding: 3px 8px; font-size: 11px;">View</button>
                    </div>
                `;
                
                if (allocation.status === 'Pending') {
                    pendingList.appendChild(div);
                } else if (allocation.status === 'Approved') {
                    approvedList.appendChild(div);
                } else if (allocation.status === 'Rejected') {
                    rejectedList.appendChild(div);
                } else if (allocation.status === 'Completed') {
                    completedList.appendChild(div);
                }
            });
        }

        // Enhanced Logging Section with Hospital Search
        function enhanceLoggingSection() {
            const adminControls = document.querySelector('#logsTab .admin-controls');
            if (adminControls) {
                const hospitalFilterHTML = `
                    <div class="filter-control">
                        <label class="form-label" for="logHospitalFilter">Filter by Hospital</label>
                        <select id="logHospitalFilter" class="form-control">
                            <option value="all">All Hospitals</option>
                        </select>
                    </div>
                `;
                
                const userFilter = adminControls.querySelector('#userFilter').parentElement;
                userFilter.insertAdjacentHTML('afterend', hospitalFilterHTML);
                
                populateLogHospitalFilter();
            }
        }

        function populateLogHospitalFilter() {
            const hospitalFilter = document.getElementById('logHospitalFilter');
            if (!hospitalFilter) return;
            
            hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
            
            const uniqueHospitals = [...new Set(allAllocations.map(allocation => allocation.hospitalname).filter(Boolean))];
            
            uniqueHospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital;
                option.textContent = hospital;
                hospitalFilter.appendChild(option);
            });
        }

        function openApprovalModal(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);

            if (allocation) {
                document.getElementById('approvalRefNumber').textContent = allocation.refnumber;
                document.getElementById('approvalHospital').textContent = allocation.hospitalname;
                document.getElementById('approvalVoteNumber').textContent = allocation.votenumber;
                document.getElementById('approvalJobDescription').textContent = allocation.jobdescription;
                document.getElementById('approvalRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
                document.getElementById('approvalPriority').textContent = allocation.prioritylevel;
                
                // ADDED: Populate Additional Notes
                const additionalNotesElement = document.getElementById('approvalAdditionalNotes');
                if (allocation.additionalnotes && allocation.additionalnotes.trim() !== '') {
                    additionalNotesElement.textContent = allocation.additionalnotes;
                } else {
                    additionalNotesElement.textContent = 'No additional notes provided.';
                    additionalNotesElement.style.color = '#999';
                    additionalNotesElement.style.fontStyle = 'italic';
                }
                
                document.getElementById('approvedAmount').value = allocation.requiredamount;
                document.getElementById('approvalNotes').value = '';
                document.getElementById('approvingAuthority').value = '';
                document.getElementById('uniquePassword').value = allocation.uniquepassword || '';

                showElement(document.getElementById('approvalModal'));
            }
        }

        function openRejectionModal(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);

            if (allocation) {
                document.getElementById('rejectionRefNumber').textContent = allocation.refnumber;
                document.getElementById('rejectionHospital').textContent = allocation.hospitalname;
                document.getElementById('rejectionVoteNumber').textContent = allocation.votenumber;
                document.getElementById('rejectionRequestedAmount').textContent = formatCurrency(allocation.requiredamount);

                document.getElementById('rejectionPassword').value = allocation.uniquepassword || '';
                document.getElementById('rejectionReason').value = '';

                showElement(document.getElementById('rejectionModal'));
            }
        }

        async function approveAllocation() {
            const uniquePassword = document.getElementById('uniquePassword').value.trim();
            const approvedAmount = document.getElementById('approvedAmount').value.trim();
            const approvalNotes = document.getElementById('approvalNotes').value.trim();
            const approvingAuthority = document.getElementById('approvingAuthority').value;
            
            if (!uniquePassword) {
                alert('Please enter the request password');
                return;
            }
            
            if (!approvedAmount) {
                alert('Please enter the approved amount');
                return;
            }
            
            if (!approvingAuthority) {
                alert('Please select the approving authority');
                return;
            }
            
            const confirmApprovalBtn = document.getElementById('confirmApproval');
            confirmApprovalBtn.disabled = true;
            
            try {
                const result = await callGoogleAppsScript('approveAllocation', {
                    requestId: currentRequestId,
                    approvedAmount: approvedAmount,
                    approvalNotes: approvalNotes,
                    approvingAuthority: approvingAuthority,
                    uniquePassword: uniquePassword
                });
                
                if (result.success) {
                    alert('Allocation approved successfully');
                    hideModal('approvalModal');
                    loadAdminData();
                    loadAdminAllocationHistory();
                    loadAdminVoteDistribution();
                    loadHospitalSummary();
                } else {
                    alert('Approval failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Approval failed. Please try again.');
            } finally {
                confirmApprovalBtn.disabled = false;
            }
        }

        async function rejectAllocation() {
            const uniquePassword = document.getElementById('rejectionPassword').value.trim();
            const rejectionReason = document.getElementById('rejectionReason').value.trim();

            if (!uniquePassword) {
                alert('Please enter the request password');
                return;
            }

            if (!rejectionReason) {
                alert('Please provide a rejection reason');
                return;
            }

            const confirmRejectionBtn = document.getElementById('confirmRejection');
            confirmRejectionBtn.disabled = true;

            try {
                const result = await callGoogleAppsScript('rejectAllocation', {
                    requestId: currentRequestId,
                    rejectionReason: rejectionReason,
                    uniquePassword: uniquePassword
                });

                if (result.success) {
                    alert('Allocation rejected successfully');
                    hideModal('rejectionModal');
                    loadAdminData();
                    loadAdminAllocationHistory();
                    loadAdminVoteDistribution();
                    loadHospitalSummary();
                } else {
                    alert('Rejection failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Rejection failed. Please try again.');
            } finally {
                confirmRejectionBtn.disabled = false;
            }
        }

        function openEditModal(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);
            
            if (allocation) {
                document.getElementById('editHospitalName').value = allocation.hospitalname || '';
                document.getElementById('editContactPerson').value = allocation.contactperson || '';
                document.getElementById('editContactPhone').value = allocation.contactphone || '';
                document.getElementById('editContactEmail').value = allocation.contactemail || '';
                document.getElementById('editVoteNumber').value = allocation.votenumber || '';
                document.getElementById('editJobDescription').value = allocation.jobdescription || '';
                document.getElementById('editRequiredAmount').value = allocation.requiredamount || '';
                document.getElementById('editPriorityLevel').value = allocation.prioritylevel || '';
                document.getElementById('editRequiredDate').value = allocation.requireddate ? allocation.requireddate.substring(0, 10) : '';
                document.getElementById('editAdditionalNotes').value = allocation.additionalnotes || '';
                
                showElement(document.getElementById('editModal'));
            }
        }

        // View Allocation for Admin
        function viewAllocation(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);
            
            if (allocation) {
                document.getElementById('viewRefNumber').textContent = allocation.refnumber;
                document.getElementById('viewDate').textContent = formatDate(allocation.timestamp);
                document.getElementById('viewHospitalDetails').textContent = 
                    `${allocation.hospitalname}, ${allocation.contactperson}, ${allocation.contactphone}`;
                document.getElementById('viewVoteNumber').textContent = allocation.votenumber;
                document.getElementById('viewJobDescription').textContent = allocation.jobdescription;
                document.getElementById('viewRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
                document.getElementById('viewApprovedAmount').textContent = allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved';
                document.getElementById('viewPriority').textContent = allocation.prioritylevel;
                document.getElementById('viewRequiredDate').textContent = formatDate(allocation.requireddate);
                document.getElementById('viewAdditionalNotes').textContent = 
                    allocation.additionalnotes || 'No additional notes';
                document.getElementById('viewStatus').textContent = allocation.status;
                document.getElementById('viewApprovingAuthority').textContent = allocation.approvingauthority || 'Not specified';
                document.getElementById('viewApprovalNotes').textContent = allocation.approvalnotes || 'No approval notes';
                document.getElementById('viewRejectionReason').textContent = allocation.rejectionreason || 'Not rejected';
                
                // Show rejection reason highlight if rejected
                const rejectionHighlight = document.getElementById('viewRejectionHighlight');
                const rejectionReasonContent = document.getElementById('viewRejectionReasonContent');
                const resubmitSection = document.getElementById('viewResubmitSection');
                const approveAgainBtn = document.getElementById('approveAgainBtn');
                
                if (allocation.status === 'Rejected' && allocation.rejectionreason) {
                    rejectionHighlight.classList.remove('hidden');
                    rejectionReasonContent.textContent = allocation.rejectionreason;
                    resubmitSection.classList.remove('hidden');
                    approveAgainBtn.classList.add('hidden');
                } else {
                    rejectionHighlight.classList.add('hidden');
                    resubmitSection.classList.add('hidden');
                }
                
                updatePdfSignature(allocation);
                updateHospitalSignature(allocation);
                
                const downloadFinalPdfBtn = document.getElementById('downloadFinalPdf');
                if (allocation.status === 'Approved') {
                    downloadFinalPdfBtn.style.display = 'inline-block';
                    approveAgainBtn.classList.add('hidden');
                } else if (allocation.status === 'Rejected') {
                    downloadFinalPdfBtn.style.display = 'none';
                    approveAgainBtn.classList.remove('hidden');
                } else {
                    downloadFinalPdfBtn.style.display = 'none';
                    approveAgainBtn.classList.add('hidden');
                }
                
                showElement(document.getElementById('viewModal'));
            }
        }

        async function saveEdit() {
            const confirmEditBtn = document.getElementById('confirmEdit');
            confirmEditBtn.disabled = true;
            
            try {
                const result = await callGoogleAppsScript('editAllocation', {
                    requestId: currentRequestId,
                    hospitalName: document.getElementById('editHospitalName').value.trim(),
                    contactPerson: document.getElementById('editContactPerson').value.trim(),
                    contactPhone: document.getElementById('editContactPhone').value.trim(),
                    contactEmail: document.getElementById('editContactEmail').value.trim(),
                    voteNumber: document.getElementById('editVoteNumber').value,
                    jobDescription: document.getElementById('editJobDescription').value.trim(),
                    requiredAmount: document.getElementById('editRequiredAmount').value,
                    priorityLevel: document.getElementById('editPriorityLevel').value,
                    requiredDate: document.getElementById('editRequiredDate').value,
                    additionalNotes: document.getElementById('editAdditionalNotes').value.trim()
                });
                
                if (result.success) {
                    alert('Allocation updated successfully');
                    hideModal('editModal');
                    loadAdminData();
                    loadAdminAllocationHistory();
                    loadAdminVoteDistribution();
                    loadHospitalSummary();
                } else {
                    alert('Update failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Update failed. Please try again.');
            } finally {
                confirmEditBtn.disabled = false;
            }
        }

        async function deleteAllocation(requestId) {
            if (!confirm('Are you sure you want to delete this allocation?')) {
                return;
            }
            
            try {
                const result = await callGoogleAppsScript('deleteAllocation', { requestId: requestId });
                
                if (result.success) {
                    alert('Allocation deleted successfully');
                    loadAdminData();
                    loadAdminAllocationHistory();
                    loadAdminVoteDistribution();
                    loadHospitalSummary();
                } else {
                    alert('Delete failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Delete failed. Please try again.');
            }
        }

        function hideModal(modalId) {
            showElement(document.getElementById(modalId), false);
        }

        // Enhanced Logging Functions with Hospital Search
        function filterLogs() {
            const typeFilter = document.getElementById('logTypeFilter').value;
            const userFilter = document.getElementById('userFilter').value;
            const hospitalFilter = document.getElementById('logHospitalFilter') ? document.getElementById('logHospitalFilter').value : 'all';
            const searchTerm = document.getElementById('searchLogs').value.toLowerCase();
            
            filteredLogs = systemLogs.filter(log => {
                const typeMatch = typeFilter === 'all' || log.type === typeFilter;
                const userMatch = userFilter === 'all' || log.user === userFilter;
                const searchMatch = !searchTerm || 
                    log.user.toLowerCase().includes(searchTerm) ||
                    log.action.toLowerCase().includes(searchTerm) ||
                    log.details.toLowerCase().includes(searchTerm);
                
                let hospitalMatch = true;
                if (hospitalFilter !== 'all') {
                    hospitalMatch = log.details.toLowerCase().includes(hospitalFilter.toLowerCase());
                }
                
                return typeMatch && userMatch && searchMatch && hospitalMatch;
            });
            
            logsPage = 1;
            displayLogs();
            updateLogsPagination();
        }

        function displayLogs() {
            const systemLogsTable = document.getElementById('systemLogsTable');
            systemLogsTable.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                systemLogsTable.innerHTML = '<tr><td colspan="5" class="text-center">No logs found</td></tr>';
                return;
            }

            const startIndex = (logsPage - 1) * logsItemsPerPage;
            const endIndex = Math.min(startIndex + logsItemsPerPage, filteredLogs.length);
            const currentLogs = filteredLogs.slice(startIndex, endIndex);

            currentLogs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                const typeClass = `status-${log.type.toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>${formatDateTime(log.timestamp)}</td>
                    <td><span class="status-badge ${typeClass}">${log.type}</span></td>
                    <td>${log.user}</td>
                    <td>${log.action}</td>
                    <td>${log.details}</td>
                `;
                systemLogsTable.appendChild(tr);
            });
        }

        function updateLogsPagination() {
            const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
            document.getElementById('logsPageInfo').textContent = `Page ${logsPage} of ${totalPages}`;
            document.getElementById('logsPrevPage').disabled = logsPage === 1;
            document.getElementById('logsNextPage').disabled = logsPage === totalPages || totalPages === 0;
        }

        function goToLogsPrevPage() {
            if (logsPage > 1) {
                logsPage--;
                displayLogs();
                updateLogsPagination();
            }
        }

        function goToLogsNextPage() {
            const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
            if (logsPage < totalPages) {
                logsPage++;
                displayLogs();
                updateLogsPagination();
            }
        }

        function exportLogs() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Timestamp,Type,User,Action,Details\n"
                + filteredLogs.map(log => 
                    `"${formatDateTime(log.timestamp)}","${log.type}","${log.user}","${log.action}","${log.details}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "system_logs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Enhanced A4 PDF Generation Functions
        function generateProfessionalPDF(isFinal = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            
            let yPosition = margin;
            let currentPage = 1;
            
            // ========== HEADER ==========
            addHeader(doc, pageWidth, isFinal);
            yPosition = 45;
            
            // ========== DOCUMENT CONTENT ==========
            let allocation;
            if (isFinal) {
                if (currentUserRole === 'hospital') {
                    allocation = filteredMyRequests.find(a => a.id == currentRequestId);
                } else {
                    allocation = allAllocations.find(a => a.id === currentRequestId);
                }
            } else {
                // Get data from preview
                allocation = {
                    refnumber: document.getElementById('enhancedPdfRefNumber').textContent,
                    hospitalname: document.getElementById('enhancedPdfHospitalDetails').textContent.split(', ')[0],
                    contactperson: document.getElementById('enhancedPdfHospitalDetails').textContent.split(', ')[1],
                    contactphone: document.getElementById('enhancedPdfHospitalDetails').textContent.split(', ')[2],
                    votenumber: document.getElementById('enhancedPdfVoteNumber').textContent,
                    jobdescription: document.getElementById('enhancedPdfJobDescription').textContent,
                    requiredamount: document.getElementById('enhancedPdfAmount').textContent.replace('LKR ', '').replace(/,/g, ''),
                    prioritylevel: document.getElementById('enhancedPdfPriority').textContent,
                    requireddate: document.getElementById('enhancedPdfRequiredDate').textContent,
                    additionalnotes: document.getElementById('enhancedPdfAdditionalNotes').textContent,
                    timestamp: new Date().toISOString(),
                    uniquepassword: document.getElementById('enhancedPdfPassword').textContent
                };
            }
            
            if (!allocation) {
                console.error('Allocation data not found');
                return;
            }
            
            if (isFinal) {
                yPosition = addFinalApprovalContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight);
            } else {
                yPosition = addRequestContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight);
            }
            
            // ========== SIGNATURES ==========
            yPosition = addSignatures(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight, isFinal);
            
            // ========== FOOTER WITH QR CODE ==========
            addFooterWithQRCode(doc, pageWidth, pageHeight, margin, isFinal, allocation);
            
            // ========== ADD PAGE NUMBERS ==========
            addPageNumbers(doc, pageWidth, pageHeight);
            
            const fileName = isFinal ? 
                `Allocation_Approval_${allocation?.refnumber || currentRequestRef}.pdf` : 
                `Allocation_Request_${allocation?.refnumber || currentRequestRef}.pdf`;
            
            doc.save(fileName);
            
            logSystemActivity('system', currentUserRole, 'PDF Downloaded', 
                isFinal ? `Final approval for ${allocation?.refnumber || currentRequestRef}` : 
                          `Request preview for ${allocation?.refnumber || currentRequestRef}`);
        }

        function addHeader(doc, pageWidth, isFinal) {
            // Government Header
            doc.setFillColor(26, 115, 232);
            doc.rect(0, 0, pageWidth, 25, 'F');
            
            // Ministry Logo/Text
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text("MINISTRY OF HEALTH", pageWidth / 2, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Government of Sri Lanka", pageWidth / 2, 22, { align: 'center' });
            
            // Document Type Box
            doc.setDrawColor(26, 115, 232);
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, 30, pageWidth - 40, 15, 3, 3, 'F');
            
            doc.setTextColor(26, 115, 232);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            const title = isFinal ? "ALLOCATION APPROVAL CERTIFICATE" : "ALLOCATION REQUEST FORM";
            doc.text(title, pageWidth / 2, 40, { align: 'center' });
        }

        function addRequestContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight) {
            // Document Border
            doc.setDrawColor(200, 200, 200);
            doc.roundedRect(margin, yPosition, contentWidth, pageHeight - 100, 3, 3, 'S');
            
            yPosition += 10;
            doc.setFillColor(245, 245, 245);
            doc.roundedRect(margin + 5, yPosition, contentWidth - 10, 15, 2, 2, 'F');
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text(`REFERENCE: ${allocation.refnumber || ''}`, margin + 10, yPosition + 10);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            const dateStr = allocation.timestamp ? new Date(allocation.timestamp).toLocaleDateString('en-GB') : new Date().toLocaleDateString('en-GB');
            doc.text(`Date: ${dateStr}`, pageWidth - margin - 50, yPosition + 10);
            
            yPosition += 25;
            
            // 1. HOSPITAL INFORMATION
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(26, 115, 232);
            doc.text("1. HOSPITAL INFORMATION", margin + 5, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            const hospitalData = [
                ['Hospital Name:', allocation.hospitalname || ''],
                ['Contact Person:', allocation.contactperson || ''],
                ['Contact Phone:', allocation.contactphone || ''],
                ['Vote Number:', allocation.votenumber || '']
            ];
            
            hospitalData.forEach(([label, value]) => {
                if (yPosition > pageHeight - 50) {
                    doc.addPage();
                    yPosition = margin;
                    doc.setFontSize(10);
                }
                
                doc.text(label.toString(), margin + 10, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(value.toString(), margin + 40, yPosition);
                doc.setFont('helvetica', 'normal');
                yPosition += 7;
            });
            
            yPosition += 10;
            
            // 2. ALLOCATION DETAILS
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(26, 115, 232);
            doc.text("2. ALLOCATION DETAILS", margin + 5, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            // Format amount properly
            const amount = allocation.requiredamount ? 
                parseFloat(allocation.requiredamount.toString().replace(/[^0-9.-]+/g, "")).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) : '0.00';
            
            const allocationData = [
                ['Job Description:', allocation.jobdescription || ''],
                ['Required Amount:', `LKR ${amount}`],
                ['Priority Level:', allocation.prioritylevel || ''],
                ['Required Date:', allocation.requireddate ? new Date(allocation.requireddate).toLocaleDateString('en-GB') : ''],
                ['Additional Notes:', allocation.additionalnotes || 'None']
            ];
            
            allocationData.forEach(([label, value]) => {
                if (yPosition > pageHeight - 50) {
                    doc.addPage();
                    yPosition = margin;
                    doc.setFontSize(10);
                }
                
                doc.text(label.toString(), margin + 10, yPosition);
                
                if (label === 'Job Description:' || label === 'Additional Notes:') {
                    const lines = doc.splitTextToSize(value.toString(), contentWidth - 50);
                    lines.forEach((line, index) => {
                        if (index === 0) {
                            doc.setFont('helvetica', 'bold');
                            doc.text(line, margin + 40, yPosition);
                            doc.setFont('helvetica', 'normal');
                        } else {
                            doc.text(line, margin + 40, yPosition + (index * 5));
                        }
                    });
                    yPosition += Math.max(lines.length * 5, 7);
                } else {
                    doc.setFont('helvetica', 'bold');
                    doc.text(value.toString(), margin + 40, yPosition);
                    doc.setFont('helvetica', 'normal');
                    yPosition += 7;
                }
            });
            
            yPosition += 10;
            
            // 3. IMPORTANT INSTRUCTIONS
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(26, 115, 232);
            doc.text("3. IMPORTANT INSTRUCTIONS", margin + 5, yPosition);
            
            yPosition += 10;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            const instructions = [
            "I. Action shall be taken strictly in accordance with the Government Financial Regulations (GFR), Establishments Code, GFR 135 on Delegation of Authority, and all other applicable laws and regulations.",
            "II. The relevant works shall be executed only after obtaining approval from your Hospital's Regional Procurement Committee.",
            "III. The availability of adequate cash flow shall be confirmed prior to entering into any financial commitments.",
            "IV. Commencement of any work without the necessary financial provisions shall be strictly avoided.",
            "V. The provisions granted under this letter shall remain valid until 31.12.2026.",
            "VI. Monthly expenditure reports shall be submitted on or before the 10th day of the following month to the email address ddglogisticsmoh@gmail.com.",
            "VII. This is an electronically generated PDF and does not require a physical signature."
        ];
            
            instructions.forEach((instruction, index) => {
                if (yPosition > pageHeight - 50) {
                    doc.addPage();
                    yPosition = margin;
                    doc.setFontSize(9);
                }
                
                const lines = doc.splitTextToSize(`${String.fromCharCode(97 + index)}. ${instruction}`, contentWidth - 20);
                lines.forEach((line, lineIndex) => {
                    doc.text(line, margin + 10, yPosition);
                    yPosition += 5;
                });
                yPosition += 2;
            });
            
            return yPosition;
        }

        function addFinalApprovalContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight) {
            // Approval Header
            doc.setFillColor(52, 168, 83);
            doc.roundedRect(margin, yPosition, contentWidth, 20, 3, 3, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text("APPROVAL CERTIFICATE", pageWidth / 2, yPosition + 12, { align: 'center' });
            
            yPosition += 30;
            
            // Approval Details
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            
            const approvalDate = allocation.approvaldate ? new Date(allocation.approvaldate).toLocaleDateString('en-GB') : 'N/A';
            
            const approvalDetails = [
                ['Reference Number:', allocation.refnumber || ''],
                ['Approval Date:', approvalDate],
                ['Approving Authority:', allocation.approvingauthority || 'N/A'],
                ['Status:', allocation.status || '']
            ];
            
            approvalDetails.forEach(([label, value]) => {
                doc.text(label.toString(), margin + 10, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(value.toString(), margin + 50, yPosition);
                doc.setFont('helvetica', 'normal');
                yPosition += 8;
            });
            
            // Add approved amount if available
            if (allocation.approvedamount) {
                const approvedAmount = parseFloat(allocation.approvedamount).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                doc.text('Approved Amount:', margin + 10, yPosition);
                doc.setFont('helvetica', 'bold');
                doc.text(`LKR ${approvedAmount}`, margin + 50, yPosition);
                doc.setFont('helvetica', 'normal');
                yPosition += 8;
            }
            
            yPosition += 10;
            
            // Continue with regular content
            return addRequestContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight);
        }

        function addSignatures(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight, isFinal) {
            if (yPosition > pageHeight - 80) {
                doc.addPage();
                yPosition = margin;
            }
            
            // Hospital Signature
            const signatory = hospitalSignatories[allocation.hospitalname] || {
                name: '[Hospital Director/Deputy Director General]',
                title: '[Position]',
                institution: allocation.hospitalname || ''
            };
            
            // Left side - Hospital Signature
            doc.setDrawColor(0, 0, 0);
            doc.line(margin + 20, yPosition, margin + 100, yPosition);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("Hospital Authorization:", margin + 20, yPosition + 10);
            
            doc.setFont('helvetica', 'normal');
            doc.text(signatory.name, margin + 20, yPosition + 17);
            
            doc.setFontSize(9);
            doc.text(signatory.title, margin + 20, yPosition + 22);
            doc.text(signatory.institution, margin + 20, yPosition + 27);
            
            yPosition += 40;
            
            if (isFinal && allocation.status === 'Approved') {
                // Right side - Approval Signature
                doc.setDrawColor(0, 0, 0);
                doc.line(pageWidth - margin - 100, yPosition - 40, pageWidth - margin - 20, yPosition - 40);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text("Approval Signature:", pageWidth - margin - 100, yPosition - 30);
                
                doc.setFont('helvetica', 'normal');
                
                if (allocation.approvingauthority === 'Deputy Director General (Logistics)') {
                    doc.text("H.M.N Dinipriya Herath", pageWidth - margin - 100, yPosition - 23);
                    doc.setFontSize(9);
                    doc.text("Deputy Director General (Logistics)", pageWidth - margin - 100, yPosition - 18);
                    doc.text("For Secretary", pageWidth - margin - 100, yPosition - 13);
                } else if (allocation.approvingauthority === 'Director Building (Administration)') {
                    doc.text("Director Building Branch", pageWidth - margin - 100, yPosition - 23);
                    doc.setFontSize(9);
                    doc.text("Director Building Branch (Administration)", pageWidth - margin - 100, yPosition - 18);
                }
            }
            
            return yPosition + 20;
        }

        function addFooterWithQRCode(doc, pageWidth, pageHeight, margin, isFinal, allocation) {
            const footerY = pageHeight - 30;
            
            // Footer text
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("Official Document - Ministry of Health, Sri Lanka", pageWidth / 2, footerY, { align: 'center' });
            doc.text("This is a system generated document", pageWidth / 2, footerY + 5, { align: 'center' });
            
            // QR Code (optional - can be commented out if causing issues)
            try {
                const qrText = isFinal ? 
                    `Approval: ${allocation?.refnumber || ''}\nDate: ${allocation?.approvaldate ? new Date(allocation.approvaldate).toLocaleDateString('en-GB') : ''}\nAmount: LKR ${allocation?.approvedamount || allocation?.requiredamount || ''}` :
                    `Request: ${allocation?.refnumber || ''}\nHospital: ${allocation?.hospitalname || ''}\nDate: ${allocation?.timestamp ? new Date(allocation.timestamp).toLocaleDateString('en-GB') : ''}`;
                
                const qrcode = qrcode(0, 'L');
                qrcode.addData(qrText);
                qrcode.make();
                const qrDataURL = qrcode.createDataURL(4, 0);
                
                doc.addImage(qrDataURL, 'PNG', pageWidth - margin - 30, footerY - 25, 25, 25);
            } catch (e) {
                console.log('QR Code skipped:', e.message);
            }
        }

        function addPageNumbers(doc, pageWidth, pageHeight) {
            const totalPages = doc.internal.getNumberOfPages();
            
            for(let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
            }
        }

        // Update the download PDF button event listeners
        document.getElementById('downloadPdf')?.addEventListener('click', function() {
            generateProfessionalPDF(false);
        });

        document.getElementById('downloadFinalPdf')?.addEventListener('click', function() {
            generateProfessionalPDF(true);
        });

        // Admin Allocation History Functions
        async function loadAdminAllocationHistory() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const allAllocationsData = allocationsResult.allocations || [];
                
                populateAdminHistoryHospitalFilter(allAllocationsData);
                filterAdminAllocationHistory(allAllocationsData);
            } catch (error) {
                console.error('Error loading admin allocation history:', error);
            }
        }

        function populateAdminHistoryHospitalFilter(allocations) {
            const hospitalFilter = document.getElementById('adminHistoryHospitalFilter');
            if (!hospitalFilter) return;
            
            hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
            
            const uniqueHospitals = [...new Set(allocations.map(allocation => allocation.hospitalname).filter(Boolean))];
            
            uniqueHospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital;
                option.textContent = hospital;
                hospitalFilter.appendChild(option);
            });
        }

        function filterAdminAllocationHistory(allocations) {
            const yearFilter = document.getElementById('adminHistoryYearFilter').value;
            const hospitalFilter = document.getElementById('adminHistoryHospitalFilter').value;
            const statusFilter = document.getElementById('adminHistoryStatusFilter').value;
            
            let filteredHistory = allocations;
            
            if (yearFilter !== 'all') {
                filteredHistory = filteredHistory.filter(allocation => {
                    const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
                    return allocationYear === yearFilter;
                });
            }
            
            if (hospitalFilter !== 'all') {
                filteredHistory = filteredHistory.filter(allocation => allocation.hospitalname === hospitalFilter);
            }
            
            if (statusFilter !== 'all') {
                filteredHistory = filteredHistory.filter(allocation => allocation.status === statusFilter);
            }
            
            filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            displayAdminAllocationHistory(filteredHistory);
            updateAdminHistorySummary(filteredHistory);
        }

        function displayAdminAllocationHistory(allocations) {
            const historyTableBody = document.getElementById('adminHistoryTableBody');
            historyTableBody.innerHTML = '';
            
            if (allocations.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="11" class="text-center">No historical allocation data found</td></tr>';
                return;
            }
            
            allocations.forEach(allocation => {
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                const statusBadge = getEnhancedStatusBadge(allocation.status, true);
                
                let approvalTime = 'N/A';
                if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
                    const submitDate = new Date(allocation.timestamp);
                    const approveDate = new Date(allocation.approvaldate);
                    const diffTime = Math.abs(approveDate - submitDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    approvalTime = `${diffDays} days`;
                }
                
                tr.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.hospitalname}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 40)}${allocation.jobdescription.length > 40 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(allocation.timestamp)}</td>
                    <td>${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}</td>
                    <td>${allocation.approvingauthority || 'N/A'}</td>
                    <td>
                        <button class="action-btn btn" onclick="viewAllocation(${allocation.id})">View</button>
                        <button class="action-btn btn btn-warning" onclick="viewHospitalHistory('${allocation.hospitalname}')">Hospital History</button>
                    </td>
                `;
                historyTableBody.appendChild(tr);
            });
        }

        function updateAdminHistorySummary(allocations) {
            const totalRequests = allocations.length;
            const totalAmount = allocations.reduce((sum, allocation) => sum + parseFloat(allocation.requiredamount), 0);
            const approvedRequests = allocations.filter(a => a.status === 'Approved').length;
            const successRate = totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0;
            
            let totalApprovalDays = 0;
            let approvedCount = 0;
            
            allocations.forEach(allocation => {
                if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
                    const submitDate = new Date(allocation.timestamp);
                    const approveDate = new Date(allocation.approvaldate);
                    const diffTime = Math.abs(approveDate - submitDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    totalApprovalDays += diffDays;
                    approvedCount++;
                }
            });
            
            const avgApprovalTime = approvedCount > 0 ? Math.round(totalApprovalDays / approvedCount) : 0;
            
            document.getElementById('adminTotalHistoricalRequests').textContent = totalRequests;
            document.getElementById('adminTotalHistoricalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('adminAvgApprovalTime').textContent = `${avgApprovalTime} days`;
            document.getElementById('adminSuccessRate').textContent = `${successRate}%`;
        }

        // Admin Vote Distribution Functions
        async function loadAdminVoteDistribution() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const allAllocationsData = allocationsResult.allocations || [];
                
                const yearFilter = document.getElementById('adminDistributionYearFilter').value;
                
                const filteredAllocations = allAllocationsData.filter(allocation => {
                    const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
                    return allocationYear === yearFilter;
                });
                
                calculateAdminVoteDistribution(filteredAllocations);
            } catch (error) {
                console.error('Error loading admin vote distribution:', error);
            }
        }

        function calculateAdminVoteDistribution(allocations) {
            const voteData = {};
            
            allocations.forEach(allocation => {
                const voteNumber = allocation.votenumber || 'Unknown';
                
                if (!voteData[voteNumber]) {
                    voteData[voteNumber] = {
                        totalRequests: 0,
                        approvedRequests: 0,
                        totalRequested: 0,
                        totalApproved: 0,
                        allocations: []
                    };
                }
                
                voteData[voteNumber].totalRequests++;
                voteData[voteNumber].totalRequested += parseFloat(allocation.requiredamount);
                
                if (allocation.status === 'Approved') {
                    voteData[voteNumber].approvedRequests++;
                    voteData[voteNumber].totalApproved += parseFloat(allocation.approvedamount || allocation.requiredamount);
                }
                
                voteData[voteNumber].allocations.push(allocation);
            });
            
            displayAdminVoteDistribution(voteData);
            updateAdminVoteDistributionChart(voteData);
        }

        function displayAdminVoteDistribution(voteData) {
            const tableBody = document.getElementById('adminVoteDistributionTableBody');
            tableBody.innerHTML = '';
            
            if (Object.keys(voteData).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No vote distribution data available</td></tr>';
                return;
            }
            
            Object.keys(voteData).forEach(voteNumber => {
                const data = voteData[voteNumber];
                const approvalRate = data.totalRequests > 0 ? Math.round((data.approvedRequests / data.totalRequests) * 100) : 0;
                const avgAmount = data.totalRequests > 0 ? data.totalRequested / data.totalRequests : 0;
                
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                tr.innerHTML = `
                    <td>${voteNumber}</td>
                    <td>${data.totalRequests}</td>
                    <td>${data.approvedRequests}</td>
                    <td>${formatCurrency(data.totalRequested)}</td>
                    <td>${formatCurrency(data.totalApproved)}</td>
                    <td>${approvalRate}%</td>
                    <td>${formatCurrency(avgAmount)}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function updateAdminVoteDistributionChart(voteData) {
            const ctx = document.getElementById('adminVoteDistributionChart').getContext('2d');
            
            if (window.adminVoteDistributionChartInstance) {
                window.adminVoteDistributionChartInstance.destroy();
            }
            
            const voteNumbers = Object.keys(voteData);
            const totalAmounts = voteNumbers.map(vote => voteData[vote].totalRequested);
            
            window.adminVoteDistributionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: voteNumbers,
                    datasets: [{
                        label: 'Total Requested Amount (LKR)',
                        data: totalAmounts,
                        backgroundColor: 'rgba(26, 115, 232, 0.7)',
                        borderColor: 'rgba(26, 115, 232, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Total Approved Amount (LKR)',
                        data: voteNumbers.map(vote => voteData[vote].totalApproved),
                        backgroundColor: 'rgba(52, 168, 83, 0.7)',
                        borderColor: 'rgba(52, 168, 83, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (LKR)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Vote Number'
                            }
                        }
                    }
                }
            });
        }

        // Hospital Summary Functions
        async function loadHospitalSummary() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const allAllocationsData = allocationsResult.allocations || [];
                
                const yearFilter = document.getElementById('hospitalSummaryYearFilter').value;
                const statusFilter = document.getElementById('hospitalSummaryStatusFilter').value;
                
                let filteredAllocations = allAllocationsData;
                
                if (yearFilter !== 'all') {
                    filteredAllocations = filteredAllocations.filter(allocation => {
                        const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
                        return allocationYear === yearFilter;
                    });
                }
                
                if (statusFilter !== 'all') {
                    filteredAllocations = filteredAllocations.filter(allocation => allocation.status === statusFilter);
                }
                
                calculateHospitalSummary(filteredAllocations);
            } catch (error) {
                console.error('Error loading hospital summary:', error);
            }
        }

        function calculateHospitalSummary(allocations) {
            const hospitalData = {};
            
            allocations.forEach(allocation => {
                const hospitalName = allocation.hospitalname || 'Unknown';
                
                if (!hospitalData[hospitalName]) {
                    hospitalData[hospitalName] = {
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalRequested: 0,
                        totalApproved: 0,
                        allocations: []
                    };
                }
                
                hospitalData[hospitalName].total++;
                hospitalData[hospitalName][allocation.status.toLowerCase()]++;
                hospitalData[hospitalName].totalRequested += parseFloat(allocation.requiredamount);
                if (allocation.approvedamount > 0) {
                    hospitalData[hospitalName].totalApproved += parseFloat(allocation.approvedamount);
                }
                hospitalData[hospitalName].allocations.push(allocation);
            });
            
            displayHospitalSummaryCards(hospitalData);
            displayHospitalSummaryTable(hospitalData);
        }

        function displayHospitalSummaryCards(hospitalData) {
            const hospitalSummaryGrid = document.getElementById('hospitalSummaryGrid');
            hospitalSummaryGrid.innerHTML = '';
            
            Object.keys(hospitalData).forEach(hospitalName => {
                const data = hospitalData[hospitalName];
                const approvalRate = data.total > 0 ? Math.round((data.approved / data.total) * 100) : 0;
                
                const card = document.createElement('div');
                card.className = 'hospital-summary-card';
                card.innerHTML = `
                    <div class="hospital-summary-header">
                        <div class="hospital-summary-name">${hospitalName}</div>
                        <div class="hospital-summary-count">${data.total}</div>
                    </div>
                    <div class="hospital-summary-stats">
                        <div class="hospital-stat-item">
                            <div class="hospital-stat-value">${data.pending}</div>
                            <div class="hospital-stat-label">Pending</div>
                        </div>
                        <div class="hospital-stat-item">
                            <div class="hospital-stat-value">${data.approved}</div>
                            <div class="hospital-stat-label">Approved</div>
                        </div>
                        <div class="hospital-stat-item">
                            <div class="hospital-stat-value">${data.rejected}</div>
                            <div class="hospital-stat-label">Rejected</div>
                        </div>
                        <div class="hospital-stat-item">
                            <div class="hospital-stat-value">${approvalRate}%</div>
                            <div class="hospital-stat-label">Approval Rate</div>
                        </div>
                    </div>
                `;
                hospitalSummaryGrid.appendChild(card);
            });
        }

        function displayHospitalSummaryTable(hospitalData) {
            const tableBody = document.getElementById('hospitalSummaryTableBody');
            tableBody.innerHTML = '';
            
            if (Object.keys(hospitalData).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No hospital summary data available</td></tr>';
                return;
            }
            
            Object.keys(hospitalData).forEach(hospitalName => {
                const data = hospitalData[hospitalName];
                const approvalRate = data.total > 0 ? Math.round((data.approved / data.total) * 100) : 0;
                
                const tr = document.createElement('tr');
                tr.className = 'enhanced-table-row';
                tr.innerHTML = `
                    <td>${hospitalName}</td>
                    <td>${data.total}</td>
                    <td>${data.pending}</td>
                    <td>${data.approved}</td>
                    <td>${data.rejected}</td>
                    <td>${formatCurrency(data.totalRequested)}</td>
                    <td>${formatCurrency(data.totalApproved)}</td>
                    <td>${approvalRate}%</td>
                    <td>
                        <button class="action-btn btn" onclick="viewHospitalHistory('${hospitalName}')">View History</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // System Logs Functions
        async function loadSystemLogs() {
            try {
                const logsResult = await callGoogleAppsScript('getSystemLogs');
                systemLogs = logsResult.logs || [];
                filterLogs();
            } catch (error) {
                console.error('Error loading system logs:', error);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeLocalStorage();
            
            // Role selector
            const roleOptions = document.querySelectorAll('.role-option');
            roleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    roleOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    currentUserRole = this.dataset.role;
                });
            });
            
            // Login button
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Logout buttons
            document.getElementById('hospitalLogout')?.addEventListener('click', logout);
            document.getElementById('adminLogout')?.addEventListener('click', logout);
            
            // Submit allocation
            document.getElementById('submitAllocation')?.addEventListener('click', submitAllocation);
            
            // New allocation
            document.getElementById('newAllocation')?.addEventListener('click', resetAllocationForm);
            
            // My Requests filter
            document.getElementById('myRequestsStatusFilter')?.addEventListener('change', filterMyRequests);
            document.getElementById('searchMyRequests')?.addEventListener('input', filterMyRequests);
            
            // My Requests pagination
            document.getElementById('myRequestsPrevPage')?.addEventListener('click', goToMyRequestsPrevPage);
            document.getElementById('myRequestsNextPage')?.addEventListener('click', goToMyRequestsNextPage);
            
            // User allocation search
            document.getElementById('searchUserAllocations')?.addEventListener('input', function() {
                updateUserAllocationStatus();
            });
            
            // History filters
            document.getElementById('historyYearFilter')?.addEventListener('change', function() {
                loadAllocationHistory();
            });
            document.getElementById('historyVoteFilter')?.addEventListener('change', function() {
                loadAllocationHistory();
            });
            document.getElementById('historyStatusFilter')?.addEventListener('change', function() {
                loadAllocationHistory();
            });
            
            // Vote distribution
            document.getElementById('distributionYearFilter')?.addEventListener('change', loadVoteDistribution);
            document.getElementById('exportVoteDistribution')?.addEventListener('click', exportVoteDistributionToExcel);
            
            // Admin filters
            document.getElementById('statusFilter')?.addEventListener('change', filterAllocations);
            document.getElementById('searchAllocations')?.addEventListener('input', filterAllocations);
            
            // Admin pagination
            document.getElementById('prevPage')?.addEventListener('click', goToPrevPage);
            document.getElementById('nextPage')?.addEventListener('click', goToNextPage);
            
            // Approval modal
            document.getElementById('confirmApproval')?.addEventListener('click', approveAllocation);
            document.getElementById('rejectRequest')?.addEventListener('click', function() {
                hideModal('approvalModal');
                openRejectionModal(currentRequestId);
            });
            
            // Rejection modal
            document.getElementById('confirmRejection')?.addEventListener('click', rejectAllocation);
            
            // Edit modal
            document.getElementById('confirmEdit')?.addEventListener('click', saveEdit);
            
            // Close modals
            const closeModalButtons = document.querySelectorAll('.close-modal, .btn[data-close="modal"]');
            closeModalButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) hideModal(modal.id);
                });
            });
            
            // Cancel buttons
            document.getElementById('cancelEdit')?.addEventListener('click', function() {
                hideModal('editModal');
            });
            document.getElementById('cancelRejection')?.addEventListener('click', function() {
                hideModal('rejectionModal');
            });
            
            // Admin password modal
            document.getElementById('confirmAdminPassword')?.addEventListener('click', function() {
                const enteredPassword = document.getElementById('adminPassword').value.trim();
                if (enteredPassword === ADMIN_PASSWORD) {
                    hideModal('adminPasswordModal');
                    executePendingAction();
                } else {
                    alert('Invalid admin password');
                }
            });
            document.getElementById('cancelAdminPassword')?.addEventListener('click', function() {
                hideModal('adminPasswordModal');
            });
            
            // View modal close
            document.getElementById('closeView')?.addEventListener('click', function() {
                hideModal('viewModal');
            });
            
            // Approve Again button
            document.getElementById('approveAgainBtn')?.addEventListener('click', function() {
                hideModal('viewModal');
                openApprovalModal(currentRequestId);
            });
            
            // Edit Rejected Request button
            document.getElementById('editRejectedRequest')?.addEventListener('click', function() {
                hideModal('viewModal');
                openEditModal(currentRequestId);
            });
            
            // Request Re-approval button
            document.getElementById('requestReapproval')?.addEventListener('click', function() {
                hideModal('viewModal');
                openApprovalModal(currentRequestId);
            });
            
            // Admin tabs
            const adminTabs = document.querySelectorAll('.admin-tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Hide all tab contents
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Remove active class from all tabs
                    adminTabs.forEach(t => t.classList.remove('active'));
                    
                    // Show selected tab content
                    document.getElementById(tabId + 'Tab').style.display = 'block';
                    this.classList.add('active');
                    
                    // Load data for specific tabs
                    if (tabId === 'logs') {
                        loadSystemLogs();
                    } else if (tabId === 'allocationHistory') {
                        loadAdminAllocationHistory();
                    } else if (tabId === 'voteDistribution') {
                        loadAdminVoteDistribution();
                    } else if (tabId === 'hospitalSummary') {
                        loadHospitalSummary();
                    }
                });
            });
            
            // User tabs
            const userTabs = document.querySelectorAll('.user-tab');
            userTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Hide all tab contents
                    document.querySelectorAll('.user-tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Remove active class from all tabs
                    userTabs.forEach(t => t.classList.remove('active'));
                    
                    // Show selected tab content
                    document.getElementById(tabId + 'Tab').classList.remove('hidden');
                    this.classList.add('active');
                    
                    // Load data for specific tabs
                    if (tabId === 'history') {
                        loadAllocationHistory();
                    } else if (tabId === 'voteDistribution') {
                        loadVoteDistribution();
                    }
                });
            });
            
            // Admin history filters
            document.getElementById('adminHistoryYearFilter')?.addEventListener('change', loadAdminAllocationHistory);
            document.getElementById('adminHistoryHospitalFilter')?.addEventListener('change', loadAdminAllocationHistory);
            document.getElementById('adminHistoryStatusFilter')?.addEventListener('change', loadAdminAllocationHistory);
            
            // Admin vote distribution
            document.getElementById('adminDistributionYearFilter')?.addEventListener('change', loadAdminVoteDistribution);
            
            // Hospital summary filters
            document.getElementById('hospitalSummaryYearFilter')?.addEventListener('change', loadHospitalSummary);
            document.getElementById('hospitalSummaryStatusFilter')?.addEventListener('change', loadHospitalSummary);
            
            // System logs
            document.getElementById('logTypeFilter')?.addEventListener('change', filterLogs);
            document.getElementById('userFilter')?.addEventListener('change', filterLogs);
            document.getElementById('searchLogs')?.addEventListener('input', filterLogs);
            document.getElementById('refreshLogs')?.addEventListener('click', loadSystemLogs);
            document.getElementById('exportLogs')?.addEventListener('click', exportLogs);
            document.getElementById('logsPrevPage')?.addEventListener('click', goToLogsPrevPage);
            document.getElementById('logsNextPage')?.addEventListener('click', goToLogsNextPage);
            
            // Generate report
            document.getElementById('generateReport')?.addEventListener('click', async function() {
                const reportType = document.getElementById('reportType').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const hospital = document.getElementById('hospitalFilter').value;
                
                try {
                    const result = await callGoogleAppsScript('getReports', {
                        type: reportType,
                        startDate: startDate,
                        endDate: endDate,
                        hospital: hospital
                    });
                    
                    if (result.success) {
                        const reportResults = document.getElementById('reportResults');
                        reportResults.innerHTML = `
                            <div class="success-message">
                                <h2>${result.title}</h2>
                                <p>Generated at: ${new Date(result.generatedAt).toLocaleString()}</p>
                            </div>
                            <div class="table-scroll-container">
                                <table>
                                    <thead>
                                        ${result.reportData[0].map(header => `<th>${header}</th>`).join('')}
                                    </thead>
                                    <tbody>
                                        ${result.reportData.slice(1).map(row => `
                                            <tr>
                                                ${row.map(cell => `<td>${cell}</td>`).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        alert('Report generation failed: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Report generation failed. Please try again.');
                }
            });
            
            // Close hospital history modal
            document.getElementById('closeHospitalHistory')?.addEventListener('click', function() {
                hideModal('hospitalHistoryModal');
            });
        });
    </script>
</body>
</html>
