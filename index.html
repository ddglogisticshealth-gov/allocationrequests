<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allocation Distribution System - Ministry of Health</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --primary: #1a73e8;
            --primary-light: #4285f4;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --secondary-light: #5cb85c;
            --danger: #ea4335;
            --warning: #f9ab00;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #202124;
            --gray: #5f6368;
            --gray-light: #e9ecef;
            --border: #dadce0;
            --success: #28a745;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --transition: all 0.3s ease;
        }
        
        /* ========== RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            padding: 0 20px;
            margin: 0 auto;
        }
        
        /* ========== TYPOGRAPHY ========== */
        h1, h2, h3, h4, h5, h6 {
            margin-bottom: 0.5rem;
            font-weight: 600;
            line-height: 1.2;
        }
        
        h1 { font-size: 2rem; }
        h2 { font-size: 1.75rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.25rem; }
        h5 { font-size: 1.1rem; }
        h6 { font-size: 1rem; }
        
        /* ========== NEW LOGIN SCREEN ========== */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.05)"/></svg>');
            background-size: cover;
        }
        
        .login-card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 40px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 15px;
        }
        
        /* ========== FORM STYLES ========== */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: var(--transition);
            background-color: #f8f9fa;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            background-color: white;
        }
        
        .role-selector {
            display: flex;
            margin-bottom: 25px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--border);
            background: #f8f9fa;
        }
        
        .role-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
        }
        
        .role-option.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .form-text {
            color: var(--gray);
            font-size: 13px;
            margin-top: 5px;
            display: block;
        }
        
        /* ========== BUTTON STYLES ========== */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            box-shadow: var(--shadow);
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d8c47 100%);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(52, 168, 83, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #d33426 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(234, 67, 53, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68a00 100%);
        }
        
        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(249, 171, 0, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #138496 100%);
        }
        
        .btn-info:hover {
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: var(--transition);
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-right: 6px;
            transition: var(--transition);
        }
        
        /* ========== DASHBOARD STYLES ========== */
        .dashboard {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            box-shadow: var(--shadow);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 18px;
            color: white;
        }
        
        .logo-icon {
            margin-right: 10px;
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-name {
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
        
        .main-content {
            padding: 25px 0;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--dark);
            text-align: center;
        }
        
        /* ========== ALLOCATION FORM STYLES ========== */
        .allocation-form {
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1 0 100%;
            padding: 0 10px;
            margin-bottom: 18px;
        }
        
        /* ========== TAB STYLES ========== */
        .admin-tabs, .user-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .admin-tab, .user-tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            color: var(--gray);
            position: relative;
            font-size: 15px;
        }
        
        .admin-tab.active, .user-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(26, 115, 232, 0.05);
        }
        
        .admin-tab-content, .user-tab-content {
            display: block;
        }
        
        /* ========== NOTIFICATION BADGE ========== */
        .notification-badge {
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 6px;
            right: 6px;
        }
        
        /* ========== TABLE STYLES ========== */
        .requests-table, .data-table-container {
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-header, .data-table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .table-title, .data-table-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .table-container, .table-scroll-container {
            overflow-x: auto;
            max-height: 500px;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: var(--gray);
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .highlighted-row {
            background-color: rgba(26, 115, 232, 0.08) !important;
            border-left: 3px solid var(--primary);
        }
        
        /* ========== STATUS BADGES ========== */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff8e1;
            color: var(--warning);
            border: 1px solid #ffecb3;
        }
        
        .status-approved {
            background-color: #e8f5e9;
            color: var(--secondary);
            border: 1px solid #c8e6c9;
        }
        
        .status-rejected {
            background-color: #ffebee;
            color: var(--danger);
            border: 1px solid #ffcdd2;
        }
        
        .status-completed {
            background-color: #e3f2fd;
            color: var(--primary);
            border: 1px solid #bbdefb;
        }
        
        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .stat-value {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 600;
        }
        
        /* ========== ENHANCED PDF STYLES ========== */
        .enhanced-pdf {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            background-color: white;
            box-shadow: var(--shadow);
        }
        
        .enhanced-pdf-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary);
        }
        
        .enhanced-pdf-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .enhanced-pdf-subtitle {
            font-size: 16px;
            color: var(--gray);
            font-weight: 500;
        }
        
        .enhanced-pdf-section {
            margin-bottom: 20px;
            padding: 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 3px solid var(--primary);
        }
        
        .enhanced-pdf-label {
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .enhanced-pdf-value {
            margin-bottom: 10px;
            color: var(--gray);
            font-size: 14px;
        }
        
        .enhanced-pdf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* ========== SUCCESS MESSAGE ========== */
        .success-message {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .success-message h2 {
            color: var(--secondary);
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .success-message p {
            color: var(--dark);
            font-size: 15px;
        }
        
        .password-notice {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 18px;
            margin: 18px 0;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .password-value {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px dashed var(--primary);
            display: inline-block;
            margin: 8px 0;
        }
        
        /* ========== ADMIN CONTROLS ========== */
        .admin-controls, .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .filter-control, .report-control {
            flex: 1;
            min-width: 220px;
        }
        
        .search-control {
            position: relative;
        }
        
        .search-control .form-control, .search-container .form-control {
            padding-left: 36px;
        }
        
        .search-control i, .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 12px;
            padding: 16px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background-color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 14px;
        }
        
        .pagination button:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            margin: 0 16px;
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }
        
        /* ========== SIGNATURE SECTION ========== */
        .signature-section {
            margin-top: 30px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .signature-line {
            height: 1px;
            background: var(--dark);
            margin: 20px 0 8px;
        }
        
        .signature-label {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .signature-name {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .signature-title {
            font-size: 13px;
            color: var(--gray);
        }
        
        /* ========== UTILITY CLASSES ========== */
        .text-center {
            text-align: center;
        }
        
        .text-left {
            text-align: left;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .ml-10 { margin-left: 10px; }
        .mr-10 { margin-right: 10px; }
        
        .hidden {
            display: none;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .align-items-center {
            align-items: center;
        }
        
        .w-100 {
            width: 100%;
        }
        
        /* ========== LOADING SPINNER ========== */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* ========== FIXED BUTTON STYLES ========== */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .button-group .btn {
            flex: 1;
            min-width: 180px;
            max-width: 250px;
            margin: 0;
        }

        .button-group .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d8c47 100%);
            flex: 1;
            min-width: 180px;
            max-width: 250px;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (min-width: 576px) {
            .form-col {
                flex: 1 0 50%;
            }
        }
        
        @media (min-width: 992px) {
            .form-col {
                flex: 1 0 33.333%;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 0 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .login-card {
                padding: 25px;
            }
            
            .allocation-form {
                padding: 20px;
            }
            
            .table-header, .data-table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .admin-controls, .report-controls {
                flex-direction: column;
            }
            
            .filter-control, .report-control {
                width: 100%;
            }
            
            .admin-tabs, .user-tabs {
                flex-wrap: wrap;
            }
            
            .admin-tab, .user-tab {
                flex: 1;
                min-width: 110px;
                text-align: center;
                padding: 14px 16px;
            }
            
            .enhanced-pdf-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 8px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .data-table-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .form-col {
                flex: 1 0 100%;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 12px;
            }
            
            .button-group .btn,
            .button-group .btn-secondary {
                min-width: 100%;
                max-width: 100%;
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .pagination {
                flex-wrap: wrap;
            }
            
            .admin-tab, .user-tab {
                flex: 1 0 100%;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .modal-footer {
                padding: 12px;
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .button-group {
                gap: 8px;
                padding: 10px;
            }
            
            .button-group .btn {
                padding: 10px 14px;
                font-size: 14px;
            }
        }

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">üè•</div>
            <h1 class="login-title">Allocation Distribution System</h1>
            <p class="login-subtitle">Ministry of Health</p>
            
            <div class="role-selector">
                <div class="role-option active" data-role="hospital">Hospital User</div>
                <div class="role-option" data-role="admin">Admin User</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="hospitalSelect">Select Hospital/User</label>
                <select id="hospitalSelect" class="form-control">
                    <option value="">Select Hospital/User</option>
                    <option value="admin">Administrator</option>
                    <option value="Ministry of Health">Ministry of Health</option>
                    <option value="National Hospital Sri Lanka">National Hospital Sri Lanka</option>
                    <option value="Colombo South Teaching Hospital">Colombo South Teaching Hospital</option>
                    <option value="Lady Ridgeway Hospital">Lady Ridgeway Hospital</option>
                    <option value="Apeksha Hospital Maharagama">Apeksha Hospital Maharagama</option>
                    <option value="Colombo East Base Hospital Mulleriyawa">Colombo East Base Hospital Mulleriyawa</option>
                    <option value="Infections Diseases Hospital">Infections Diseases Hospital</option>
                    <option value="NIMH">NIMH</option>
                    <option value="De Soysa Hospital">De Soysa Hospital</option>
                    <option value="Castle Street Hospital for Women">Castle Street Hospital for Women</option>
                    <option value="National Eye Hospital">National Eye Hospital</option>
                    <option value="Institute of Oral Health-Maharagama">Institute of Oral Health-Maharagama</option>
                    <option value="National Blood Transfusion Service">National Blood Transfusion Service</option>
                    <option value="National Institute for Nephrology Dialysis and Transplantation - Maligawatta">National Institute for Nephrology Dialysis and Transplantation - Maligawatta</option>
                    <option value="Medical Research Institute">Medical Research Institute</option>
                    <option value="National Dental Hospital">National Dental Hospital</option>
                    <option value="Colombo North Teaching Hospital - Ragama">Colombo North Teaching Hospital - Ragama</option>
                    <option value="Rheumatology & Rehabilitation Hospital, Ragama">Rheumatology & Rehabilitation Hospital, Ragama</option>
                    <option value="District Hospital Kandana">District Hospital Kandana</option>
                    <option value="National Hospital for Respiratory Diseases, Welisara">National Hospital for Respiratory Diseases, Welisara</option>
                    <option value="Leprosy Hospital - Handala">Leprosy Hospital - Handala</option>
                    <option value="DGH Negombo (District General Hospital)">DGH Negombo (District General Hospital)</option>
                    <option value="Teaching Hospital Kalutara">Teaching Hospital Kalutara</option>
                    <option value="National Institute of Health Sciences Kalutara">National Institute of Health Sciences Kalutara</option>
                    <option value="National Hospital - Kandy">National Hospital - Kandy</option>
                    <option value="Base Hospital Gampola">Base Hospital Gampola </option>
                    <option value="Teaching Hospital Peradeniya">Teaching Hospital Peradeniya</option>
                    <option value="Sirimavo Bandaranayake Hospital - Peradeniya">Sirimavo Bandaranayake Hospital - Peradeniya</option>
                    <option value="District General Hospital Nawalapitiya">District General Hospital Nawalapitiya</option>
                    <option value="District General Hospital NuwaraEliya">District General Hospital NuwaraEliya</option>
                    <option value="District General Hospital Matale">District General Hospital Matale</option>
                    <option value="National Hospital - Galle (Karapitiya)">National Hospital - Galle (Karapitiya)</option>
                    <option value="German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)">German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)</option>
                    <option value="District General Hospital Matara">District General Hospital Matara</option>
                    <option value="District General Hospital Hambantota">District General Hospital Hambantota</option>
                    <option value="TH Jaffna">TH Jaffna</option>
                    <option value="Base Hospital Akkaraipattu">Base Hospital Akkaraipattu</option>
                    <option value="Ashroff Hospital - Kalmunai">Ashroff Hospital - Kalmunai</option>
                    <option value="Base Hospital Kalmunai North">Base Hospital Kalmunai North</option>
                    <option value="District General Hospital Ampara">District General Hospital Ampara</option>
                    <option value="Base Hospital Pottuvil">Base Hospital Pottuvil</option>
                    <option value="District General Hospital Trincomalee">District General Hospital Trincomalee</option>
                    <option value="District General Hospital Kantale">District General Hospital Kantale</option>
                    <option value="Teaching Hospital Batticaloa">Teaching Hospital Batticaloa</option>
                    <option value="District General Hospital Chilaw">District General Hospital Chilaw</option>
                    <option value="Teaching Hospital Kurunegala">Teaching Hospital Kurunegala</option>
                    <option value="Teaching Hospital Kuliyapitiya">Teaching Hospital Kuliyapitiya</option>
                    <option value="District General Hospital Polonnaruwa">District General Hospital Polonnaruwa</option>
                    <option value="China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)">China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)</option>
                    <option value="TH Anuradhapura">TH Anuradhapura</option>
                   <option value="TH Badulla">TH Badulla</option>
                    <option value="District General Hospital Monaragala">District General Hospital Monaragala </option>
                    <option value="District General Hospital Kegalle">District General Hospital Kegalle</option>
                    <option value="Teaching Hospital Ratnapura">Teaching Hospital Ratnapura</option>
                    <option value="District General Hospital Embilipitiya">District General Hospital Embilipitiya</option>
                    <option value="National STD/AIDS Control Programme">National STD/AIDS Control Programme</option>
                    <option value="Biomedical Engineering Services">Biomedical Engineering Services</option>
                    <option value="Epidemiology Unit">Epidemiology Unit</option>
                    <option value="National Cancer Control Programme">National Cancer Control Programme</option>
                    <option value="National Programme for Tuberculosis Control & Chest Diseases">National Programme for Tuberculosis Control & Chest Diseases</option>
                    <option value="Institute for Forensic Medicine & Toxicology">Institute for Forensic Medicine & Toxicology</option>
                    <option value="Health Promotion Bureau">Health Promotion Bureau</option>
                    <option value="Dengue Control Programme">Dengue Control Programme</option>
                    <option value="Anti Malaria Campaign">Anti Malaria Campaign</option>
                    <option value="Family Health Bureau">Family Health Bureau</option>
                    <option value="Anti Filariasis Campaign">Anti Filariasis Campaign</option>
                    <option value="Medical Supplies Division">Medical Supplies Division</option>
                    <option value="Public Health Veterinary Services">Public Health Veterinary Services</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
                <small class="form-text">For System Inquiries 011 2 692 382</small>
            </div>
            
            <button id="loginBtn" class="btn btn-block">Login to System</button>
            <div id="loginSpinner" class="spinner mt-20 hidden"></div>
            <div id="loginMessage" class="mt-20 hidden"></div>
        </div>
    </div>
    
    <!-- Hospital User Dashboard -->
    <div id="hospitalDashboard" class="dashboard hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">üè•</span>
                        <span>ADS - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="hospitalDisplayName">Hospital User</span>
                        <button id="hospitalLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Allocation Distribution System</h1>
                
                <div class="user-tabs">
                    <div class="user-tab active" data-tab="allocation">Allocation Request</div>
                    <div class="user-tab" data-tab="myRequests">My Requests</div>
                    <div class="user-tab" data-tab="allocations">Allocation Status</div>
                </div>
                
                <!-- Allocation Request Tab -->
                <div id="allocationTab" class="user-tab-content">
                    <div class="allocation-form" id="allocationForm">
                        <div class="form-section">
                            <h2 class="section-title">Hospital Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="hospitalName">Hospital Name *</label>
                                        <input type="text" id="hospitalName" class="form-control" placeholder="Enter hospital name" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactPerson">Contact Person *</label>
                                        <input type="text" id="contactPerson" class="form-control" placeholder="Enter contact person name" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactPhone">Contact Phone *</label>
                                        <input type="tel" id="contactPhone" class="form-control" placeholder="Enter contact phone number" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactEmail">Contact Email</label>
                                        <input type="email" id="contactEmail" class="form-control" placeholder="Enter contact email">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h2 class="section-title">Allocation Details</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="voteNumber">Vote Number *</label>
                                        <select id="voteNumber" class="form-control" required>
                                            <option value="">-- Select Vote Number --</option>
                                            <option value="111-1-5-2001(11) Building Rehabilitation-Hospital">111-1-5-2001(11) Building Rehabilitation-Hospital</option>
                                            <option value="111-1-5-2002(11) Service and Maintenance-Hospital">111-1-5-2002(11) Service and Maintenance-Hospital</option>
                                            <option value="111-1-5-2103(11) Machinery Purchasing-Hospitals">111-1-5-2103(11) Machinery Purchasing-Hospitals</option>
                                            <option value="111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions">111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions</option>
                                            <option value="111-2-26-2001(11) Building Rehabilitation-Other Health Institutions">111-2-26-2001(11) Building Rehabilitation-Other Health Institutions</option>
                                            <option value="111-2-26-2002(11) Service and Maintenance-Other Health Institutions">111-2-26-2002(11) Service and Maintenance-Other Health Institutions</option>
                                            <option value="111-2-26-2103(11) Machinery Purchasing-Other Health Institutions">111-2-26-2103(11) Machinery Purchasing-Other Health Institutions</option>
                                            <option value="111-2-20-001-2001(11) Building Rehabilitation-NTS">111-2-20-001-2001(11) Building Rehabilitation-NTS</option>
                                            <option value="111-2-20-001-2002(11) Service and Maintenance-NTS">111-2-20-001-2002(11) Service and Maintenance-NTS</option>
                                            <option value="111-2-20-001-2103(11) Machinery Purchasing-NTS">111-2-20-001-2103(11) Machinery Purchasing-NTS</option>
                                            <option value="111-2-26-008-2001(11) Strengthening Primary Level Health Care">111-2-26-008-2001(11) Strengthening Primary Level Health Care</option>
                                            <option value="111-1-2-2001(11) Building and Structures- Ministry Administration">111-1-2-2001(11) Building and Structures- Ministry Administration</option>
                                            <option value="111-1-1-2001(11) Building and Structures- Minister Office">111-1-1-2001(11) Building and Structures- Minister Office</option>
                                            <option value="111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office">111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office</option>
                                            <option value="111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration">111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration</option>
                                            <option value="111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration">111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration</option>
                                            <option value="111-1-5-013-2001(11) Improvement in Machanical,Electrical and Sewerage Systems">111-1-5-013-2001(11) Improvement in Machanical,Electrical and Sewerage Systems</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobDescription">Job Description *</label>
                                        <textarea id="jobDescription" class="form-control" rows="3" placeholder="Describe the job/work required" required></textarea>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="requiredAmount">Required Amount (LKR) *</label>
                                        <input type="number" id="requiredAmount" class="form-control" placeholder="Enter required amount in LKR" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="priorityLevel">Priority Level *</label>
                                        <select id="priorityLevel" class="form-control" required>
                                            <option value="">Select priority level</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="requiredDate">Required Completion Date *</label>
                                        <input type="date" id="requiredDate" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="additionalNotes">Additional Notes</label>
                                        <textarea id="additionalNotes" class="form-control" rows="3" placeholder="Add any additional notes or comments"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="submitAllocation" class="btn btn-block">Submit Allocation Request</button>
                        <div id="submitSpinner" class="spinner mt-20 hidden"></div>
                    </div>
                    
                    <div id="allocationSuccess" class="hidden">
                        <div class="success-message">
                            <h2>Allocation Request Submitted Successfully!</h2>
                            <p>Your allocation request has been submitted and is pending approval.</p>
                            <div class="password-notice">
                                <h3>Your Request Password: <span id="uniquePasswordDisplay" class="password-value"></span></h3>
                                <p><strong>Important:</strong> Save this password. You'll need it for any updates or inquiries about this request.</p>
                            </div>
                        </div>
                        
                        <div class="enhanced-pdf" id="enhancedPdfPreview">
                            <div class="enhanced-pdf-header">
                                <div class="enhanced-pdf-title">Ministry of Health</div>
                                <div class="enhanced-pdf-subtitle">Allocation Request Confirmation</div>
                            </div>
                            <div class="enhanced-pdf-grid">
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Request Reference:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfRefNumber">ADS-2023-001</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Unique Password:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfPassword">XXXXXX</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Submission Date:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfDate">01/01/2023</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Hospital Details:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfHospitalDetails">Hospital Name, Contact Person, Phone</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Vote Number:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfVoteNumber">Vote Number</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Job Description:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfJobDescription">Job Description</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Required Amount:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfAmount">0 LKR</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Priority Level:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfPriority">Low</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Required Date:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfRequiredDate">01/01/2023</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Additional Notes:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfAdditionalNotes">No additional notes</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Status:</div>
                                    <div class="enhanced-pdf-value">Pending Approval</div>
                                </div>
                            </div>
                            
                            <!-- Add Important Instructions Section -->
                            <div class="enhanced-pdf-section" style="grid-column: 1 / -1;">
                                <div class="enhanced-pdf-label">Important Instructions:</div>
                                <div class="enhanced-pdf-value">
                                    <p><strong>3. The following instructions should be followed when incurring these expenses:</strong></p>
                                    <p>I. Action should be taken in accordance with the Government Financial Regulations (GFR), Establishment Code, GFR 135 on Delegation of Authority, other laws and regulations, and the relevant instructions of Budget Circular No. 01/2025 dated 22.03.2025, which authorizes expenditure for the year 2025 and pertains to public expenditure management.</p>
                                    <p>II. The relevant work subjects should be executed upon approval by your Hospital's Regional Procurement Committee, in accordance with this Ministry Circular and instructions.</p>
                                    <p>III. In order to prevent the Government as well as the contractors/service providers from facing difficulties due to the accumulation of unsettled liabilities, it is important to confirm the availability of cash flow before entering into commitments, even if the provision has been allocated.</p>
                                    <p>IV. Starting work without provisions should especially be avoided, and expenses exceeding the limit of the allocated provisions should not be incurred.</p>
                                    <p>V. The provisions granted through this letter will expire on 31.12.2026.</p>
                                    <p><strong>4. Monthly expenditure reports</strong>, stating the work subjects for which the provisions were expended, must be submitted by the Accountant of the Hospitals/Institutions to the email address buildingbranch.b07@gmail.com. The Institutional Section must also complete the physical and financial progress for every month according to the provided format. Kindly note that both these reports must be submitted before the 10th day of the following month.</p>
                                </div>
                            </div>
                            
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="signature-label">Approval Signature:</div>
                                        <div class="signature-name">H.M.N Dinipriya Herath</div>
                                        <div class="signature-title">Deputy Director General (Logistics)</div>
                                        <div class="signature-title">For Secretary</div>
                                    </div>
                                    <div>
                                        <div class="signature-label">Approval Signature:</div>
                                        <div class="signature-name">Director Building Branch</div>
                                        <div class="signature-title">Director Building Branch (Administration)</div>
                                    </div>
                                </div>
                                <div class="mt-20">
                                    <div class="signature-label">Copies:</div>
                                    <div class="signature-title">1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)</div>
                                    <div class="signature-title">2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)</div>
                                </div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button id="downloadPdf" class="btn">Download Confirmation</button>
                            <button id="newAllocation" class="btn btn-secondary">Make Another Request</button>
                        </div>
                    </div>
                </div>
                
                <!-- My Requests Tab -->
                <div id="myRequestsTab" class="user-tab-content hidden">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="myRequestsStatusFilter">Filter by Status</label>
                            <select id="myRequestsStatusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchMyRequests">Search My Requests</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchMyRequests" class="form-control" placeholder="Search by reference or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">My Allocation Requests</div>
                            <div id="myRequestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="myRequestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="myRequestsPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="myRequestsPageInfo">Page 1 of 1</span>
                            <button id="myRequestsNextPage" disabled>Next</button>
                        </div>
                        
                        <div id="myRequestsSpinner" class="spinner mt-20 mb-20 hidden"></div>
                    </div>
                </div>
                
                <!-- Allocation Status Tab -->
                <div id="allocationsTab" class="user-tab-content hidden">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="stat-value" id="userTotalAllocations">0</div>
                            <div class="stat-label">Total Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-value" id="userApprovedCount">0</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-value" id="userPendingCount">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                            <div class="stat-value" id="userRejectedCount">0</div>
                            <div class="stat-label">Rejected</div>
                        </div>
                    </div>
                    
                    <div class="user-allocation-status">
                        <h2 class="section-title">Allocation Status Overview</h2>
                        <p>Current status of all your allocation requests.</p>
                        
                        <div class="data-table-controls mb-20">
                            <div class="search-control">
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchUserAllocations" class="form-control" placeholder="Search allocations...">
                                </div>
                            </div>
                            <div class="pagination-info" id="userAllocationPageInfo">Page 1 of 1</div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table class="user-allocation-table">
                                <thead>
                                    <tr>
                                        <th>Ref No</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="userAllocationsList">
                                    <!-- Allocations will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="userAllocationPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="userAllocationPaginationInfo">Page 1 of 1</span>
                            <button id="userAllocationNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">üè•</span>
                        <span>ADS Admin - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="adminDisplayName">Administrator</span>
                        <button id="adminLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Allocation Requests Management</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-list-alt"></i></div>
                        <div class="stat-value" id="totalAllocations">0</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="pendingAllocations">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="approvedAllocations">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-value" id="totalAllocatedAmount">0</div>
                        <div class="stat-label">Total Allocated (LKR)</div>
                    </div>
                </div>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" data-tab="requests">
                        Allocation Requests
                        <span id="pendingAllocationBadge" class="notification-badge hidden">0</span>
                    </div>
                    <div class="admin-tab" data-tab="allocations">Allocation Status</div>
                    <div class="admin-tab" data-tab="reports">Reports</div>
                    <div class="admin-tab" data-tab="logs">System Logs</div>
                </div>
                
                <!-- Allocation Requests Tab -->
                <div id="requestsTab" class="admin-tab-content">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="statusFilter">Filter by Status</label>
                            <select id="statusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchAllocations">Search Allocations</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchAllocations" class="form-control" placeholder="Search by reference, hospital, or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">Allocation Requests</div>
                            <div id="requestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Hospital</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="prevPage" disabled>Previous</button>
                            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                            <button id="nextPage" disabled>Next</button>
                        </div>
                        
                        <div id="adminSpinner" class="spinner mt-20 mb-20 hidden"></div>
                    </div>
                </div>
                
                <!-- Allocation Status Tab -->
                <div id="allocationsTab" class="admin-tab-content hidden">
                    <div class="admin-controls">
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchAllocationsStatus">Search Allocations</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchAllocationsStatus" class="form-control" placeholder="Search by hospital or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="allocation-status-cards">
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Pending Allocations</div>
                                <div class="status-card-count status-card-pending" id="pendingAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="pendingAllocationsList">
                                <!-- Pending allocations will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Approved Allocations</div>
                                <div class="status-card-count status-card-approved" id="approvedAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="approvedAllocationsList">
                                <!-- Approved allocations will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Rejected Allocations</div>
                                <div class="status-card-count status-card-rejected" id="rejectedAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="rejectedAllocationsList">
                                <!-- Rejected allocations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div id="reportsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">Generate Reports</h2>
                        
                        <div class="report-controls">
                            <div class="report-control">
                                <label class="form-label" for="reportType">Report Type</label>
                                <select id="reportType" class="form-control">
                                    <option value="allocations">Allocation Summary</option>
                                    <option value="hospitals">Hospital-wise Summary</option>
                                    <option value="votes">Vote-wise Summary</option>
                                    <option value="monthly">Monthly Summary</option>
                                </select>
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="startDate">Start Date</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="hospitalFilter">Hospital</label>
                                <select id="hospitalFilter" class="form-control">
                                    <option value="all">All Hospitals</option>
                                    <!-- Hospital options will be populated here -->
                                </select>
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label">&nbsp;</label>
                                <button id="generateReport" class="btn">Generate Report</button>
                            </div>
                        </div>
                        
                        <div id="reportResults"></div>
                    </div>
                </div>
                
                <!-- System Logs Tab -->
                <div id="logsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">System Logs</h2>
                        
                        <div class="admin-controls">
                            <div class="filter-control">
                                <label class="form-label" for="logTypeFilter">Filter by Type</label>
                                <select id="logTypeFilter" class="form-control">
                                    <option value="all">All Logs</option>
                                    <option value="allocation">Allocation</option>
                                    <option value="approval">Approval</option>
                                    <option value="system">System</option>
                                </select>
                            </div>
                            <div class="filter-control">
                                <label class="form-label" for="userFilter">Filter by User</label>
                                <select id="userFilter" class="form-control">
                                    <option value="all">All Users</option>
                                    <!-- User options will be populated here -->
                                </select>
                            </div>
                            <div class="search-control filter-control">
                                <label class="form-label" for="searchLogs">Search Logs</label>
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchLogs" class="form-control" placeholder="Search logs...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <div class="data-table-header">
                                <div class="data-table-title">System Activity Log</div>
                                <div class="data-table-controls">
                                    <button id="refreshLogs" class="btn btn-secondary">Refresh</button>
                                    <button id="exportLogs" class="btn">Export</button>
                                </div>
                            </div>
                            <div class="table-scroll-container">
                                <table class="user-allocation-table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Type</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemLogsTable">
                                        <!-- Logs will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination">
                                <button id="logsPrevPage" disabled>Previous</button>
                                <span class="pagination-info" id="logsPageInfo">Page 1 of 1</span>
                                <button id="logsNextPage" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approval Modal -->
    <div id="approvalModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approve Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="uniquePassword">Request Password *</label>
                    <input type="password" id="uniquePassword" class="form-control" placeholder="Enter request password for verification" required>
                    <small class="form-text">Enter the unique password provided for this request</small>
                </div>
                
                <div class="form-section">
                    <h4 class="section-title">Allocation Details</h4>
                    <div class="enhanced-pdf-section">
                        <div><strong>Reference:</strong> <span id="approvalRefNumber"></span></div>
                        <div><strong>Hospital:</strong> <span id="approvalHospital"></span></div>
                        <div><strong>Vote Number:</strong> <span id="approvalVoteNumber"></span></div>
                        <div><strong>Job Description:</strong> <span id="approvalJobDescription"></span></div>
                        <div><strong>Requested Amount:</strong> <span id="approvalRequestedAmount"></span></div>
                        <div><strong>Priority:</strong> <span id="approvalPriority"></span></div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 class="section-title">Approval Details</h4>
                    <div class="form-group">
                        <label class="form-label" for="approvedAmount">Approved Amount (LKR) *</label>
                        <input type="number" id="approvedAmount" class="form-control" placeholder="Enter approved amount" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="approvalNotes">Approval Notes</label>
                        <textarea id="approvalNotes" class="form-control" rows="3" placeholder="Add any notes about the approval..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="approvingAuthority">Approving Authority *</label>
                        <select id="approvingAuthority" class="form-control" required>
                            <option value="">Select approving authority</option>
                            <option value="Deputy Director General (Logistics)">Deputy Director General (Logistics)</option>
                            <option value="Director Building (Administration)">Director Building (Administration)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="rejectRequest" class="btn btn-danger">Reject Request</button>
                <button id="confirmApproval" class="btn">Approve Request</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editHospitalName">Hospital Name</label>
                            <input type="text" id="editHospitalName" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactPerson">Contact Person</label>
                            <input type="text" id="editContactPerson" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactPhone">Contact Phone</label>
                            <input type="tel" id="editContactPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactEmail">Contact Email</label>
                            <input type="email" id="editContactEmail" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editVoteNumber">Vote Number</label>
                            <select id="editVoteNumber" class="form-control">
                                <option value="">-- Select Vote Number --</option>
                                <option value="111-1-5-2001(11) Building Rehabilitation-Hospital">111-1-5-2001(11) Building Rehabilitation-Hospital</option>
                                <option value="111-1-5-2002(11) Service and Maintenance-Hospital">111-1-5-2002(11) Service and Maintenance-Hospital</option>
                                <option value="111-1-5-2103(11) Machinery Purchasing-Hospitals">111-1-5-2103(11) Machinery Purchasing-Hospitals</option>
                                <option value="111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions">111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions</option>
                                <option value="111-2-26-2001(11) Building Rehabilitation-Other Health Institutions">111-2-26-2001(11) Building Rehabilitation-Other Health Institutions</option>
                                <option value="111-2-26-2002(11) Service and Maintenance-Other Health Institutions">111-2-26-2002(11) Service and Maintenance-Other Health Institutions</option>
                                <option value="111-2-26-2103(11) Machinery Purchasing-Other Health Institutions">111-2-26-2103(11) Machinery Purchasing-Other Health Institutions</option>
                                <option value="111-2-20-001-2001(11) Building Rehabilitation-NTS">111-2-20-001-2001(11) Building Rehabilitation-NTS</option>
                                <option value="111-2-20-001-2002(11) Service and Maintenance-NTS">111-2-20-001-2002(11) Service and Maintenance-NTS</option>
                                <option value="111-2-20-001-2103(11) Machinery Purchasing-NTS">111-2-20-001-2103(11) Machinery Purchasing-NTS</option>
                                <option value="111-2-26-008-2001(11) Strengthening Primary Level Health Care">111-2-26-008-2001(11) Strengthening Primary Level Health Care</option>
                                <option value="111-1-2-2001(11) Building and Structures- Ministry Administration">111-1-2-2001(11) Building and Structures- Ministry Administration</option>
                                <option value="111-1-1-2001(11) Building and Structures- Minister Office">111-1-1-2001(11) Building and Structures- Minister Office</option>
                                <option value="111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office">111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office</option>
                                <option value="111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration">111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration</option>
                                <option value="111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration">111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration</option>
                                <option value="111-1-5-013-2001(11) Improvement in Machanical,Electrical and Sewerage Systems">111-1-5-013-2001(11) Improvement in Machanical,Electrical and Sewerage Systems</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editJobDescription">Job Description</label>
                            <textarea id="editJobDescription" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editRequiredAmount">Required Amount (LKR)</label>
                            <input type="number" id="editRequiredAmount" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editPriorityLevel">Priority Level</label>
                            <select id="editPriorityLevel" class="form-control">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editRequiredDate">Required Date</label>
                            <input type="date" id="editRequiredDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editAdditionalNotes">Additional Notes</label>
                            <textarea id="editAdditionalNotes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelEdit" class="btn btn-danger">Cancel</button>
                <button id="confirmEdit" class="btn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- View Modal -->
    <div id="viewModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Allocation Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="enhanced-pdf">
                    <div class="enhanced-pdf-header">
                        <div class="enhanced-pdf-title">Ministry of Health</div>
                        <div class="enhanced-pdf-subtitle">Allocation Request Details</div>
                    </div>
                    <div class="enhanced-pdf-grid">
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Request Reference:</div>
                            <div class="enhanced-pdf-value" id="viewRefNumber"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Submission Date:</div>
                            <div class="enhanced-pdf-value" id="viewDate"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Hospital Details:</div>
                            <div class="enhanced-pdf-value" id="viewHospitalDetails"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Vote Number:</div>
                            <div class="enhanced-pdf-value" id="viewVoteNumber"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Job Description:</div>
                            <div class="enhanced-pdf-value" id="viewJobDescription"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Requested Amount:</div>
                            <div class="enhanced-pdf-value" id="viewRequestedAmount"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approved Amount:</div>
                            <div class="enhanced-pdf-value" id="viewApprovedAmount"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Priority Level:</div>
                            <div class="enhanced-pdf-value" id="viewPriority"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Required Date:</div>
                            <div class="enhanced-pdf-value" id="viewRequiredDate"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Additional Notes:</div>
                            <div class="enhanced-pdf-value" id="viewAdditionalNotes"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Status:</div>
                            <div class="enhanced-pdf-value" id="viewStatus"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approving Authority:</div>
                            <div class="enhanced-pdf-value" id="viewApprovingAuthority"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approval Notes:</div>
                            <div class="enhanced-pdf-value" id="viewApprovalNotes"></div>
                        </div>
                    </div>
                    <div class="signature-section">
                        <div class="signature-line"></div>
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="signature-label">Approval Signature:</div>
                                <div class="signature-name">H.M.N Dinipriya Herath</div>
                                <div class="signature-title">Deputy Director General (Logistics)</div>
                                <div class="signature-title">For Secretary</div>
                            </div>
                            <div>
                                <div class="signature-label">Approval Signature:</div>
                                <div class="signature-name">Director Building Branch</div>
                                <div class="signature-title">Director Building Branch (Administration)</div>
                            </div>
                        </div>
                        <div class="mt-20">
                            <div class="signature-label">Copies:</div>
                            <div class="signature-title">1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)</div>
                            <div class="signature-title">2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeView" class="btn">Close</button>
                <button id="downloadFinalPdf" class="btn btn-secondary">Download PDF</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reject Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="rejectionPassword">Request Password *</label>
                    <input type="password" id="rejectionPassword" class="form-control" placeholder="Enter request password for verification" required>
                    <small class="form-text">Enter the unique password provided for this request</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Request Details:</label>
                    <div id="rejectionRequestDetails" class="enhanced-pdf-section">
                        <div><strong>Reference:</strong> <span id="rejectionRefNumber"></span></div>
                        <div><strong>Hospital:</strong> <span id="rejectionHospital"></span></div>
                        <div><strong>Vote Number:</strong> <span id="rejectionVoteNumber"></span></div>
                        <div><strong>Requested Amount:</strong> <span id="rejectionRequestedAmount"></span></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="rejectionReason">Rejection Reason *</label>
                    <textarea id="rejectionReason" class="form-control" rows="4" placeholder="Provide detailed reason for rejection..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelRejection" class="btn btn-secondary">Cancel</button>
                <button id="confirmRejection" class="btn btn-danger">Reject Request</button>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminPasswordModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Authentication Required</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="adminPassword">Admin Password *</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" required>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAdminPassword" class="btn btn-danger">Cancel</button>
                <button id="confirmAdminPassword" class="btn">Authenticate</button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbytS1JHS5rsQf3Oc9EVnjunOZjCJF2l4TYvAdPcv_j2yOHwg82jkNC5i2tRIaaNNG1o/exec';

        // Global variables
        let currentUserRole = 'hospital';
        let currentUserId = null;
        let currentRequestId = null;
        let currentRequestRef = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let allAllocations = [];
        let filteredAllocations = [];
        let systemLogs = [];

        // Admin password
        const ADMIN_PASSWORD = "ADS005";

        // Pending action variables
        let pendingAction = null;
        let pendingRequestId = null;

        // Pagination variables
        let myRequestsPage = 1;
        let myRequestsItemsPerPage = 10;
        let filteredMyRequests = [];

        let logsPage = 1;
        let logsItemsPerPage = 15;
        let filteredLogs = [];

        // Hospital accounts
        const hospitalAccounts = {
            'Ministry of Health': { password: 'moh123' },
            'National Hospital Sri Lanka': { password: 'nhsl123' },
            'Colombo South Teaching Hospital': { password: 'csth123' },
            'Lady Ridgeway Hospital': { password: 'lrh123' },
            'Apeksha Hospital Maharagama': { password: 'ahm123' },
            'Colombo East Base Hospital Mulleriyawa': { password: 'cebhm123' },
            'Infections Diseases Hospital': { password: 'idh123' },
            'NIMH': { password: 'nimh123' },
            'De Soysa Hospital': { password: 'dsh123' },
            'Castle Street Hospital for Women': { password: 'csshw123' },
            'National Eye Hospital': { password: 'neh123' },
            'Institute of Oral Health-Maharagama': { password: 'iohm123' },
            'National Blood Transfusion Service': { password: 'nbts123' },
            'National Institute for Nephrology Dialysis and Transplantation - Maligawatta': { password: 'nindtm123' },
            'Medical Research Institute': { password: 'mri123' },
            'National Dental Hospital': { password: 'ndh123' },
            'Colombo North Teaching Hospital - Ragama': { password: 'cnthr123' },
            'Rheumatology & Rehabilitation Hospital, Ragama': { password: 'rrhr123' },
            'District Hospital Kandana': { password: 'dhk123' },
            'National Hospital for Respiratory Diseases, Welisara': { password: 'nhrdw123' },
            'Leprosy Hospital - Handala': { password: 'lhh123' },
            'DGH Negombo (District General Hospital)': { password: 'dghn123' },
            'Teaching Hospital Kalutara': { password: 'thk123' },
            'National Institute of Health Sciences Kalutara': { password: 'nihsk123' },
            'National Hospital - Kandy': { password: 'nhk123' },
            'Base Hospital Gampola': { password: 'bhg123' },
            'Teaching Hospital Peradeniya': { password: 'thp123' },
            'Sirimavo Bandaranayake Hospital - Peradeniya': { password: 'sbhp123' },
            'District General Hospital Nawalapitiya': { password: 'dghn123' },
            'District General Hospital NuwaraEliya': { password: 'dghne123' },
            'District General Hospital Matale': { password: 'dghm123' },
            'National Hospital - Galle (Karapitiya)': { password: 'nhg123' },
            'German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)': { password: 'gslfhwg123' },
            'District General Hospital Matara': { password: 'dghm123' },
            'District General Hospital Hambantota': { password: 'dghh123' },
            'TH Jaffna': { password: 'thj123' },
            'Base Hospital Akkaraipattu': { password: 'bha123' },
            'Ashroff Hospital - Kalmunai': { password: 'ahk123' },
            'Base Hospital Kalmunai North': { password: 'bhkn123' },
            'District General Hospital Ampara': { password: 'dgha123' },
            'Base Hospital Pottuvil': { password: 'bhp123' },
            'District General Hospital Trincomalee': { password: 'dght123' },
            'District General Hospital Kantale': { password: 'dghk123' },
            'Teaching Hospital Batticaloa': { password: 'thb123' },
            'District General Hospital Chilaw': { password: 'dghc123' },
            'Teaching Hospital Kurunegala': { password: 'thk123' },
            'Teaching Hospital Kuliyapitiya': { password: 'thk123' },
            'District General Hospital Polonnaruwa': { password: 'dghp123' },
            'China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)': { password: 'cslfnshp123' },
            'TH Anuradhapura': { password: 'tha123' },
            'TH Badulla': { password: 'thb123' },
            'District General Hospital Monaragala': { password: 'dghm123' },
            'District General Hospital Kegalle': { password: 'dghk123' },
            'Teaching Hospital Ratnapura': { password: 'thr123' },
            'District General Hospital Embilipitiya': { password: 'dghe123' },
            'National STD/AIDS Control Programme': { password: 'nsacp123' },
            'Biomedical Engineering Services': { password: 'bes123' },
            'Epidemiology Unit': { password: 'eu123' },
            'National Cancer Control Programme': { password: 'nccp123' },
            'National Programme for Tuberculosis Control & Chest Diseases': { password: 'nptccd123' },
            'Institute for Forensic Medicine & Toxicology': { password: 'ifmt123' },
            'Health Promotion Bureau': { password: 'hpb123' },
            'Dengue Control Programme': { password: 'dcp123' },
            'Anti Malaria Campaign': { password: 'amc123' },
            'Family Health Bureau': { password: 'fhb123' },
            'Anti Filariasis Campaign': { password: 'afc123' },
            'Medical Supplies Division': { password: 'msd123' },
            'Public Health Veterinary Services': { password: 'phvs123' }
        };

        // Admin accounts
        const adminAccounts = {
            'ddg_logistics': { name: 'Deputy Director General (Logistics)', password: 'ddg123' },
            'director_building': { name: 'Director Building (Administration)', password: 'dba123' }
        };

        // Initialize localStorage if not exists
        function initializeLocalStorage() {
            if (!localStorage.getItem('allocations')) {
                localStorage.setItem('allocations', JSON.stringify([]));
            }
            if (!localStorage.getItem('systemLogs')) {
                localStorage.setItem('systemLogs', JSON.stringify([]));
            }
        }

        // Utility Functions
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        function showElement(element, show = true) {
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        function showMessage(message, type = 'error') {
            const loginMessage = document.getElementById('loginMessage');
            loginMessage.textContent = message;
            loginMessage.style.color = type === 'error' ? 'red' : 'green';
            showElement(loginMessage);
            setTimeout(() => showElement(loginMessage, false), 5000);
        }

        function generateUniquePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 6; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function formatCurrency(amount) {
            return 'LKR ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // System Logging Function
        function logSystemActivity(type, user, action, details = '') {
            const log = {
                timestamp: new Date().toISOString(),
                type: type,
                user: user,
                action: action,
                details: details
            };
            
            const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
            logs.unshift(log);
            if (logs.length > 1000) logs.pop();
            localStorage.setItem('systemLogs', JSON.stringify(logs));
            
            systemLogs = logs;
            
            const logsTab = document.getElementById('logsTab');
            if (logsTab && !logsTab.classList.contains('hidden')) {
                filterLogs();
            }
        }

        // Update pending allocation notification
        function updatePendingAllocationNotification() {
            const pendingAllocationBadge = document.getElementById('pendingAllocationBadge');
            const pendingCount = allAllocations.filter(allocation => allocation.status === 'Pending').length;
            if (pendingCount > 0) {
                pendingAllocationBadge.textContent = pendingCount;
                showElement(pendingAllocationBadge);
            } else {
                showElement(pendingAllocationBadge, false);
            }
        }

        // Admin password authentication
        function authenticateAdmin(action, requestId = null) {
            pendingAction = action;
            pendingRequestId = requestId;
            document.getElementById('adminPassword').value = '';
            showElement(document.getElementById('adminPasswordModal'));
        }

        function executePendingAction() {
            if (pendingAction === 'edit') {
                openEditModal(pendingRequestId);
            } else if (pendingAction === 'delete') {
                deleteAllocation(pendingRequestId);
            }
            
            // Reset pending action
            pendingAction = null;
            pendingRequestId = null;
        }

        // API Functions
        async function callGoogleAppsScript(action, data = {}) {
            try {
                const formData = new URLSearchParams();
                formData.append('action', action);
                
                for (const [key, value] of Object.entries(data)) {
                    formData.append(key, value);
                }

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                return getMockData(action, data);
            }
        }

        // Enhanced Mock Data
        function getMockData(action, data) {
            switch(action) {
                case 'login':
                    if (data.role === 'admin' && data.password === 'ADS005') {
                        logSystemActivity('system', 'Administrator', 'Login', 'Main admin login successful');
                        return { success: true, message: 'Login successful', role: 'mainadmin' };
                    }
                    if (data.role === 'admin' && data.userId && adminAccounts[data.userId] && data.password === adminAccounts[data.userId].password) {
                        logSystemActivity('system', 'Admin', 'Login', `Admin ${data.userId} login successful`);
                        return { success: true, message: 'Login successful', userName: adminAccounts[data.userId].name, userId: data.userId };
                    }
                    if (data.role === 'hospital' && data.hospitalId && hospitalAccounts[data.hospitalId] && data.password === hospitalAccounts[data.hospitalId].password) {
                        logSystemActivity('system', 'Hospital', 'Login', `Hospital ${data.hospitalId} login successful`);
                        return { success: true, message: 'Login successful', hospitalName: data.hospitalId, hospitalId: data.hospitalId };
                    }
                    return { success: false, error: 'Invalid credentials' };
                
                case 'submitAllocation':
                    const refNumber = 'ADS-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
                    const uniquePassword = generateUniquePassword();
                    
                    const allocation = {
                        id: Date.now(),
                        refnumber: refNumber,
                        hospitalname: data.hospitalName,
                        contactperson: data.contactPerson,
                        contactphone: data.contactPhone,
                        contactemail: data.contactEmail,
                        votenumber: data.voteNumber,
                        jobdescription: data.jobDescription,
                        requiredamount: data.requiredAmount,
                        approvedamount: 0,
                        prioritylevel: data.priorityLevel,
                        requireddate: data.requiredDate,
                        additionalnotes: data.additionalNotes || '',
                        status: 'Pending',
                        approvingauthority: '',
                        approvalnotes: '',
                        rejectionreason: '',
                        timestamp: new Date().toISOString(),
                        uniquepassword: uniquePassword,
                        hospitalId: data.hospitalId
                    };
                    
                    let allocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    allocations.push(allocation);
                    localStorage.setItem('allocations', JSON.stringify(allocations));
                    
                    logSystemActivity('allocation', data.hospitalName, 'Allocation Submitted', `Ref: ${refNumber}`);
                    
                    return {
                        success: true,
                        message: 'Allocation request submitted successfully',
                        requestId: allocation.id,
                        refNumber: refNumber,
                        uniquePassword: uniquePassword
                    };
                
                case 'getAllocations':
                    const storedAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    return { allocations: storedAllocations };
                
                case 'approveAllocation':
                    let allAllocationsData = JSON.parse(localStorage.getItem('allocations') || '[]');
                    
                    const allocationIndex = allAllocationsData.findIndex(a => a.id == data.requestId);
                    
                    if (allocationIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    const storedPassword = allAllocationsData[allocationIndex].uniquepassword;
                    const enteredPassword = data.uniquePassword;
                    
                    if (!storedPassword || !enteredPassword) {
                        return { success: false, error: 'Password is required' };
                    }
                    
                    if (storedPassword.toUpperCase() !== enteredPassword.toUpperCase()) {
                        return { success: false, error: 'Invalid request password. Please check and try again.' };
                    }
                    
                    allAllocationsData[allocationIndex].approvedamount = data.approvedAmount;
                    allAllocationsData[allocationIndex].approvingauthority = data.approvingAuthority;
                    allAllocationsData[allocationIndex].approvalnotes = data.approvalNotes || '';
                    allAllocationsData[allocationIndex].status = 'Approved';
                    
                    localStorage.setItem('allocations', JSON.stringify(allAllocationsData));
                    
                    logSystemActivity('approval', 'Administrator', 'Allocation Approved', 
                        `Request: ${allAllocationsData[allocationIndex].refnumber}, Amount: ${data.approvedAmount}, Authority: ${data.approvingAuthority}`);
                    
                    return { success: true, message: 'Allocation approved successfully' };
                
                case 'rejectAllocation':
                    let rejectAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    
                    const rejectIndex = rejectAllocations.findIndex(a => a.id == data.requestId);
                    
                    if (rejectIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    const storedRejectPassword = rejectAllocations[rejectIndex].uniquepassword;
                    const enteredRejectPassword = data.uniquePassword;
                    
                    if (!storedRejectPassword || !enteredRejectPassword) {
                        return { success: false, error: 'Password is required' };
                    }
                    
                    if (storedRejectPassword.toUpperCase() !== enteredRejectPassword.toUpperCase()) {
                        return { success: false, error: 'Invalid request password. Please check and try again.' };
                    }
                    
                    rejectAllocations[rejectIndex].rejectionreason = data.rejectionReason;
                    rejectAllocations[rejectIndex].status = 'Rejected';
                    
                    localStorage.setItem('allocations', JSON.stringify(rejectAllocations));
                    
                    logSystemActivity('rejection', 'Administrator', 'Allocation Rejected', 
                        `Request: ${rejectAllocations[rejectIndex].refnumber}, Reason: ${data.rejectionReason}`);
                    
                    return { success: true, message: 'Allocation rejected successfully' };
                
                case 'editAllocation':
                    let editAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    const editIndex = editAllocations.findIndex(a => a.id == data.requestId);
                    
                    if (editIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    editAllocations[editIndex].hospitalname = data.hospitalName;
                    editAllocations[editIndex].contactperson = data.contactPerson;
                    editAllocations[editIndex].contactphone = data.contactPhone;
                    editAllocations[editIndex].contactemail = data.contactEmail;
                    editAllocations[editIndex].votenumber = data.voteNumber;
                    editAllocations[editIndex].jobdescription = data.jobDescription;
                    editAllocations[editIndex].requiredamount = data.requiredAmount;
                    editAllocations[editIndex].prioritylevel = data.priorityLevel;
                    editAllocations[editIndex].requireddate = data.requiredDate;
                    editAllocations[editIndex].additionalnotes = data.additionalNotes || '';
                    
                    localStorage.setItem('allocations', JSON.stringify(editAllocations));
                    
                    logSystemActivity('allocation', 'Administrator', 'Allocation Updated', `Ref: ${editAllocations[editIndex].refnumber}`);
                    
                    return { success: true, message: 'Allocation updated successfully' };
                
                case 'deleteAllocation':
                    let deleteAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    const deleteIndex = deleteAllocations.findIndex(a => a.id == data.requestId);
                    
                    if (deleteIndex === -1) {
                        return { success: false, error: 'Allocation not found' };
                    }
                    
                    const deletedRef = deleteAllocations[deleteIndex].refnumber;
                    deleteAllocations.splice(deleteIndex, 1);
                    localStorage.setItem('allocations', JSON.stringify(deleteAllocations));
                    
                    logSystemActivity('allocation', 'Administrator', 'Allocation Deleted', `Ref: ${deletedRef}`);
                    
                    return { success: true, message: 'Allocation deleted successfully' };
                
                case 'getReports':
                    const reportAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
                    
                    let filteredData = reportAllocations;
                    
                    if (data.startDate && data.endDate) {
                        const startTimestamp = new Date(data.startDate).getTime();
                        const endTimestamp = new Date(data.endDate).getTime() + 86400000;
                        
                        filteredData = reportAllocations.filter(allocation => {
                            const allocationTime = new Date(allocation.timestamp).getTime();
                            return allocationTime >= startTimestamp && allocationTime < endTimestamp;
                        });
                    }
                    
                    // Filter by hospital if specified
                    if (data.hospital && data.hospital !== 'all') {
                        filteredData = filteredData.filter(allocation => allocation.hospitalname === data.hospital);
                    }
                    
                    let reportData = [];
                    let title = '';
                    
                    switch(data.type) {
                        case 'allocations':
                            title = 'Allocation Summary Report';
                            reportData = [['Request Ref', 'Hospital', 'Vote Number', 'Job Description', 'Requested Amount', 'Approved Amount', 'Status', 'Date']];
                            filteredData.forEach(allocation => {
                                reportData.push([
                                    allocation.refnumber,
                                    allocation.hospitalname,
                                    allocation.votenumber,
                                    allocation.jobdescription.substring(0, 50) + (allocation.jobdescription.length > 50 ? '...' : ''),
                                    formatCurrency(allocation.requiredamount),
                                    allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved',
                                    allocation.status,
                                    formatDate(allocation.timestamp)
                                ]);
                            });
                            break;
                            
                        case 'hospitals':
                            title = 'Hospital-wise Summary Report';
                            const hospitalData = {};
                            
                            filteredData.forEach(allocation => {
                                if (!hospitalData[allocation.hospitalname]) {
                                    hospitalData[allocation.hospitalname] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                                }
                                hospitalData[allocation.hospitalname].total++;
                                hospitalData[allocation.hospitalname][allocation.status.toLowerCase()]++;
                                hospitalData[allocation.hospitalname].totalRequested += parseFloat(allocation.requiredamount);
                                if (allocation.approvedamount > 0) {
                                    hospitalData[allocation.hospitalname].totalApproved += parseFloat(allocation.approvedamount);
                                }
                            });
                            
                            reportData = [['Hospital', 'Total Requests', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                            Object.keys(hospitalData).forEach(hospital => {
                                const data = hospitalData[hospital];
                                reportData.push([
                                    hospital,
                                    data.total.toString(),
                                    data.pending.toString(),
                                    data.approved.toString(),
                                    data.rejected.toString(),
                                    formatCurrency(data.totalRequested),
                                    formatCurrency(data.totalApproved)
                                ]);
                            });
                            break;
                            
                        case 'votes':
                            title = 'Vote-wise Summary Report';
                            const voteData = {};
                            
                            filteredData.forEach(allocation => {
                                if (!voteData[allocation.votenumber]) {
                                    voteData[allocation.votenumber] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                                }
                                voteData[allocation.votenumber].total++;
                                voteData[allocation.votenumber][allocation.status.toLowerCase()]++;
                                voteData[allocation.votenumber].totalRequested += parseFloat(allocation.requiredamount);
                                if (allocation.approvedamount > 0) {
                                    voteData[allocation.votenumber].totalApproved += parseFloat(allocation.approvedamount);
                                }
                            });
                            
                            reportData = [['Vote Number', 'Total Requests', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                            Object.keys(voteData).forEach(vote => {
                                const data = voteData[vote];
                                reportData.push([
                                    vote,
                                    data.total.toString(),
                                    data.pending.toString(),
                                    data.approved.toString(),
                                    data.rejected.toString(),
                                    formatCurrency(data.totalRequested),
                                    formatCurrency(data.totalApproved)
                                ]);
                            });
                            break;
                            
                        case 'monthly':
                            title = 'Monthly Summary Report';
                            const monthlyData = {};
                            
                            filteredData.forEach(allocation => {
                                const monthYear = new Date(allocation.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                                if (!monthlyData[monthYear]) {
                                    monthlyData[monthYear] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                                }
                                monthlyData[monthYear].total++;
                                monthlyData[monthYear][allocation.status.toLowerCase()]++;
                                monthlyData[monthYear].totalRequested += parseFloat(allocation.requiredamount);
                                if (allocation.approvedamount > 0) {
                                    monthlyData[monthYear].totalApproved += parseFloat(allocation.approvedamount);
                                }
                            });
                            
                            reportData = [['Month', 'Total', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                            Object.keys(monthlyData).forEach(month => {
                                const data = monthlyData[month];
                                reportData.push([
                                    month,
                                    data.total.toString(),
                                    data.pending.toString(),
                                    data.approved.toString(),
                                    data.rejected.toString(),
                                    formatCurrency(data.totalRequested),
                                    formatCurrency(data.totalApproved)
                                ]);
                            });
                            break;
                            
                        default:
                            return { success: false, error: 'Invalid report type' };
                    }
                    
                    return {
                        success: true,
                        title: title,
                        generatedAt: new Date().toISOString(),
                        reportData: reportData
                    };
                
                case 'getSystemLogs':
                    const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
                    return { logs: logs };
                
                default:
                    return { success: false, error: 'Unknown action' };
            }
        }

        // Authentication Functions
        async function handleLogin() {
            const hospitalSelect = document.getElementById('hospitalSelect');
            const passwordInput = document.getElementById('password');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginBtn = document.getElementById('loginBtn');
            
            const hospitalId = hospitalSelect.value;
            const password = passwordInput.value.trim();
            
            if (currentUserRole === 'hospital' && !hospitalId) {
                showMessage('Please select a hospital');
                return;
            }
            
            if (!password) {
                showMessage('Please enter a password');
                return;
            }

            showElement(loginSpinner);
            loginBtn.disabled = true;

            try {
                const result = await callGoogleAppsScript('login', {
                    role: currentUserRole,
                    hospitalId: hospitalId,
                    userId: hospitalId,
                    password: password
                });

                if (result.success) {
                    showElement(document.getElementById('loginScreen'), false);
                    if (currentUserRole === 'hospital') {
                        currentUserId = hospitalId;
                        showElement(document.getElementById('hospitalDashboard'));
                        document.getElementById('hospitalDisplayName').textContent = result.hospitalName || 'Hospital User';
                        resetAllocationForm();
                        loadMyRequests();
                        updateUserAllocationStatus();
                    } else {
                        showElement(document.getElementById('adminDashboard'));
                        document.getElementById('adminDisplayName').textContent = 
                            result.role === 'mainadmin' ? 'Main Administrator' : result.userName || 'Administrator';
                        loadAdminData();
                        loadSystemLogs();
                    }
                } else {
                    showMessage(result.error || 'Invalid password');
                }
            } catch (error) {
                showMessage('Login failed. Please try again.');
            } finally {
                showElement(loginSpinner, false);
                loginBtn.disabled = false;
            }
        }

        function logout() {
            logSystemActivity('system', currentUserRole === 'hospital' ? 'Hospital' : 'Administrator', 'Logout');
            showElement(document.getElementById('hospitalDashboard'), false);
            showElement(document.getElementById('adminDashboard'), false);
            showElement(document.getElementById('loginScreen'));
            document.getElementById('password').value = '';
            document.getElementById('hospitalSelect').value = '';
            showElement(document.getElementById('loginMessage'), false);
            currentUserId = null;
        }

        // Allocation Functions
        async function submitAllocation() {
            const requiredFields = ['hospitalName', 'contactPerson', 'contactPhone', 'voteNumber', 'jobDescription', 'requiredAmount', 'priorityLevel', 'requiredDate'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    alert(`Please fill in the ${field.previousElementSibling.textContent}`);
                    field.focus();
                    return;
                }
            }

            const requiredDate = new Date(document.getElementById('requiredDate').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (requiredDate < today) {
                alert('Required date cannot be in the past');
                return;
            }

            const allocationData = {
                hospitalName: document.getElementById('hospitalName').value.trim(),
                contactPerson: document.getElementById('contactPerson').value.trim(),
                contactPhone: document.getElementById('contactPhone').value.trim(),
                contactEmail: document.getElementById('contactEmail').value.trim(),
                voteNumber: document.getElementById('voteNumber').value,
                jobDescription: document.getElementById('jobDescription').value.trim(),
                requiredAmount: document.getElementById('requiredAmount').value,
                priorityLevel: document.getElementById('priorityLevel').value,
                requiredDate: document.getElementById('requiredDate').value,
                additionalNotes: document.getElementById('additionalNotes').value.trim(),
                hospitalId: currentUserId
            };

            const submitAllocationBtn = document.getElementById('submitAllocation');
            const submitSpinner = document.getElementById('submitSpinner');
            submitAllocationBtn.disabled = true;
            showElement(submitSpinner);

            try {
                const result = await callGoogleAppsScript('submitAllocation', allocationData);
                
                if (result.success) {
                    currentRequestId = result.requestId;
                    currentRequestRef = result.refNumber;
                    updateAllocationConfirmation(result, allocationData);
                    showElement(document.getElementById('allocationForm'), false);
                    showElement(document.getElementById('allocationSuccess'));
                    
                    if (document.getElementById('adminDashboard').style.display === 'block') {
                        loadAdminData();
                    }
                    
                    loadMyRequests();
                } else {
                    alert('Allocation submission failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Allocation submission failed. Please try again.');
            } finally {
                submitAllocationBtn.disabled = false;
                showElement(submitSpinner, false);
            }
        }

        function updateAllocationConfirmation(result, data) {
            document.getElementById('enhancedPdfRefNumber').textContent = result.refNumber;
            document.getElementById('enhancedPdfPassword').textContent = result.uniquePassword;
            document.getElementById('enhancedPdfDate').textContent = new Date().toLocaleDateString();
            document.getElementById('enhancedPdfHospitalDetails').textContent = 
                `${data.hospitalName}, ${data.contactPerson}, ${data.contactPhone}`;
            document.getElementById('enhancedPdfVoteNumber').textContent = data.voteNumber;
            document.getElementById('enhancedPdfJobDescription').textContent = data.jobDescription;
            document.getElementById('enhancedPdfAmount').textContent = formatCurrency(data.requiredAmount);
            document.getElementById('enhancedPdfPriority').textContent = data.priorityLevel;
            document.getElementById('enhancedPdfRequiredDate').textContent = formatDate(data.requiredDate);
            document.getElementById('enhancedPdfAdditionalNotes').textContent = 
                data.additionalNotes || 'No additional notes';
            document.getElementById('uniquePasswordDisplay').textContent = result.uniquePassword;
        }

        function resetAllocationForm() {
            const fields = ['hospitalName', 'contactPerson', 'contactPhone', 'contactEmail', 'voteNumber', 'jobDescription', 'requiredAmount', 'priorityLevel', 'requiredDate', 'additionalNotes'];
            fields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            showElement(document.getElementById('allocationForm'));
            showElement(document.getElementById('allocationSuccess'), false);
        }

        // Hospital My Requests Functions
        async function loadMyRequests() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
                filteredMyRequests = myAllocations;
                displayMyRequests();
                updateMyRequestsPagination();
            } catch (error) {
                console.error('Error loading my requests:', error);
            }
        }

        function filterMyRequests() {
            const status = document.getElementById('myRequestsStatusFilter').value;
            const searchTerm = document.getElementById('searchMyRequests').value.toLowerCase();
            
            let myAllocations = allAllocations.filter(allocation => allocation.hospitalId === currentUserId);
            
            filteredMyRequests = myAllocations.filter(allocation => {
                const statusMatch = status === 'all' || allocation.status === status;
                const searchMatch = !searchTerm || 
                    allocation.refnumber.toLowerCase().includes(searchTerm) ||
                    allocation.votenumber.toLowerCase().includes(searchTerm);
                
                return statusMatch && searchMatch;
            });
            
            myRequestsPage = 1;
            displayMyRequests();
            updateMyRequestsPagination();
        }

        function displayMyRequests() {
            const myRequestsTableBody = document.getElementById('myRequestsTableBody');
            const myRequestCount = document.getElementById('myRequestCount');
            myRequestsTableBody.innerHTML = '';
            
            if (filteredMyRequests.length === 0) {
                myRequestsTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No allocation requests found</td></tr>';
                myRequestCount.textContent = '0 requests';
                return;
            }

            const startIndex = (myRequestsPage - 1) * myRequestsItemsPerPage;
            const endIndex = Math.min(startIndex + myRequestsItemsPerPage, filteredMyRequests.length);
            const currentRequests = filteredMyRequests.slice(startIndex, endIndex);

            myRequestCount.textContent = `${filteredMyRequests.length} requests`;

            currentRequests.forEach(allocation => {
                const row = document.createElement('tr');
                if (allocation.status === 'Pending') {
                    row.classList.add('highlighted-row');
                }

                const statusClass = `status-${allocation.status.toLowerCase()}`;
                
                row.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.prioritylevel}</td>
                    <td><span class="status-badge ${statusClass}">${allocation.status}</span></td>
                    <td>
                        <button class="action-btn btn" onclick="viewMyAllocation(${allocation.id})">View</button>
                    </td>
                `;

                myRequestsTableBody.appendChild(row);
            });
        }

        function updateMyRequestsPagination() {
            const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
            document.getElementById('myRequestsPageInfo').textContent = `Page ${myRequestsPage} of ${totalPages}`;
            document.getElementById('myRequestsPrevPage').disabled = myRequestsPage === 1;
            document.getElementById('myRequestsNextPage').disabled = myRequestsPage === totalPages || totalPages === 0;
        }

        function goToMyRequestsPrevPage() {
            if (myRequestsPage > 1) {
                myRequestsPage--;
                displayMyRequests();
                updateMyRequestsPagination();
            }
        }

        function goToMyRequestsNextPage() {
            const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
            if (myRequestsPage < totalPages) {
                myRequestsPage++;
                displayMyRequests();
                updateMyRequestsPagination();
            }
        }

        function viewMyAllocation(requestId) {
            currentRequestId = requestId;
            
            // Use filteredMyRequests instead of allAllocations since we're in hospital view
            const allocation = filteredMyRequests.find(a => a.id == requestId);
            
            if (allocation) {
                document.getElementById('viewRefNumber').textContent = allocation.refnumber;
                document.getElementById('viewDate').textContent = formatDate(allocation.timestamp);
                document.getElementById('viewHospitalDetails').textContent = 
                    `${allocation.hospitalname}, ${allocation.contactperson}, ${allocation.contactphone}`;
                document.getElementById('viewVoteNumber').textContent = allocation.votenumber;
                document.getElementById('viewJobDescription').textContent = allocation.jobdescription;
                document.getElementById('viewRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
                document.getElementById('viewApprovedAmount').textContent = allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved';
                document.getElementById('viewPriority').textContent = allocation.prioritylevel;
                document.getElementById('viewRequiredDate').textContent = formatDate(allocation.requireddate);
                document.getElementById('viewAdditionalNotes').textContent = 
                    allocation.additionalnotes || 'No additional notes';
                document.getElementById('viewStatus').textContent = allocation.status;
                document.getElementById('viewApprovingAuthority').textContent = allocation.approvingauthority || 'Not specified';
                document.getElementById('viewApprovalNotes').textContent = allocation.approvalnotes || 'No approval notes';
                
                showElement(document.getElementById('viewModal'));
            } else {
                console.error('Allocation not found:', requestId);
                alert('Allocation details not found. Please try again.');
            }
        }

        // Hospital Allocation Status Functions
        async function updateUserAllocationStatus() {
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');
                const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
                
                const approved = myAllocations.filter(a => a.status === 'Approved').length;
                const pending = myAllocations.filter(a => a.status === 'Pending').length;
                const rejected = myAllocations.filter(a => a.status === 'Rejected').length;
                
                document.getElementById('userApprovedCount').textContent = approved;
                document.getElementById('userPendingCount').textContent = pending;
                document.getElementById('userRejectedCount').textContent = rejected;
                document.getElementById('userTotalAllocations').textContent = myAllocations.length;
                
                filterUserAllocations(myAllocations);
            } catch (error) {
                console.error('Error loading user allocation data:', error);
            }
        }

        function filterUserAllocations(myAllocations) {
            const searchTerm = document.getElementById('searchUserAllocations').value.toLowerCase();
            
            const filtered = myAllocations.filter(allocation => {
                const searchMatch = !searchTerm || 
                    allocation.refnumber.toLowerCase().includes(searchTerm) ||
                    allocation.votenumber.toLowerCase().includes(searchTerm) ||
                    allocation.jobdescription.toLowerCase().includes(searchTerm);
                
                return searchMatch;
            });
            
            displayUserAllocations(filtered);
        }

        function displayUserAllocations(allocations) {
            const userAllocationsList = document.getElementById('userAllocationsList');
            userAllocationsList.innerHTML = '';
            
            if (allocations.length === 0) {
                userAllocationsList.innerHTML = '<tr><td colspan="6" class="text-center">No allocations found</td></tr>';
                return;
            }

            allocations.forEach(allocation => {
                const tr = document.createElement('tr');
                const statusClass = `status-${allocation.status.toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.prioritylevel}</td>
                    <td><span class="status-badge ${statusClass}">${allocation.status}</span></td>
                `;
                userAllocationsList.appendChild(tr);
            });
        }

        // Admin Functions
        async function loadAdminData() {
            const adminSpinner = document.getElementById('adminSpinner');
            showElement(adminSpinner);
            
            try {
                const allocationsResult = await callGoogleAppsScript('getAllocations');

                allAllocations = allocationsResult.allocations || [];

                updateAdminStats();
                filterAllocations();
                updateAllocationStatus();
                updatePendingAllocationNotification();
                
                // Populate hospital filter in reports
                populateHospitalFilter();
            } catch (error) {
                console.error('Error loading admin data:', error);
                document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="8" class="text-center">Error loading data</td></tr>';
            } finally {
                showElement(adminSpinner, false);
            }
        }

        // Populate hospital filter in reports
        function populateHospitalFilter() {
            const hospitalFilter = document.getElementById('hospitalFilter');
            hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
            
            // Get unique hospital values
            const uniqueHospitals = [...new Set(allAllocations.map(allocation => allocation.hospitalname).filter(Boolean))];
            
            uniqueHospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital;
                option.textContent = hospital;
                hospitalFilter.appendChild(option);
            });
        }

        function updateAdminStats() {
            document.getElementById('totalAllocations').textContent = allAllocations.length;
            document.getElementById('pendingAllocations').textContent = allAllocations.filter(a => a.status === 'Pending').length;
            document.getElementById('approvedAllocations').textContent = allAllocations.filter(a => a.status === 'Approved').length;
            
            const totalAllocated = allAllocations
                .filter(a => a.status === 'Approved')
                .reduce((sum, allocation) => sum + parseFloat(allocation.approvedamount), 0);
            document.getElementById('totalAllocatedAmount').textContent = formatCurrency(totalAllocated);
        }

        function filterAllocations() {
            const status = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchAllocations').value.toLowerCase();
            
            filteredAllocations = allAllocations.filter(allocation => {
                const statusMatch = status === 'all' || allocation.status === status;
                const searchMatch = !searchTerm || 
                    allocation.refnumber.toLowerCase().includes(searchTerm) ||
                    allocation.hospitalname.toLowerCase().includes(searchTerm) ||
                    allocation.votenumber.toLowerCase().includes(searchTerm);
                
                return statusMatch && searchMatch;
            });
            
            currentPage = 1;
            displayAllocations();
            updatePagination();
            updateAdminStats();
        }

        function displayAllocations() {
            const requestsTableBody = document.getElementById('requestsTableBody');
            const requestCount = document.getElementById('requestCount');
            requestsTableBody.innerHTML = '';
            
            if (filteredAllocations.length === 0) {
                requestsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No allocation requests found</td></tr>';
                requestCount.textContent = '0 requests';
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredAllocations.length);
            const currentAllocations = filteredAllocations.slice(startIndex, endIndex);

            requestCount.textContent = `${filteredAllocations.length} requests`;

            currentAllocations.forEach(allocation => {
                const row = document.createElement('tr');
                if (allocation.status === 'Pending') {
                    row.classList.add('highlighted-row');
                }

                const statusClass = `status-${allocation.status.toLowerCase()}`;
                
                let actions = '';
                if (allocation.status === 'Pending') {
                    actions = `
                        <button class="action-btn btn" onclick="openApprovalModal(${allocation.id})">Approve</button>
                        <button class="action-btn btn btn-danger" onclick="openRejectionModal(${allocation.id})">Reject</button>
                        <button class="action-btn btn btn-secondary" onclick="authenticateAdmin('edit', ${allocation.id})">Edit</button>
                        <button class="action-btn btn btn-danger" onclick="authenticateAdmin('delete', ${allocation.id})">Delete</button>
                    `;
                } else {
                    actions = `
                        <button class="action-btn btn" onclick="viewAllocation(${allocation.id})">View</button>
                        <button class="action-btn btn btn-secondary" onclick="authenticateAdmin('edit', ${allocation.id})">Edit</button>
                    `;
                }

                row.innerHTML = `
                    <td>${allocation.refnumber}</td>
                    <td>${allocation.hospitalname}</td>
                    <td>${allocation.votenumber}</td>
                    <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(allocation.requiredamount)}</td>
                    <td>${allocation.prioritylevel}</td>
                    <td><span class="status-badge ${statusClass}">${allocation.status}</span></td>
                    <td>${actions}</td>
                `;

                requestsTableBody.appendChild(row);
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredAllocations.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        }

        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayAllocations();
                updatePagination();
            }
        }

        function goToNextPage() {
            const totalPages = Math.ceil(filteredAllocations.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayAllocations();
                updatePagination();
            }
        }

        // Modal Functions
        function openApprovalModal(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);

            if (allocation) {
                document.getElementById('approvalRefNumber').textContent = allocation.refnumber;
                document.getElementById('approvalHospital').textContent = allocation.hospitalname;
                document.getElementById('approvalVoteNumber').textContent = allocation.votenumber;
                document.getElementById('approvalJobDescription').textContent = allocation.jobdescription;
                document.getElementById('approvalRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
                document.getElementById('approvalPriority').textContent = allocation.prioritylevel;
                
                // Set default approved amount to requested amount
                document.getElementById('approvedAmount').value = allocation.requiredamount;
                document.getElementById('approvalNotes').value = '';
                document.getElementById('approvingAuthority').value = '';
                
                // AUTO-FILL THE PASSWORD HERE
                document.getElementById('uniquePassword').value = allocation.uniquepassword || '';

                showElement(document.getElementById('approvalModal'));
            }
        }

        function openRejectionModal(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);

            if (allocation) {
                document.getElementById('rejectionRefNumber').textContent = allocation.refnumber;
                document.getElementById('rejectionHospital').textContent = allocation.hospitalname;
                document.getElementById('rejectionVoteNumber').textContent = allocation.votenumber;
                document.getElementById('rejectionRequestedAmount').textContent = formatCurrency(allocation.requiredamount);

                // AUTO-FILL THE PASSWORD HERE
                document.getElementById('rejectionPassword').value = allocation.uniquepassword || '';

                // Reset rejection reason
                document.getElementById('rejectionReason').value = '';

                showElement(document.getElementById('rejectionModal'));
            }
        }

        async function approveAllocation() {
            const uniquePassword = document.getElementById('uniquePassword').value.trim();
            const approvedAmount = document.getElementById('approvedAmount').value.trim();
            const approvalNotes = document.getElementById('approvalNotes').value.trim();
            const approvingAuthority = document.getElementById('approvingAuthority').value;
            
            if (!uniquePassword) {
                alert('Please enter the request password');
                return;
            }
            
            if (!approvedAmount) {
                alert('Please enter the approved amount');
                return;
            }
            
            if (!approvingAuthority) {
                alert('Please select the approving authority');
                return;
            }
            
            const confirmApprovalBtn = document.getElementById('confirmApproval');
            confirmApprovalBtn.disabled = true;
            
            try {
                const result = await callGoogleAppsScript('approveAllocation', {
                    requestId: currentRequestId,
                    approvedAmount: approvedAmount,
                    approvalNotes: approvalNotes,
                    approvingAuthority: approvingAuthority,
                    uniquePassword: uniquePassword
                });
                
                if (result.success) {
                    alert('Allocation approved successfully');
                    hideModal('approvalModal');
                    loadAdminData();
                } else {
                    alert('Approval failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Approval failed. Please try again.');
            } finally {
                confirmApprovalBtn.disabled = false;
            }
        }

        async function rejectAllocation() {
            const uniquePassword = document.getElementById('rejectionPassword').value.trim();
            const rejectionReason = document.getElementById('rejectionReason').value.trim();

            if (!uniquePassword) {
                alert('Please enter the request password');
                return;
            }

            if (!rejectionReason) {
                alert('Please provide a rejection reason');
                return;
            }

            const confirmRejectionBtn = document.getElementById('confirmRejection');
            confirmRejectionBtn.disabled = true;

            try {
                const result = await callGoogleAppsScript('rejectAllocation', {
                    requestId: currentRequestId,
                    rejectionReason: rejectionReason,
                    uniquePassword: uniquePassword
                });

                if (result.success) {
                    alert('Allocation rejected successfully');
                    hideModal('rejectionModal');
                    loadAdminData();
                } else {
                    alert('Rejection failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Rejection failed. Please try again.');
            } finally {
                confirmRejectionBtn.disabled = false;
            }
        }

        function openEditModal(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);
            
            if (allocation) {
                document.getElementById('editHospitalName').value = allocation.hospitalname || '';
                document.getElementById('editContactPerson').value = allocation.contactperson || '';
                document.getElementById('editContactPhone').value = allocation.contactphone || '';
                document.getElementById('editContactEmail').value = allocation.contactemail || '';
                document.getElementById('editVoteNumber').value = allocation.votenumber || '';
                document.getElementById('editJobDescription').value = allocation.jobdescription || '';
                document.getElementById('editRequiredAmount').value = allocation.requiredamount || '';
                document.getElementById('editPriorityLevel').value = allocation.prioritylevel || '';
                document.getElementById('editRequiredDate').value = allocation.requireddate ? allocation.requireddate.substring(0, 10) : '';
                document.getElementById('editAdditionalNotes').value = allocation.additionalnotes || '';
                
                showElement(document.getElementById('editModal'));
            }
        }

        function viewAllocation(requestId) {
            currentRequestId = requestId;
            const allocation = allAllocations.find(a => a.id === requestId);
            
            if (allocation) {
                document.getElementById('viewRefNumber').textContent = allocation.refnumber;
                document.getElementById('viewDate').textContent = formatDate(allocation.timestamp);
                document.getElementById('viewHospitalDetails').textContent = 
                    `${allocation.hospitalname}, ${allocation.contactperson}, ${allocation.contactphone}`;
                document.getElementById('viewVoteNumber').textContent = allocation.votenumber;
                document.getElementById('viewJobDescription').textContent = allocation.jobdescription;
                document.getElementById('viewRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
                document.getElementById('viewApprovedAmount').textContent = allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved';
                document.getElementById('viewPriority').textContent = allocation.prioritylevel;
                document.getElementById('viewRequiredDate').textContent = formatDate(allocation.requireddate);
                document.getElementById('viewAdditionalNotes').textContent = 
                    allocation.additionalnotes || 'No additional notes';
                document.getElementById('viewStatus').textContent = allocation.status;
                document.getElementById('viewApprovingAuthority').textContent = allocation.approvingauthority || 'Not specified';
                document.getElementById('viewApprovalNotes').textContent = allocation.approvalnotes || 'No approval notes';
                
                showElement(document.getElementById('viewModal'));
            }
        }

        async function saveEdit() {
            const confirmEditBtn = document.getElementById('confirmEdit');
            confirmEditBtn.disabled = true;
            
            try {
                const result = await callGoogleAppsScript('editAllocation', {
                    requestId: currentRequestId,
                    hospitalName: document.getElementById('editHospitalName').value.trim(),
                    contactPerson: document.getElementById('editContactPerson').value.trim(),
                    contactPhone: document.getElementById('editContactPhone').value.trim(),
                    contactEmail: document.getElementById('editContactEmail').value.trim(),
                    voteNumber: document.getElementById('editVoteNumber').value,
                    jobDescription: document.getElementById('editJobDescription').value.trim(),
                    requiredAmount: document.getElementById('editRequiredAmount').value,
                    priorityLevel: document.getElementById('editPriorityLevel').value,
                    requiredDate: document.getElementById('editRequiredDate').value,
                    additionalNotes: document.getElementById('editAdditionalNotes').value.trim()
                });
                
                if (result.success) {
                    alert('Allocation updated successfully');
                    hideModal('editModal');
                    loadAdminData();
                } else {
                    alert('Update failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Update failed. Please try again.');
            } finally {
                confirmEditBtn.disabled = false;
            }
        }

        async function deleteAllocation(requestId) {
            if (!confirm('Are you sure you want to delete this allocation?')) {
                return;
            }
            
            try {
                const result = await callGoogleAppsScript('deleteAllocation', { requestId: requestId });
                
                if (result.success) {
                    alert('Allocation deleted successfully');
                    loadAdminData();
                } else {
                    alert('Delete failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Delete failed. Please try again.');
            }
        }

        function hideModal(modalId) {
            showElement(document.getElementById(modalId), false);
        }

        function updateAllocationStatus() {
            // Update counts
            const pendingCount = allAllocations.filter(a => a.status === 'Pending').length;
            const approvedCount = allAllocations.filter(a => a.status === 'Approved').length;
            const rejectedCount = allAllocations.filter(a => a.status === 'Rejected').length;
            
            document.getElementById('pendingAllocationsCount').textContent = pendingCount;
            document.getElementById('approvedAllocationsCount').textContent = approvedCount;
            document.getElementById('rejectedAllocationsCount').textContent = rejectedCount;
            
            // Update lists
            const pendingList = document.getElementById('pendingAllocationsList');
            const approvedList = document.getElementById('approvedAllocationsList');
            const rejectedList = document.getElementById('rejectedAllocationsList');
            
            pendingList.innerHTML = '';
            approvedList.innerHTML = '';
            rejectedList.innerHTML = '';
            
            // Populate lists
            allAllocations.forEach(allocation => {
                const div = document.createElement('div');
                div.className = 'selection-item';
                div.innerHTML = `
                    <div><strong>${allocation.refnumber}</strong> - ${allocation.hospitalname}</div>
                    <div style="color: #666; font-size: 0.9em;">${allocation.votenumber} - ${formatCurrency(allocation.requiredamount)}</div>
                `;
                
                if (allocation.status === 'Pending') {
                    pendingList.appendChild(div);
                } else if (allocation.status === 'Approved') {
                    approvedList.appendChild(div);
                } else if (allocation.status === 'Rejected') {
                    rejectedList.appendChild(div);
                }
            });
        }

        function searchAllocationsStatus() {
            const searchTerm = document.getElementById('searchAllocationsStatus').value.toLowerCase();
            
            const pendingAllocations = allAllocations.filter(a => 
                a.status === 'Pending' && (
                    a.hospitalname.toLowerCase().includes(searchTerm) ||
                    a.votenumber.toLowerCase().includes(searchTerm)
                )
            );
            
            const approvedAllocations = allAllocations.filter(a => 
                a.status === 'Approved' && (
                    a.hospitalname.toLowerCase().includes(searchTerm) ||
                    a.votenumber.toLowerCase().includes(searchTerm)
                )
            );
            
            const rejectedAllocations = allAllocations.filter(a => 
                a.status === 'Rejected' && (
                    a.hospitalname.toLowerCase().includes(searchTerm) ||
                    a.votenumber.toLowerCase().includes(searchTerm)
                )
            );
            
            displayAllocationList('pendingAllocationsList', pendingAllocations);
            displayAllocationList('approvedAllocationsList', approvedAllocations);
            displayAllocationList('rejectedAllocationsList', rejectedAllocations);
        }

        // Report Functions
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const hospital = document.getElementById('hospitalFilter').value;
            
            const reportResults = document.getElementById('reportResults');
            reportResults.innerHTML = '<div class="spinner"></div>';
            
            try {
                const result = await callGoogleAppsScript('getReports', {
                    reportType: reportType,
                    startDate: startDate,
                    endDate: endDate,
                    hospital: hospital
                });                
                
                if (result.success) {
                    displayReport(result);
                } else {
                    reportResults.innerHTML = `<div style="color: red;">Error: ${result.error || 'Failed to generate report'}</div>`;
                }
            } catch (error) {
                reportResults.innerHTML = `<div style="color: red;">Error generating report: ${error.message}</div>`;
            }
        }

        function displayReport(result) {
            const reportResults = document.getElementById('reportResults');
            
            let html = `
                <div class="enhanced-pdf">
                    <div class="enhanced-pdf-header">
                        <div class="enhanced-pdf-title">${result.title}</div>
                        <div class="enhanced-pdf-subtitle">Generated on ${formatDateTime(result.generatedAt)}</div>
                        <button id="downloadReport" class="btn" style="margin-top: 15px;">Download Report</button>
                    </div>
            `;
            
            if (result.reportData && result.reportData.length > 0) {
                html += '<div class="table-scroll-container"><table>';
                
                result.reportData.forEach((row, rowIndex) => {
                    const rowClass = rowIndex === 0 ? 'style="font-weight: bold; background-color: #f8f9fa;"' : '';
                    html += '<tr ' + rowClass + '>';
                    
                    row.forEach(cell => {
                        html += '<td>' + (cell || '') + '</td>';
                    });
                    
                    html += '</tr>';
                });
                
                html += '</table></div>';
            } else {
                html += '<p style="text-align: center; color: #999;">No data available for this report</p>';
            }
            
            html += '</div>';
            
            reportResults.innerHTML = html;
            
            // Add event listener for download button
            document.getElementById('downloadReport').addEventListener('click', function() {
                downloadReportAsCSV(result);
            });
        }

        // Download report as CSV
        function downloadReportAsCSV(reportData) {
            const csvContent = "data:text/csv;charset=utf-8," 
                + reportData.reportData.map(row => 
                    row.map(cell => `"${cell}"`).join(",")
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${reportData.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // System Logs Functions
        async function loadSystemLogs() {
            try {
                const result = await callGoogleAppsScript('getSystemLogs');
                systemLogs = result.logs || [];
                
                const userFilter = document.getElementById('userFilter');
                const uniqueUsers = [...new Set(systemLogs.map(log => log.user))];
                
                userFilter.innerHTML = '<option value="all">All Users</option>';
                uniqueUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userFilter.appendChild(option);
                });
                
                filterLogs();
            } catch (error) {
                console.error('Error loading system logs:', error);
            }
        }

        function filterLogs() {
            const typeFilter = document.getElementById('logTypeFilter').value;
            const userFilter = document.getElementById('userFilter').value;
            const searchTerm = document.getElementById('searchLogs').value.toLowerCase();
            
            filteredLogs = systemLogs.filter(log => {
                const typeMatch = typeFilter === 'all' || log.type === typeFilter;
                const userMatch = userFilter === 'all' || log.user === userFilter;
                const searchMatch = !searchTerm || 
                    log.user.toLowerCase().includes(searchTerm) ||
                    log.action.toLowerCase().includes(searchTerm) ||
                    log.details.toLowerCase().includes(searchTerm);
                
                return typeMatch && userMatch && searchMatch;
            });
            
            logsPage = 1;
            displayLogs();
            updateLogsPagination();
        }

        function displayLogs() {
            const systemLogsTable = document.getElementById('systemLogsTable');
            systemLogsTable.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                systemLogsTable.innerHTML = '<tr><td colspan="5" class="text-center">No logs found</td></tr>';
                return;
            }

            const startIndex = (logsPage - 1) * logsItemsPerPage;
            const endIndex = Math.min(startIndex + logsItemsPerPage, filteredLogs.length);
            const currentLogs = filteredLogs.slice(startIndex, endIndex);

            currentLogs.forEach(log => {
                const tr = document.createElement('tr');
                const typeClass = `status-${log.type.toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>${formatDateTime(log.timestamp)}</td>
                    <td><span class="status-badge ${typeClass}">${log.type}</span></td>
                    <td>${log.user}</td>
                    <td>${log.action}</td>
                    <td>${log.details}</td>
                `;
                systemLogsTable.appendChild(tr);
            });
        }

        function updateLogsPagination() {
            const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
            document.getElementById('logsPageInfo').textContent = `Page ${logsPage} of ${totalPages}`;
            document.getElementById('logsPrevPage').disabled = logsPage === 1;
            document.getElementById('logsNextPage').disabled = logsPage === totalPages || totalPages === 0;
        }

        function goToLogsPrevPage() {
            if (logsPage > 1) {
                logsPage--;
                displayLogs();
                updateLogsPagination();
            }
        }

        function goToLogsNextPage() {
            const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
            if (logsPage < totalPages) {
                logsPage++;
                displayLogs();
                updateLogsPagination();
            }
        }

        function exportLogs() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Timestamp,Type,User,Action,Details\n"
                + filteredLogs.map(log => 
                    `"${formatDateTime(log.timestamp)}","${log.type}","${log.user}","${log.action}","${log.details}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "system_logs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // PDF Generation Functions
        function generatePDF(isFinal = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.setTextColor(26, 115, 232);
            doc.setFont(undefined, 'bold');
            doc.text('MINISTRY OF HEALTH', 105, 15, { align: 'center' });
            
            doc.setFontSize(13);
            doc.setTextColor(95, 99, 104);
            doc.text('Allocation Distribution System', 105, 22, { align: 'center' });
            
            doc.setDrawColor(26, 115, 232);
            doc.line(20, 27, 190, 27);
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(isFinal ? 'ALLOCATION APPROVAL CONFIRMATION' : 'ALLOCATION REQUEST', 105, 35, { align: 'center' });
            
            if (isFinal) {
                const allocation = allAllocations.find(a => a.id === currentRequestId);
                if (allocation) {
                    addFormalAllocationContentToPDF(doc, allocation, true);
                }
            } else {
                addFormalPreviewContentToPDF(doc);
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Official Document - Ministry of Health Allocation Distribution System', 105, 287, { align: 'center' });
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 291, { align: 'center' });
            
            const fileName = isFinal ? 
                `allocation_approval_${currentRequestRef}.pdf` : 
                `allocation_request_${currentRequestRef}.pdf`;
            
            doc.save(fileName);
            
            logSystemActivity('system', currentUserRole, 'PDF Downloaded', 
                isFinal ? `Final approval for ${currentRequestRef}` : `Request preview for ${currentRequestRef}`);
        }

        function addFormalPreviewContentToPDF(doc) {
            let yPosition = 42;
            
            // Get data from the displayed preview elements
            const refNumber = document.getElementById('enhancedPdfRefNumber').textContent;
            const uniquePassword = document.getElementById('enhancedPdfPassword').textContent;
            const submissionDate = document.getElementById('enhancedPdfDate').textContent;
            const hospitalDetails = document.getElementById('enhancedPdfHospitalDetails').textContent;
            const voteNumber = document.getElementById('enhancedPdfVoteNumber').textContent;
            const jobDescription = document.getElementById('enhancedPdfJobDescription').textContent;
            const amount = document.getElementById('enhancedPdfAmount').textContent;
            const priority = document.getElementById('enhancedPdfPriority').textContent;
            const requiredDate = document.getElementById('enhancedPdfRequiredDate').textContent;
            const additionalNotes = document.getElementById('enhancedPdfAdditionalNotes').textContent;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Request Reference: ${refNumber}`, 20, yPosition);
            doc.text(`Date: ${submissionDate}`, 130, yPosition);
            
            yPosition += 10;
            
            // Hospital Details Section
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('HOSPITAL DETAILS', 20, yPosition);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            yPosition += 6;
            
            // Parse hospital details
            const hospitalParts = hospitalDetails.split(', ');
            const hospitalName = hospitalParts[0] || '';
            const contactPerson = hospitalParts[1] || '';
            const contactPhone = hospitalParts[2] || '';
            
            doc.text(`Hospital: ${hospitalName}`, 22, yPosition);
            yPosition += 5;
            doc.text(`Contact Person: ${contactPerson}`, 22, yPosition);
            yPosition += 5;
            doc.text(`Contact Phone: ${contactPhone}`, 22, yPosition);
            
            yPosition += 10;
            
            // Allocation Details Section
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('ALLOCATION DETAILS', 20, yPosition);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            yPosition += 6;
            
            doc.text(`Vote Number: ${voteNumber}`, 22, yPosition);
            yPosition += 5;
            doc.text(`Required Amount: ${amount}`, 22, yPosition);
            yPosition += 5;
            doc.text(`Priority Level: ${priority}`, 22, yPosition);
            yPosition += 5;
            doc.text(`Required Date: ${requiredDate}`, 22, yPosition);
            yPosition += 5;
            
            // Job Description
            doc.text('Job Description:', 22, yPosition);
            yPosition += 5;
            const jobLines = doc.splitTextToSize(jobDescription, 170);
            doc.text(jobLines, 22, yPosition);
            yPosition += jobLines.length * 5;
            
            yPosition += 10;
            
            // Status Section
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('STATUS', 20, yPosition);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            yPosition += 6;
            doc.text('Pending Approval', 22, yPosition);
            
            yPosition += 10;
            
            // Important Notice
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('IMPORTANT INFORMATION', 20, yPosition);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            yPosition += 6;
            doc.text('Please save this document for future reference and inquiries.', 22, yPosition);
            yPosition += 5;
            doc.text(`Your unique request password: ${uniquePassword}`, 22, yPosition);
            
            yPosition += 12;
            
            // Two-column layout for signature and comments
            // Left side: Signature area
            doc.setDrawColor(0, 0, 0);
            doc.line(20, yPosition, 80, yPosition); // Signature line
            
            // Right side: Comments and notes
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.text('ADDITIONAL NOTES', 110, yPosition);
            
            yPosition += 5;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);
            
            // Split notes into manageable lines
            const noteLines = doc.splitTextToSize(additionalNotes, 85);
            doc.text(noteLines, 110, yPosition);
            
            // Now, the signature text below the line (left side)
            yPosition += noteLines.length * 4;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8);
            doc.text('Approval Signature', 20, yPosition);
            
            yPosition += 4;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);
            doc.text('DDG Logistics / Director Building Admin', 20, yPosition);
        }

        function addFormalAllocationContentToPDF(doc, allocation, isFinal = false) {
            let y = 40;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            // Header
            doc.text(`Request Reference: ${allocation.refnumber}`, 20, y);
            doc.text(`Date: ${formatDate(allocation.timestamp)}`, 120, y);

            y += 12;

            // Hospital Details
            doc.setFont(undefined, 'bold');
            doc.text('HOSPITAL DETAILS', 20, y);

            y += 6;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);

            doc.text(`Hospital: ${allocation.hospitalname}`, 22, y); y += 4;
            doc.text(`Contact Person: ${allocation.contactperson}`, 22, y); y += 4;
            doc.text(`Contact Phone: ${allocation.contactphone}`, 22, y); y += 4;
            if (allocation.contactemail) {
                doc.text(`Contact Email: ${allocation.contactemail}`, 22, y); y += 4;
            }

            y += 10;

            // Allocation Details
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('ALLOCATION DETAILS', 20, y);

            y += 6;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);

            doc.text(`Vote Number: ${allocation.votenumber}`, 22, y); y += 4;
            doc.text(`Requested Amount: ${formatCurrency(allocation.requiredamount)}`, 22, y); y += 4;
            
            if (allocation.approvedamount > 0) {
                doc.text(`Approved Amount: ${formatCurrency(allocation.approvedamount)}`, 22, y); y += 4;
            }
            
            doc.text(`Priority Level: ${allocation.prioritylevel}`, 22, y); y += 4;
            doc.text(`Required Date: ${formatDate(allocation.requireddate)}`, 22, y); y += 4;

            // Job Description
            doc.text('Job Description:', 22, y); y += 4;
            const jobLines = doc.splitTextToSize(allocation.jobdescription, 170);
            doc.text(jobLines, 22, y);
            y += jobLines.length * 4;

            y += 10;

            // Approval Details
            if (isFinal && allocation.status === 'Approved') {
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('APPROVAL DETAILS', 20, y);

                y += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);

                doc.text(`Approving Authority: ${allocation.approvingauthority}`, 22, y); y += 4;
                
                if (allocation.approvalnotes) {
                    doc.text('Approval Notes:', 22, y); y += 4;
                    const approvalLines = doc.splitTextToSize(allocation.approvalnotes, 170);
                    doc.text(approvalLines, 22, y);
                    y += approvalLines.length * 4;
                }
            }

            // Rejection Details
            if (isFinal && allocation.status === 'Rejected') {
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('REJECTION DETAILS', 20, y);

                y += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);

                doc.text('Rejection Reason:', 22, y); y += 4;
                const rejectionLines = doc.splitTextToSize(allocation.rejectionreason, 170);
                doc.text(rejectionLines, 22, y);
                y += rejectionLines.length * 4;
            }

            y += 10;

            // Add Important Instructions Section
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('IMPORTANT INSTRUCTIONS', 20, y);
            y += 6;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);

            const instructions = [
                "3. The following instructions should be followed when incurring these expenses:",
                "I. Action should be taken in accordance with the Government Financial Regulations (GFR), Establishment Code, GFR 135 on Delegation of Authority, other laws and regulations, and the relevant instructions of Budget Circular No. 01/2025 dated 22.03.2025, which authorizes expenditure for the year 2025 and pertains to public expenditure management.",
                "II. The relevant work subjects should be executed upon approval by your Hospital's Regional Procurement Committee, in accordance with this Ministry Circular and instructions.",
                "III. In order to prevent the Government as well as the contractors/service providers from facing difficulties due to the accumulation of unsettled liabilities, it is important to confirm the availability of cash flow before entering into commitments, even if the provision has been allocated.",
                "IV. Starting work without provisions should especially be avoided, and expenses exceeding the limit of the allocated provisions should not be incurred.",
                "V. The provisions granted through this letter will expire on 31.12.2026.",
                "4. Monthly expenditure reports, stating the work subjects for which the provisions were expended, must be submitted by the Accountant of the Hospitals/Institutions to the email address buildingbranch.b07@gmail.com. The Institutional Section must also complete the physical and financial progress for every month according to the provided format. Kindly note that both these reports must be submitted before the 10th day of the following month."
            ];

            instructions.forEach(instruction => {
                const lines = doc.splitTextToSize(instruction, 170);
                lines.forEach(line => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, 22, y);
                    y += 4;
                });
                y += 2;
            });

            y += 10;

            // Signature section with two signatures
            const signatureY = y;

            // Left signature - Deputy Director General
            doc.setDrawColor(0, 0, 0);
            doc.line(20, signatureY, 80, signatureY);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8);
            doc.text('H.M.N Dinipriya Herath', 20, signatureY + 5);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);
            doc.text('Deputy Director General (Logistics)', 20, signatureY + 9);
            doc.text('For Secretary', 20, signatureY + 13);

            // Right signature - Director Building Branch
            doc.line(110, signatureY, 170, signatureY);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8);
            doc.text('Director Building Branch', 110, signatureY + 5);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);
            doc.text('Director Building Branch (Administration)', 110, signatureY + 9);

            // Copy distribution note
            y = signatureY + 20;
            doc.setFont(undefined, 'italic');
            doc.setFontSize(7);
            doc.text('Copies:', 20, y);
            y += 4;
            doc.text('1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)', 22, y);
            y += 4;
            doc.text('2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)', 22, y);
        }

        function downloadFinalPDF() {
            generatePDF(true);
        }

        function downloadPreviewPDF() {
            generatePDF(false);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize localStorage
            initializeLocalStorage();
            
            // Role selection
            document.querySelectorAll('.role-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.role-option').forEach(el => el.classList.remove('active'));
                    this.classList.add('active');
                    currentUserRole = this.getAttribute('data-role');
                });
            });
            
            // Login button
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Logout buttons
            document.getElementById('hospitalLogout').addEventListener('click', logout);
            document.getElementById('adminLogout').addEventListener('click', logout);
            
            // Submit allocation
            document.getElementById('submitAllocation').addEventListener('click', submitAllocation);
            
            // New allocation
            document.getElementById('newAllocation').addEventListener('click', resetAllocationForm);
            
            // Download PDF
            document.getElementById('downloadPdf').addEventListener('click', downloadPreviewPDF);
            
            // Download final PDF
            document.getElementById('downloadFinalPdf').addEventListener('click', downloadFinalPDF);
            
            // Hospital tabs
            document.querySelectorAll('.user-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.user-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.user-tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    const tabId = this.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.remove('hidden');
                    
                    if (this.getAttribute('data-tab') === 'myRequests') {
                        loadMyRequests();
                    } else if (this.getAttribute('data-tab') === 'allocations') {
                        updateUserAllocationStatus();
                    }
                });
            });
            
            // My Requests filters
            document.getElementById('myRequestsStatusFilter').addEventListener('change', filterMyRequests);
            document.getElementById('searchMyRequests').addEventListener('input', filterMyRequests);
            
            // My Requests pagination
            document.getElementById('myRequestsPrevPage').addEventListener('click', goToMyRequestsPrevPage);
            document.getElementById('myRequestsNextPage').addEventListener('click', goToMyRequestsNextPage);
            
            // User allocation search
            document.getElementById('searchUserAllocations').addEventListener('input', function() {
                const allocationsResult = JSON.parse(localStorage.getItem('allocations') || '[]');
                const myAllocations = allocationsResult.filter(allocation => allocation.hospitalId === currentUserId) || [];
                filterUserAllocations(myAllocations);
            });
            
            // Admin tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    const tabId = this.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.remove('hidden');
                    
                    if (this.getAttribute('data-tab') === 'logs') {
                        loadSystemLogs();
                    } else if (this.getAttribute('data-tab') === 'allocations') {
                        updateAllocationStatus();
                    } else if (this.getAttribute('data-tab') === 'reports') {
                        populateHospitalFilter();
                    }
                });
            });
            
            // Allocation filters
            document.getElementById('statusFilter').addEventListener('change', filterAllocations);
            document.getElementById('searchAllocations').addEventListener('input', filterAllocations);
            
            // Allocation pagination
            document.getElementById('prevPage').addEventListener('click', goToPrevPage);
            document.getElementById('nextPage').addEventListener('click', goToNextPage);
            
            // Allocation status search
            document.getElementById('searchAllocationsStatus').addEventListener('input', searchAllocationsStatus);
            
            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    showElement(modal, false);
                });
            });
            
            // Cancel buttons
            document.getElementById('cancelEdit').addEventListener('click', function() {
                hideModal('editModal');
            });
            
            document.getElementById('closeView').addEventListener('click', function() {
                hideModal('viewModal');
            });
            
            document.getElementById('cancelRejection').addEventListener('click', function() {
                hideModal('rejectionModal');
            });
            
            document.getElementById('cancelAdminPassword').addEventListener('click', function() {
                hideModal('adminPasswordModal');
            });
            
            // Modal confirm buttons
            document.getElementById('confirmApproval').addEventListener('click', approveAllocation);
            document.getElementById('confirmEdit').addEventListener('click', saveEdit);
            document.getElementById('confirmRejection').addEventListener('click', rejectAllocation);
            
            // Reject request button in approval modal
            document.getElementById('rejectRequest').addEventListener('click', function() {
                hideModal('approvalModal');
                openRejectionModal(currentRequestId);
            });
            
            // Admin password confirmation
            document.getElementById('confirmAdminPassword').addEventListener('click', function() {
                const enteredPassword = document.getElementById('adminPassword').value.trim();
                
                if (enteredPassword === ADMIN_PASSWORD) {
                    hideModal('adminPasswordModal');
                    executePendingAction();
                } else {
                    alert('Invalid admin password. Please try again.');
                }
            });
            
            // Report generation
            document.getElementById('generateReport').addEventListener('click', generateReport);
            
            // Logs filters
            document.getElementById('logTypeFilter').addEventListener('change', filterLogs);
            document.getElementById('userFilter').addEventListener('change', filterLogs);
            document.getElementById('searchLogs').addEventListener('input', filterLogs);
            
            // Logs pagination
            document.getElementById('logsPrevPage').addEventListener('click', goToLogsPrevPage);
            document.getElementById('logsNextPage').addEventListener('click', goToLogsNextPage);
            
            // Logs buttons
            document.getElementById('refreshLogs').addEventListener('click', loadSystemLogs);
            document.getElementById('exportLogs').addEventListener('click', exportLogs);
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        showElement(this, false);
                    }
                });
            });
            
            // Enter key for login
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // Enter key for admin password
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirmAdminPassword').click();
                }
            });
        });
    </script>
</body>
</html>